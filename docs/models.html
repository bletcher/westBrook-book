<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Models | The West Brook Story</title>
  <meta name="description" content="This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA" />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Models | The West Brook Story" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/images/westBrook.jpg" />
  <meta property="og:description" content="This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA" />
  <meta name="github-repo" content="bletcher/westBrook-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Models | The West Brook Story" />
  
  <meta name="twitter:description" content="This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA" />
  <meta name="twitter:image" content="/images/westBrook.jpg" />

<meta name="author" content="Ben Letcher" />


<meta name="date" content="2022-08-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="getData.html"/>
<link rel="next" href="final-words.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#the-west-brook"><i class="fa fa-check"></i><b>1.1</b> The West Brook</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#setup"><i class="fa fa-check"></i><b>1.2</b> Setup</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="getData.html"><a href="getData.html"><i class="fa fa-check"></i><b>2</b> Get data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="getData.html"><a href="getData.html#getEnvData"><i class="fa fa-check"></i><b>2.1</b> Get environmental data</a></li>
<li class="chapter" data-level="2.2" data-path="getData.html"><a href="getData.html#dataElectro"><i class="fa fa-check"></i><b>2.2</b> Electrofishing data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="getData.html"><a href="getData.html#get-data"><i class="fa fa-check"></i><b>2.2.1</b> Get data</a></li>
<li class="chapter" data-level="2.2.2" data-path="getData.html"><a href="getData.html#wrangle-data"><i class="fa fa-check"></i><b>2.2.2</b> Wrangle data</a></li>
<li class="chapter" data-level="2.2.3" data-path="getData.html"><a href="getData.html#explore-data"><i class="fa fa-check"></i><b>2.2.3</b> Explore data</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="getData.html"><a href="getData.html#dataCMR"><i class="fa fa-check"></i><b>2.3</b> Capture-recapture data</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="getData.html"><a href="getData.html#temporary-home-for-updated-functions"><i class="fa fa-check"></i><b>2.3.1</b> Temporary home for updated functions</a></li>
<li class="chapter" data-level="2.3.2" data-path="getData.html"><a href="getData.html#get-data-1"><i class="fa fa-check"></i><b>2.3.2</b> Get data</a></li>
<li class="chapter" data-level="2.3.3" data-path="getData.html"><a href="getData.html#make-encounter-history-files"><i class="fa fa-check"></i><b>2.3.3</b> Make encounter history files</a></li>
<li class="chapter" data-level="2.3.4" data-path="getData.html"><a href="getData.html#wrangle-data-1"><i class="fa fa-check"></i><b>2.3.4</b> Wrangle data</a></li>
<li class="chapter" data-level="2.3.5" data-path="getData.html"><a href="getData.html#explore-data-1"><i class="fa fa-check"></i><b>2.3.5</b> Explore data</a></li>
<li class="chapter" data-level="2.3.6" data-path="getData.html"><a href="getData.html#section-transitions"><i class="fa fa-check"></i><b>2.3.6</b> Section transitions</a></li>
<li class="chapter" data-level="2.3.7" data-path="getData.html"><a href="getData.html#cmr-metadata"><i class="fa fa-check"></i><b>2.3.7</b> CMR metadata</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="getData.html"><a href="getData.html#dataWanding"><i class="fa fa-check"></i><b>2.4</b> Wanding data</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="getData.html"><a href="getData.html#get-data-2"><i class="fa fa-check"></i><b>2.4.1</b> Get data</a></li>
<li class="chapter" data-level="2.4.2" data-path="getData.html"><a href="getData.html#wrangle-data-2"><i class="fa fa-check"></i><b>2.4.2</b> Wrangle data</a></li>
<li class="chapter" data-level="2.4.3" data-path="getData.html"><a href="getData.html#explore-data-2"><i class="fa fa-check"></i><b>2.4.3</b> Explore data</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="getData.html"><a href="getData.html#dataAntenna"><i class="fa fa-check"></i><b>2.5</b> Antenna data</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="getData.html"><a href="getData.html#get-data-3"><i class="fa fa-check"></i><b>2.5.1</b> Get data</a></li>
<li class="chapter" data-level="2.5.2" data-path="getData.html"><a href="getData.html#prepare-data"><i class="fa fa-check"></i><b>2.5.2</b> Prepare data</a></li>
<li class="chapter" data-level="2.5.3" data-path="getData.html"><a href="getData.html#wrangle-data-3"><i class="fa fa-check"></i><b>2.5.3</b> Wrangle data</a></li>
<li class="chapter" data-level="2.5.4" data-path="getData.html"><a href="getData.html#explore-data-3"><i class="fa fa-check"></i><b>2.5.4</b> Explore data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="models.html"><a href="models.html"><i class="fa fa-check"></i><b>3</b> Models</a>
<ul>
<li class="chapter" data-level="3.1" data-path="models.html"><a href="models.html#modelYOY"><i class="fa fa-check"></i><b>3.1</b> Young-of-year size model</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="models.html"><a href="models.html#raw-data-for-yoy-model"><i class="fa fa-check"></i><b>3.1.1</b> Raw data for YOY model</a></li>
<li class="chapter" data-level="3.1.2" data-path="models.html"><a href="models.html#get-environmental-data"><i class="fa fa-check"></i><b>3.1.2</b> Get environmental data</a></li>
<li class="chapter" data-level="3.1.3" data-path="models.html"><a href="models.html#get-first-observations"><i class="fa fa-check"></i><b>3.1.3</b> Get first observations</a></li>
<li class="chapter" data-level="3.1.4" data-path="models.html"><a href="models.html#counts-of-captured-fish"><i class="fa fa-check"></i><b>3.1.4</b> Counts of captured fish</a></li>
<li class="chapter" data-level="3.1.5" data-path="models.html"><a href="models.html#raw-data-plots"><i class="fa fa-check"></i><b>3.1.5</b> Raw data plots</a></li>
<li class="chapter" data-level="3.1.6" data-path="models.html"><a href="models.html#models-based-on-yearly-means"><i class="fa fa-check"></i><b>3.1.6</b> Models based on yearly means</a></li>
<li class="chapter" data-level="3.1.7" data-path="models.html"><a href="models.html#models-with-extreme-flow-events-droughts"><i class="fa fa-check"></i><b>3.1.7</b> Models with extreme flow events (droughts)</a></li>
<li class="chapter" data-level="3.1.8" data-path="models.html"><a href="models.html#models-based-on-individual-observations"><i class="fa fa-check"></i><b>3.1.8</b> Models based on individual observations</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="models.html"><a href="models.html#modelFlow"><i class="fa fa-check"></i><b>3.2</b> Flow model</a></li>
<li class="chapter" data-level="3.3" data-path="models.html"><a href="models.html#modelCMR_Flow_River_OBear"><i class="fa fa-check"></i><b>3.3</b> Flow effects on survival (phi) models - O’Bear only</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="models.html"><a href="models.html#model-phi_p"><i class="fa fa-check"></i><b>3.3.1</b> Model phi_p</a></li>
<li class="chapter" data-level="3.3.2" data-path="models.html"><a href="models.html#model-phit_pt"><i class="fa fa-check"></i><b>3.3.2</b> Model phiT_pT</a></li>
<li class="chapter" data-level="3.3.3" data-path="models.html"><a href="models.html#model-phit_pt_cohort"><i class="fa fa-check"></i><b>3.3.3</b> Model phiT_pT_cohort</a></li>
<li class="chapter" data-level="3.3.4" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flow"><i class="fa fa-check"></i><b>3.3.4</b> Model phiT_pT_cohort_flow</a></li>
<li class="chapter" data-level="3.3.5" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flowcohort"><i class="fa fa-check"></i><b>3.3.5</b> Model phiT_pT_cohort_flowCohort</a></li>
<li class="chapter" data-level="3.3.6" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flowcohorthier"><i class="fa fa-check"></i><b>3.3.6</b> Model phiT_pT_cohort_flowCohortHier</a></li>
<li class="chapter" data-level="3.3.7" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flowcohorthiercjs"><i class="fa fa-check"></i><b>3.3.7</b> Model phiT_pT_cohort_flowCohortHierCJS</a></li>
<li class="chapter" data-level="3.3.8" data-path="models.html"><a href="models.html#model-phit_pt_cohort_flowcohorthierdhmm"><i class="fa fa-check"></i><b>3.3.8</b> Model phiT_pT_cohort_flowCohortHierDHMM</a></li>
<li class="chapter" data-level="3.3.9" data-path="models.html"><a href="models.html#compare-models"><i class="fa fa-check"></i><b>3.3.9</b> Compare models</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="models.html"><a href="models.html#modelCMR_Flow_4rivers"><i class="fa fa-check"></i><b>3.4</b> Flow effects on survival (phi) models</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="models.html"><a href="models.html#model-phit_pt_psit_dirch"><i class="fa fa-check"></i><b>3.4.1</b> Model phiT_pT_psiT_dirch</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="final-words.html"><a href="final-words.html"><i class="fa fa-check"></i><b>4</b> Final Words</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The West Brook Story</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="models" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Models<a href="models.html#models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>List of models will go here</p>

<div id="modelYOY" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Young-of-year size model<a href="models.html#modelYOY" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The question here is what is driving <em>body size variation</em> across years in brook trout and brown trout in the WB?</p>
<p>We focus on ageInSamples == 1 (age-0 fish in the fall sample) fish for growth model. This is the first sampling occasion that most fish are big enough to tag. Not all fish are big enough, however, and there is a number of untagged fish each year. We need to include both tagged and untagged fish in our age-0 size model.</p>
<p>Factors to include in the model are<br />
1. Sample date<br />
2. Cumulative temperature prior to sampling<br />
3. Cumulative flow prior to sampling<br />
4. Extreme flow events?? Floods, droughts?<br />
5. Fish density, age-0 counts across all three salmonids</p>
<div id="raw-data-for-yoy-model" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Raw data for YOY model<a href="models.html#raw-data-for-yoy-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Environmental data (flow, temperature) are from 1, 3, or 5 months prior to date of individual capture. Also can used fixed dates: assumed spawning dates, assumed emergence dates and actual observation (sample) dates.</li>
<li>All fish data are from age-0 in autumn.</li>
<li>Abundance data.</li>
</ol>
</div>
<div id="get-environmental-data" class="section level3 hasAnchor" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Get environmental data<a href="models.html#get-environmental-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>West Brook environmental data (flow and temperature)</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="models.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="at">file =</span> <span class="st">&#39;./data/envDataWB.RData&#39;</span>)</span></code></pre></div>
</div>
<div id="get-first-observations" class="section level3 hasAnchor" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Get first observations<a href="models.html#get-first-observations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<ol style="list-style-type: decimal">
<li>Filter cdWB_electro for first observations in the autumn for age-0 fish (ageInsamples == 1). Including both tagged and untagged fish.</li>
</ol>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="models.html#cb40-1" aria-hidden="true" tabindex="-1"></a>selectedVariables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;tag&quot;</span>, <span class="st">&quot;species&quot;</span>, <span class="st">&quot;river&quot;</span>, <span class="st">&quot;detectionDate&quot;</span>, <span class="st">&quot;sampleNumber&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="st">&quot;proportionSampled&quot;</span>, <span class="st">&quot;observedLength&quot;</span>, <span class="st">&quot;observedWeight&quot;</span>, <span class="st">&quot;area&quot;</span>, <span class="st">&quot;section&quot;</span>, <span class="st">&quot;season&quot;</span>, <span class="st">&quot;isYOY&quot;</span>)</span>
<span id="cb40-2"><a href="models.html#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="models.html#cb40-3" aria-hidden="true" tabindex="-1"></a>firstObs_noTag <span class="ot">&lt;-</span> cdWB_electro <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="models.html#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(tag), ageInSamples <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="models.html#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-6"><a href="models.html#cb40-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span> <span class="fu">select</span>(<span class="fu">all_of</span>(selectedVariables)) </span>
<span id="cb40-7"><a href="models.html#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="models.html#cb40-8" aria-hidden="true" tabindex="-1"></a>firstObs_tag <span class="ot">&lt;-</span> cdWB_electro <span class="sc">%&gt;%</span></span>
<span id="cb40-9"><a href="models.html#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tag) <span class="sc">%&gt;%</span></span>
<span id="cb40-10"><a href="models.html#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">isFirstObs =</span> detectionDate <span class="sc">==</span> <span class="fu">min</span>(detectionDate),</span>
<span id="cb40-11"><a href="models.html#cb40-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb40-12"><a href="models.html#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(isFirstObs, ageInSamples <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-13"><a href="models.html#cb40-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">all_of</span>(selectedVariables)) <span class="sc">%&gt;%</span></span>
<span id="cb40-14"><a href="models.html#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb40-15"><a href="models.html#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="models.html#cb40-16" aria-hidden="true" tabindex="-1"></a>firstObs0 <span class="ot">&lt;-</span> <span class="fu">add_row</span>(firstObs_tag, firstObs_noTag) <span class="sc">%&gt;%</span></span>
<span id="cb40-17"><a href="models.html#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as_date</span>(detectionDate),</span>
<span id="cb40-18"><a href="models.html#cb40-18" aria-hidden="true" tabindex="-1"></a>         <span class="at">yday =</span> <span class="fu">yday</span>(date),</span>
<span id="cb40-19"><a href="models.html#cb40-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date))</span></code></pre></div>
<p>For each date in firstObs0 that at least one fish was captured, calculate summary stats for flow and temperature for different time periods:<br />
1. Assumed spawning to capture<br />
2. Assumed spawning to assumed emergence<br />
3. Assumed emergence to capture<br />
4. One month preceding capture<br />
5. Three months preceding capture<br />
5. Five months preceding capture</p>
<p>Then merge results with firstObs0 to create firstObs.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="models.html#cb41-1" aria-hidden="true" tabindex="-1"></a>spawn_month <span class="ot">&lt;-</span> <span class="st">&quot;11&quot;</span> <span class="co"># spawning</span></span>
<span id="cb41-2"><a href="models.html#cb41-2" aria-hidden="true" tabindex="-1"></a>spawn_day <span class="ot">&lt;-</span> <span class="st">&quot;15&quot;</span></span>
<span id="cb41-3"><a href="models.html#cb41-3" aria-hidden="true" tabindex="-1"></a>emerge_month <span class="ot">&lt;-</span> <span class="st">&quot;03&quot;</span> <span class="co"># emergence</span></span>
<span id="cb41-4"><a href="models.html#cb41-4" aria-hidden="true" tabindex="-1"></a>emerge_day <span class="ot">&lt;-</span> <span class="st">&quot;01&quot;</span></span>
<span id="cb41-5"><a href="models.html#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="models.html#cb41-6" aria-hidden="true" tabindex="-1"></a>firstObsDates <span class="ot">&lt;-</span> firstObs0 <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(<span class="at">date =</span> <span class="fu">date</span>(detectionDate), river)</span>
<span id="cb41-7"><a href="models.html#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="models.html#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co"># move to getPrepareWBData</span></span>
<span id="cb41-9"><a href="models.html#cb41-9" aria-hidden="true" tabindex="-1"></a>getEnvMeans <span class="ot">&lt;-</span> <span class="cf">function</span>(riverIn, start, end) { </span>
<span id="cb41-10"><a href="models.html#cb41-10" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> envDataWB <span class="sc">%&gt;%</span> </span>
<span id="cb41-11"><a href="models.html#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(river <span class="sc">==</span> riverIn, dateDate <span class="sc">&gt;=</span> start, dateDate <span class="sc">&lt;=</span> end) <span class="sc">%&gt;%</span></span>
<span id="cb41-12"><a href="models.html#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb41-13"><a href="models.html#cb41-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sumT =</span> <span class="fu">sum</span>(temperature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-14"><a href="models.html#cb41-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">meanT =</span> <span class="fu">mean</span>(temperature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-15"><a href="models.html#cb41-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">sdT =</span> <span class="fu">sd</span>(temperature, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb41-16"><a href="models.html#cb41-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">cvT =</span> sdT<span class="sc">/</span>meanT,</span>
<span id="cb41-17"><a href="models.html#cb41-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb41-18"><a href="models.html#cb41-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">sumF =</span> <span class="fu">sum</span>(flow, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-19"><a href="models.html#cb41-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">meanF =</span> <span class="fu">mean</span>(flow, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-20"><a href="models.html#cb41-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">sdF =</span> <span class="fu">sd</span>(flow, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-21"><a href="models.html#cb41-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">cvF =</span> sdF<span class="sc">/</span>meanF,</span>
<span id="cb41-22"><a href="models.html#cb41-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb41-23"><a href="models.html#cb41-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-24"><a href="models.html#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="models.html#cb41-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">#message(paste(river, start, end,tag))</span></span>
<span id="cb41-26"><a href="models.html#cb41-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb41-27"><a href="models.html#cb41-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-28"><a href="models.html#cb41-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-29"><a href="models.html#cb41-29" aria-hidden="true" tabindex="-1"></a>firstObs_Env <span class="ot">&lt;-</span> firstObsDates <span class="sc">%&gt;%</span></span>
<span id="cb41-30"><a href="models.html#cb41-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb41-31"><a href="models.html#cb41-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb41-32"><a href="models.html#cb41-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb41-33"><a href="models.html#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">spawnDate =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year,spawn_month,spawn_day)) <span class="sc">-</span> <span class="fu">years</span>(<span class="dv">1</span>),</span>
<span id="cb41-34"><a href="models.html#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">emergeDate =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year,emerge_month,emerge_day)),</span>
<span id="cb41-35"><a href="models.html#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonthDate =</span> date <span class="sc">-</span> <span class="fu">days</span>(<span class="fu">as.integer</span>(<span class="dv">1</span> <span class="sc">*</span> <span class="fl">30.5</span>)), <span class="co">#months(1), &#39;months gives error when prev month has 30 days and current has 31</span></span>
<span id="cb41-36"><a href="models.html#cb41-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonthDate =</span> date <span class="sc">-</span> <span class="fu">days</span>(<span class="fu">as.integer</span>(<span class="dv">3</span> <span class="sc">*</span> <span class="fl">30.5</span>)),</span>
<span id="cb41-37"><a href="models.html#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonthDate =</span> date <span class="sc">-</span> <span class="fu">days</span>(<span class="fu">as.integer</span>(<span class="dv">5</span> <span class="sc">*</span> <span class="fl">30.5</span>)),</span>
<span id="cb41-38"><a href="models.html#cb41-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">spawn_emerge =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, spawnDate, emergeDate)),</span>
<span id="cb41-39"><a href="models.html#cb41-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">emerge_detect =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, emergeDate, date)),</span>
<span id="cb41-40"><a href="models.html#cb41-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">spawn_detect =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, spawnDate, date)),</span>
<span id="cb41-41"><a href="models.html#cb41-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonth =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, oneMonthDate, date)),</span>
<span id="cb41-42"><a href="models.html#cb41-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonth =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, threeMonthDate, date)),</span>
<span id="cb41-43"><a href="models.html#cb41-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonth =</span> <span class="fu">list</span>(<span class="fu">getEnvMeans</span>(river, fiveMonthDate, date))</span>
<span id="cb41-44"><a href="models.html#cb41-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb41-45"><a href="models.html#cb41-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-46"><a href="models.html#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="co"># merge env data into firstObs0</span></span>
<span id="cb41-47"><a href="models.html#cb41-47" aria-hidden="true" tabindex="-1"></a>firstObs <span class="ot">&lt;-</span> firstObs0 <span class="sc">%&gt;%</span></span>
<span id="cb41-48"><a href="models.html#cb41-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(firstObs_Env)</span>
<span id="cb41-49"><a href="models.html#cb41-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-50"><a href="models.html#cb41-50" aria-hidden="true" tabindex="-1"></a><span class="co">#str(firstObs)</span></span></code></pre></div>
<p>Unnest firstObs so environmental summary stats are available as data frame with the name of the time interval as the prefix to the statisticVariable name</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="models.html#cb42-1" aria-hidden="true" tabindex="-1"></a>getScaled <span class="ot">&lt;-</span> <span class="cf">function</span>(d){</span>
<span id="cb42-2"><a href="models.html#cb42-2" aria-hidden="true" tabindex="-1"></a>  (d <span class="sc">-</span> <span class="fu">mean</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span> <span class="fu">sd</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-3"><a href="models.html#cb42-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-4"><a href="models.html#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="models.html#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co"># this scales across all individuals - I think this is ok</span></span>
<span id="cb42-6"><a href="models.html#cb42-6" aria-hidden="true" tabindex="-1"></a>firstObsUnnested <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="models.html#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(spawn_emerge, emerge_detect, spawn_detect, oneMonth, threeMonth, fiveMonth), <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="models.html#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb42-9"><a href="models.html#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">emerge_detect_sumTScaled =</span> <span class="fu">getScaled</span>(emerge_detect_sumT),</span>
<span id="cb42-10"><a href="models.html#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">emerge_detect_sumFScaled =</span> <span class="fu">getScaled</span>(emerge_detect_sumF),</span>
<span id="cb42-11"><a href="models.html#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonth_sumTScaled =</span> <span class="fu">getScaled</span>(oneMonth_sumT),</span>
<span id="cb42-12"><a href="models.html#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">oneMonth_sumFScaled =</span> <span class="fu">getScaled</span>(oneMonth_sumF),</span>
<span id="cb42-13"><a href="models.html#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonth_sumTScaled =</span> <span class="fu">getScaled</span>(threeMonth_sumT),</span>
<span id="cb42-14"><a href="models.html#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">threeMonth_sumFScaled =</span> <span class="fu">getScaled</span>(threeMonth_sumF),</span>
<span id="cb42-15"><a href="models.html#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonth_sumTScaled =</span> <span class="fu">getScaled</span>(fiveMonth_sumT),</span>
<span id="cb42-16"><a href="models.html#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">fiveMonth_sumFScaled =</span> <span class="fu">getScaled</span>(fiveMonth_sumF),</span>
<span id="cb42-17"><a href="models.html#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">ydayScaled =</span> <span class="fu">getScaled</span>(yday)</span>
<span id="cb42-18"><a href="models.html#cb42-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-19"><a href="models.html#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="models.html#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(firstObsUnnested)</span></code></pre></div>
<pre><code>## tibble [20,783 × 84] (S3: tbl_df/tbl/data.frame)
##  $ tag                     : chr [1:20783] &quot;00088cbed7&quot; &quot;00088cbed8&quot; &quot;00088cbedb&quot; &quot;00088cbedd&quot; ...
##  $ species                 : chr [1:20783] &quot;bkt&quot; &quot;bnt&quot; &quot;bkt&quot; &quot;bkt&quot; ...
##  $ river                   : chr [1:20783] &quot;wb obear&quot; &quot;west brook&quot; &quot;west brook&quot; &quot;wb obear&quot; ...
##  $ detectionDate           : POSIXct[1:20783], format: &quot;2014-09-17 00:00:00&quot; &quot;2012-09-26 11:01:00&quot; &quot;2014-09-24 11:45:00&quot; &quot;2012-09-21 00:00:00&quot; ...
##  $ sampleNumber            : num [1:20783] 79 71 79 71 79 71 71 79 71 79 ...
##  $ n                       : num [1:20783] 2 3 1 3 1 1 4 2 1 1 ...
##  $ proportionSampled       : num [1:20783] 1 1 1 1 1 1 1 1 1 1 ...
##  $ observedLength          : num [1:20783] 70 86 89 61 60 64 70 62 87 73 ...
##  $ observedWeight          : num [1:20783] 3.5 6.7 8.3 2.4 2.4 2.8 4.6 2.3 7.5 4.2 ...
##  $ area                    : chr [1:20783] &quot;trib&quot; &quot;inside&quot; &quot;inside&quot; &quot;trib&quot; ...
##  $ section                 : num [1:20783] 3 23 30 8 42 20 5 11 27 3 ...
##  $ season                  : num [1:20783] 3 3 3 3 3 3 3 3 3 3 ...
##  $ isYOY                   : logi [1:20783] TRUE TRUE TRUE TRUE TRUE TRUE ...
##  $ date                    : Date[1:20783], format: &quot;2014-09-17&quot; &quot;2012-09-26&quot; &quot;2014-09-24&quot; &quot;2012-09-21&quot; ...
##  $ yday                    : int [1:20783] 260 270 267 265 269 270 264 260 270 258 ...
##  $ year                    : int [1:20783] 2014 2012 2014 2012 2014 2012 2012 2014 2012 2014 ...
##  $ spawnDate               : Date[1:20783], format: &quot;2013-11-15&quot; &quot;2011-11-15&quot; &quot;2013-11-15&quot; &quot;2011-11-15&quot; ...
##  $ emergeDate              : Date[1:20783], format: &quot;2014-03-01&quot; &quot;2012-03-01&quot; &quot;2014-03-01&quot; &quot;2012-03-01&quot; ...
##  $ oneMonthDate            : Date[1:20783], format: &quot;2014-08-18&quot; &quot;2012-08-27&quot; &quot;2014-08-25&quot; &quot;2012-08-22&quot; ...
##  $ threeMonthDate          : Date[1:20783], format: &quot;2014-06-18&quot; &quot;2012-06-27&quot; &quot;2014-06-25&quot; &quot;2012-06-22&quot; ...
##  $ fiveMonthDate           : Date[1:20783], format: &quot;2014-04-18&quot; &quot;2012-04-27&quot; &quot;2014-04-25&quot; &quot;2012-04-22&quot; ...
##  $ spawn_emerge_sumT       : num [1:20783] 110 358 131 313 131 ...
##  $ spawn_emerge_meanT      : num [1:20783] 1.03 3.32 1.22 2.9 1.22 ...
##  $ spawn_emerge_sdT        : num [1:20783] 1.36 2.3 1.56 2.43 1.56 ...
##  $ spawn_emerge_cvT        : num [1:20783] 1.321 0.695 1.274 0.838 1.274 ...
##  $ spawn_emerge_sumF       : num [1:20783] 0 48.7 25.7 0 25.7 ...
##  $ spawn_emerge_meanF      : num [1:20783] NaN 0.451 0.24 NaN 0.24 ...
##  $ spawn_emerge_sdF        : num [1:20783] NA 0.457 0.352 NA 0.352 ...
##  $ spawn_emerge_cvF        : num [1:20783] NA 1.01 1.47 NA 1.47 ...
##  $ spawn_emerge_n          : int [1:20783] 107 108 107 108 107 108 108 107 108 107 ...
##  $ emerge_detect_sumT      : num [1:20783] 2191 2791 2597 2602 2622 ...
##  $ emerge_detect_meanT     : num [1:20783] 10.9 13.3 12.5 12.7 12.5 ...
##  $ emerge_detect_sdT       : num [1:20783] 5.74 4.82 6.36 5 6.33 ...
##  $ emerge_detect_cvT       : num [1:20783] 0.527 0.362 0.51 0.394 0.507 ...
##  $ emerge_detect_sumF      : num [1:20783] 0 28.6 71.6 0 71.6 ...
##  $ emerge_detect_meanF     : num [1:20783] NaN 0.136 0.344 NaN 0.341 ...
##  $ emerge_detect_sdF       : num [1:20783] NA 0.246 0.533 NA 0.532 ...
##  $ emerge_detect_cvF       : num [1:20783] NA 1.81 1.55 NA 1.56 ...
##  $ emerge_detect_n         : int [1:20783] 201 210 208 205 210 210 204 201 210 199 ...
##  $ spawn_detect_sumT       : num [1:20783] 2301 3149 2728 2915 2753 ...
##  $ spawn_detect_meanT      : num [1:20783] 7.5 9.93 8.69 9.34 8.71 ...
##  $ spawn_detect_sdT        : num [1:20783] 6.65 6.27 7.48 6.32 7.46 ...
##  $ spawn_detect_cvT        : num [1:20783] 0.887 0.631 0.861 0.677 0.857 ...
##  $ spawn_detect_sumF       : num [1:20783] 0 77.1 97.2 0 97.2 ...
##  $ spawn_detect_meanF      : num [1:20783] NaN 0.243 0.31 NaN 0.307 ...
##  $ spawn_detect_sdF        : num [1:20783] NA 0.365 0.482 NA 0.481 ...
##  $ spawn_detect_cvF        : num [1:20783] NA 1.5 1.56 NA 1.57 ...
##  $ spawn_detect_n          : int [1:20783] 307 317 314 312 316 317 311 307 317 305 ...
##  $ oneMonth_sumT           : num [1:20783] 470 461 454 489 445 ...
##  $ oneMonth_meanT          : num [1:20783] 15.2 14.9 14.6 15.8 14.4 ...
##  $ oneMonth_sdT            : num [1:20783] 1.69 1.89 2.45 1.7 2.44 ...
##  $ oneMonth_cvT            : num [1:20783] 0.112 0.127 0.167 0.108 0.17 ...
##  $ oneMonth_sumF           : num [1:20783] 0 2.1101 -0.0766 0 -0.2195 ...
##  $ oneMonth_meanF          : num [1:20783] NaN 0.06807 -0.00247 NaN -0.00708 ...
##  $ oneMonth_sdF            : num [1:20783] NA 0.3031 0.0204 NA 0.0176 ...
##  $ oneMonth_cvF            : num [1:20783] NA 4.45 -8.24 NA -2.48 ...
##  $ oneMonth_n              : int [1:20783] 31 31 31 31 31 31 31 31 31 31 ...
##  $ threeMonth_sumT         : num [1:20783] 1445 1523 1571 1559 1561 ...
##  $ threeMonth_meanT        : num [1:20783] 15.7 16.6 17.1 16.9 17 ...
##  $ threeMonth_sdT          : num [1:20783] 1.35 1.8 2.5 1.59 2.59 ...
##  $ threeMonth_cvT          : num [1:20783] 0.0859 0.1085 0.1463 0.0936 0.1526 ...
##  $ threeMonth_sumF         : num [1:20783] 0 1.17 12.25 0 11.8 ...
##  $ threeMonth_meanF        : num [1:20783] NaN 0.0127 0.1331 NaN 0.1283 ...
##  $ threeMonth_sdF          : num [1:20783] NA 0.184 0.298 NA 0.298 ...
##  $ threeMonth_cvF          : num [1:20783] NA 14.52 2.24 NA 2.32 ...
##  $ threeMonth_n            : int [1:20783] 92 92 92 92 92 92 92 92 92 92 ...
##  $ fiveMonth_sumT          : num [1:20783] 2086 2400 2425 2281 2432 ...
##  $ fiveMonth_meanT         : num [1:20783] 13.6 15.7 15.8 14.9 15.9 ...
##  $ fiveMonth_sdT           : num [1:20783] 3.16 2.54 3.07 3.2 2.98 ...
##  $ fiveMonth_cvT           : num [1:20783] 0.232 0.162 0.194 0.215 0.188 ...
##  $ fiveMonth_sumF          : num [1:20783] 0 16.9 39.3 0 38.3 ...
##  $ fiveMonth_meanF         : num [1:20783] NaN 0.111 0.257 NaN 0.251 ...
##  $ fiveMonth_sdF           : num [1:20783] NA 0.246 0.427 NA 0.427 ...
##  $ fiveMonth_cvF           : num [1:20783] NA 2.23 1.66 NA 1.7 ...
##  $ fiveMonth_n             : int [1:20783] 153 153 153 153 153 153 153 153 153 153 ...
##  $ emerge_detect_sumTScaled: num [1:20783] -0.261 1.215 0.738 0.751 0.799 ...
##  $ emerge_detect_sumFScaled: num [1:20783] -1.346 -0.518 0.727 -1.346 0.725 ...
##  $ oneMonth_sumTScaled     : num [1:20783] 0.3199 0.1864 0.085 0.5805 -0.0332 ...
##  $ oneMonth_sumFScaled     : num [1:20783] -0.329 0.206 -0.348 -0.329 -0.384 ...
##  $ threeMonth_sumTScaled   : num [1:20783] 0.275 0.523 0.676 0.638 0.644 ...
##  $ threeMonth_sumFScaled   : num [1:20783] -0.798 -0.671 0.536 -0.798 0.488 ...
##  $ fiveMonth_sumTScaled    : num [1:20783] -0.0187 0.8552 0.9245 0.5252 0.9456 ...
##  $ fiveMonth_sumFScaled    : num [1:20783] -1.261 -0.376 0.796 -1.261 0.745 ...
##  $ ydayScaled              : num [1:20783] -0.6678 0.3131 0.0189 -0.1773 0.215 ...</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="models.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ggplot(firstObsUnnested, aes(oneMonth_sumTScaled, fiveMonth_sumTScaled)) +</span></span>
<span id="cb44-2"><a href="models.html#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  geom_point() +</span></span>
<span id="cb44-3"><a href="models.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  facet_wrap(~river)</span></span></code></pre></div>
</div>
<div id="counts-of-captured-fish" class="section level3 hasAnchor" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Counts of captured fish<a href="models.html#counts-of-captured-fish" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Min and max years (inclusive) for standardizing counts</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="models.html#cb45-1" aria-hidden="true" tabindex="-1"></a>minYear <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb45-2"><a href="models.html#cb45-2" aria-hidden="true" tabindex="-1"></a>maxYear <span class="ot">&lt;-</span> <span class="dv">2015</span></span></code></pre></div>
<p>Counts by river and species</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="models.html#cb46-1" aria-hidden="true" tabindex="-1"></a>countsRSY <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="models.html#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="models.html#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river, species, year) <span class="sc">%&gt;%</span></span>
<span id="cb46-4"><a href="models.html#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb46-5"><a href="models.html#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb46-6"><a href="models.html#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanPropSampled =</span> <span class="fu">mean</span>(proportionSampled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-7"><a href="models.html#cb46-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb46-8"><a href="models.html#cb46-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">countAdj =</span> count <span class="sc">/</span> meanPropSampled) <span class="sc">%&gt;%</span></span>
<span id="cb46-9"><a href="models.html#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb46-10"><a href="models.html#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river, species) <span class="sc">%&gt;%</span></span>
<span id="cb46-11"><a href="models.html#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanCountRS =</span> <span class="fu">mean</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-12"><a href="models.html#cb46-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">sdCountRS =</span> <span class="fu">sd</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-13"><a href="models.html#cb46-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">countRS_Scaled =</span> (count <span class="sc">-</span> meanCountRS) <span class="sc">/</span> sdCountRS) <span class="sc">%&gt;%</span></span>
<span id="cb46-14"><a href="models.html#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb46-15"><a href="models.html#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="models.html#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(countsRSY, <span class="fu">aes</span>(year, countRS_Scaled, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb46-17"><a href="models.html#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-18"><a href="models.html#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb46-19"><a href="models.html#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> river)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/rawCounts-1.png" width="672" /></p>
<p>Counts by river</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="models.html#cb47-1" aria-hidden="true" tabindex="-1"></a>countsRY <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="models.html#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="models.html#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river, year) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="models.html#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb47-5"><a href="models.html#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb47-6"><a href="models.html#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanPropSampled =</span> <span class="fu">mean</span>(proportionSampled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-7"><a href="models.html#cb47-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb47-8"><a href="models.html#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">countAdj =</span> count <span class="sc">/</span> meanPropSampled) <span class="sc">%&gt;%</span></span>
<span id="cb47-9"><a href="models.html#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb47-10"><a href="models.html#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(river) <span class="sc">%&gt;%</span></span>
<span id="cb47-11"><a href="models.html#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanCountR =</span> <span class="fu">mean</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-12"><a href="models.html#cb47-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">sdCountR =</span> <span class="fu">sd</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-13"><a href="models.html#cb47-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">countR_Scaled =</span> (count <span class="sc">-</span> meanCountR) <span class="sc">/</span> sdCountR) <span class="sc">%&gt;%</span></span>
<span id="cb47-14"><a href="models.html#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb47-15"><a href="models.html#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="models.html#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(countsRY, <span class="fu">aes</span>(year, countR_Scaled, <span class="at">color =</span> river)) <span class="sc">+</span></span>
<span id="cb47-17"><a href="models.html#cb47-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb47-18"><a href="models.html#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/countsRY-1.png" width="672" /></p>
<p>Counts for the metaPopulation (WB, Jimmy, Mitchell)<br />
Use these for modelling.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="models.html#cb48-1" aria-hidden="true" tabindex="-1"></a>countsMetaY <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="models.html#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(river <span class="sc">!=</span> <span class="st">&quot;wb obear&quot;</span>, year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="models.html#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb48-4"><a href="models.html#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb48-5"><a href="models.html#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">count =</span> <span class="fu">n</span>(),</span>
<span id="cb48-6"><a href="models.html#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">meanPropSampled =</span> <span class="fu">mean</span>(proportionSampled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-7"><a href="models.html#cb48-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb48-8"><a href="models.html#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">countAdj =</span> count <span class="sc">/</span> meanPropSampled) <span class="sc">%&gt;%</span></span>
<span id="cb48-9"><a href="models.html#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-10"><a href="models.html#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">meanCount =</span> <span class="fu">mean</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb48-11"><a href="models.html#cb48-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">sdCount =</span> <span class="fu">sd</span>(count, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb48-12"><a href="models.html#cb48-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">count_Scaled =</span> (count <span class="sc">-</span> meanCount) <span class="sc">/</span> sdCount)</span>
<span id="cb48-13"><a href="models.html#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co"># missing data for tribs in 2000, 2001 - may skew scaled count a bit low - should fix</span></span>
<span id="cb48-14"><a href="models.html#cb48-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-15"><a href="models.html#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(countsMetaY, <span class="fu">aes</span>(year, count_Scaled)) <span class="sc">+</span></span>
<span id="cb48-16"><a href="models.html#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb48-17"><a href="models.html#cb48-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/countsMeta-1.png" width="672" /></p>
<p>Merge metapopulation scaled counts into firstObsUnnested</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="models.html#cb49-1" aria-hidden="true" tabindex="-1"></a>firstObsUnnested <span class="ot">&lt;-</span> firstObsUnnested <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="models.html#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(countsMetaY <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(year, count_Scaled))</span>
<span id="cb49-3"><a href="models.html#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="models.html#cb49-4" aria-hidden="true" tabindex="-1"></a>firstObsUnnestedWB <span class="ot">&lt;-</span> firstObsUnnested <span class="sc">%&gt;%</span> <span class="fu">filter</span>(river <span class="sc">==</span> <span class="st">&quot;west brook&quot;</span>)</span></code></pre></div>
</div>
<div id="raw-data-plots" class="section level3 hasAnchor" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> Raw data plots<a href="models.html#raw-data-plots" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="frequency-plots-by-species-and-river" class="section level4 hasAnchor" number="3.1.5.1">
<h4><span class="header-section-number">3.1.5.1</span> Frequency plots by species and river<a href="models.html#frequency-plots-by-species-and-river" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
<div id="brook-trout-west-brook" class="section level4 hasAnchor" number="3.1.5.2">
<h4><span class="header-section-number">3.1.5.2</span> Brook Trout, West brook<a href="models.html#brook-trout-west-brook" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="models.html#cb50-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#cd1 &lt;- cdWB_electro %&gt;% filter(ageInSamples == 1, species != &#39;ats&#39;)</span></span>
<span id="cb50-2"><a href="models.html#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="models.html#cb50-3" aria-hidden="true" tabindex="-1"></a>  plotSppRiv <span class="ot">=</span> <span class="cf">function</span>(s, r) { </span>
<span id="cb50-4"><a href="models.html#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">==</span> s, river <span class="sc">==</span> r), <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb50-5"><a href="models.html#cb50-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb50-6"><a href="models.html#cb50-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb50-7"><a href="models.html#cb50-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggtitle</span>(<span class="fu">paste</span>(s, r, <span class="at">sep =</span> <span class="st">&#39;, &#39;</span>)) <span class="sc">+</span></span>
<span id="cb50-8"><a href="models.html#cb50-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">xlim</span>(<span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">125</span>)) <span class="sc">+</span></span>
<span id="cb50-9"><a href="models.html#cb50-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="sc">~</span> year, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>)</span>
<span id="cb50-10"><a href="models.html#cb50-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb50-11"><a href="models.html#cb50-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-12"><a href="models.html#cb50-12" aria-hidden="true" tabindex="-1"></a>  species <span class="ot">=</span> <span class="st">&#39;bkt&#39;</span></span>
<span id="cb50-13"><a href="models.html#cb50-13" aria-hidden="true" tabindex="-1"></a>  riverOrdered <span class="ot">=</span> <span class="st">&quot;west brook&quot;</span></span>
<span id="cb50-14"><a href="models.html#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="models.html#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plotSppRiv</span>(species, riverOrdered)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots1-1.png" width="672" /></p>
</div>
<div id="brook-trout-wb-jimmy" class="section level4 hasAnchor" number="3.1.5.3">
<h4><span class="header-section-number">3.1.5.3</span> Brook Trout, wb jimmy<a href="models.html#brook-trout-wb-jimmy" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots2-1.png" width="672" /></p>
</div>
<div id="brook-trout-wb-mitchell" class="section level4 hasAnchor" number="3.1.5.4">
<h4><span class="header-section-number">3.1.5.4</span> Brook Trout, wb mitchell<a href="models.html#brook-trout-wb-mitchell" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots3-1.png" width="672" /></p>
</div>
<div id="brook-trout-wb-obear" class="section level4 hasAnchor" number="3.1.5.5">
<h4><span class="header-section-number">3.1.5.5</span> Brook Trout, wb obear<a href="models.html#brook-trout-wb-obear" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots4-1.png" width="672" /></p>
</div>
<div id="brown-trout-west-brook" class="section level4 hasAnchor" number="3.1.5.6">
<h4><span class="header-section-number">3.1.5.6</span> Brown Trout, West brook<a href="models.html#brown-trout-west-brook" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots5-1.png" width="672" /></p>
</div>
<div id="brown-trout-wb-jimmy" class="section level4 hasAnchor" number="3.1.5.7">
<h4><span class="header-section-number">3.1.5.7</span> Brown Trout, wb jimmy<a href="models.html#brown-trout-wb-jimmy" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots6-1.png" width="672" /></p>
</div>
<div id="brown-trout-wb-mitchell" class="section level4 hasAnchor" number="3.1.5.8">
<h4><span class="header-section-number">3.1.5.8</span> Brown Trout, wb mitchell<a href="models.html#brown-trout-wb-mitchell" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><img src="westBrook-book_files/figure-html/raw%20data%20plots7-1.png" width="672" /></p>
</div>
<div id="brown-trout-wb-obear---there-are-no-brown-trout-in-obear" class="section level4 hasAnchor" number="3.1.5.9">
<h4><span class="header-section-number">3.1.5.9</span> Brown Trout, wb obear - there are no Brown trout in O’Bear<a href="models.html#brown-trout-wb-obear---there-are-no-brown-trout-in-obear" class="anchor-section" aria-label="Anchor link to header"></a></h4>
</div>
<div id="trout-in-the-wb-mainstem-only" class="section level4 hasAnchor" number="3.1.5.10">
<h4><span class="header-section-number">3.1.5.10</span> Trout, in the WB mainstem only<a href="models.html#trout-in-the-wb-mainstem-only" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="models.html#cb51-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>), <span class="fu">aes</span>(observedLength)) <span class="sc">+</span></span>
<span id="cb51-2"><a href="models.html#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb51-3"><a href="models.html#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>, <span class="at">color =</span> <span class="st">&#39;orange&#39;</span>) <span class="sc">+</span></span>
<span id="cb51-4"><a href="models.html#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(species <span class="sc">~</span> year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/troutWB-1.png" width="672" /></p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="models.html#cb52-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>), <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb52-2"><a href="models.html#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb52-3"><a href="models.html#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>, <span class="at">color =</span> <span class="st">&#39;orange&#39;</span>) <span class="sc">+</span></span>
<span id="cb52-4"><a href="models.html#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(species <span class="sc">~</span> year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/troutWB-2.png" width="672" /></p>
</div>
<div id="why-are-there-untagged-fish-bigger-than-60mm" class="section level4 hasAnchor" number="3.1.5.11">
<h4><span class="header-section-number">3.1.5.11</span> Why are there untagged fish bigger than 60mm?<a href="models.html#why-are-there-untagged-fish-bigger-than-60mm" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Check 2002/bkt/WB, as an example
Answer: because they are outside the study area (area = ‘above’ or ‘below’) or were tagging mortalities</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="models.html#cb53-1" aria-hidden="true" tabindex="-1"></a>  firstObs2002BKT <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2002</span>, species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>)</span>
<span id="cb53-2"><a href="models.html#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">is.na</span>(firstObs2002BKT<span class="sc">$</span>tag))</span></code></pre></div>
<pre><code>## 
## FALSE  TRUE 
##   295   253</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="models.html#cb55-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs2002BKT, <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb55-2"><a href="models.html#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb55-3"><a href="models.html#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/2002%20untagged-1.png" width="672" /></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="models.html#cb56-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># looks like untagged area=inside fish wee morts, the rest were above or below</span></span>
<span id="cb56-2"><a href="models.html#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs2002BKT, <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb56-3"><a href="models.html#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb56-4"><a href="models.html#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb56-5"><a href="models.html#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span>area)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/2002%20untagged-2.png" width="672" /></p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="models.html#cb57-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check 2003</span></span>
<span id="cb57-2"><a href="models.html#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2003</span>, species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>), <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb57-3"><a href="models.html#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb57-4"><a href="models.html#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>) <span class="sc">+</span></span>
<span id="cb57-5"><a href="models.html#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span>area)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/2002%20untagged-3.png" width="672" /></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="models.html#cb58-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># same story as 2002</span></span></code></pre></div>
</div>
<div id="why-no-untagged-fish-for-2000-and-2001" class="section level4 hasAnchor" number="3.1.5.12">
<h4><span class="header-section-number">3.1.5.12</span> Why no untagged fish for 2000 and 2001?<a href="models.html#why-no-untagged-fish-for-2000-and-2001" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Check data logs to see if we were not recording untagged fish in 2000, 2001</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="models.html#cb59-1" aria-hidden="true" tabindex="-1"></a>  cfirstObs2000_2001BKT <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="dv">2000</span><span class="sc">:</span><span class="dv">2001</span>, species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>)</span>
<span id="cb59-2"><a href="models.html#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">is.na</span>(cfirstObs2000_2001BKT<span class="sc">$</span>tag))</span></code></pre></div>
<pre><code>## 
## FALSE 
##   343</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="models.html#cb61-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>(cfirstObs2000_2001BKT<span class="sc">$</span>observedLength)</span></code></pre></div>
<pre><code>## 
## 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 85 90 
## 18 23 23 26 20 28 19 14 28 23 20 21  9 14  8 11  3  8  4  5  6  5  1  3  2  1</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="models.html#cb63-1" aria-hidden="true" tabindex="-1"></a>  cfirstObs2000_2001BKT <span class="sc">%&gt;%</span> <span class="fu">filter</span>(observedLength <span class="sc">&lt;</span> <span class="dv">60</span>)</span></code></pre></div>
<pre><code>## # A tibble: 64 × 27
##    tag        species river detectionDate       sampleNumber     n proportionSampl… observedLength observedWeight area  section season isYOY date      
##    &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;dttm&gt;                     &lt;dbl&gt; &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt; &lt;date&gt;    
##  1 1bf0fc3a19 bkt     west… 2001-09-10 12:00:00           27     2                1             58            1.9 insi…      25      3 TRUE  2001-09-10
##  2 1bf0fc46b1 bkt     west… 2001-09-07 12:00:00           27     2                1             57            1.9 insi…      20      3 TRUE  2001-09-07
##  3 1bf0fe50cb bkt     west… 2001-09-07 12:00:00           27     1                1             59            2.1 insi…      19      3 TRUE  2001-09-07
##  4 1bf0fe76f1 bkt     west… 2001-09-07 12:00:00           27     6                1             59            2.1 insi…      20      3 TRUE  2001-09-07
##  5 1bf0fe845b bkt     west… 2001-09-06 12:00:00           27     1                1             59            2.2 insi…      17      3 TRUE  2001-09-06
##  6 1bf0fe84ed bkt     west… 2001-09-10 12:00:00           27     1                1             57            1.9 insi…      25      3 TRUE  2001-09-10
##  7 1bf0fe8846 bkt     west… 2001-09-07 12:00:00           27     3                1             58            2   insi…      22      3 TRUE  2001-09-07
##  8 1bf0fe88d8 bkt     west… 2001-09-10 12:00:00           27     2                1             58            2.1 insi…      30      3 TRUE  2001-09-10
##  9 1bf0fe8b79 bkt     west… 2001-09-06 12:00:00           27     4                1             58            2   insi…      18      3 TRUE  2001-09-06
## 10 1bf0fe9504 bkt     west… 2001-09-07 12:00:00           27     3                1             58            1.8 insi…      22      3 TRUE  2001-09-07
## # … with 54 more rows, and 13 more variables: yday &lt;int&gt;, year &lt;int&gt;, spawnDate &lt;date&gt;, emergeDate &lt;date&gt;, oneMonthDate &lt;date&gt;, threeMonthDate &lt;date&gt;,
## #   fiveMonthDate &lt;date&gt;, spawn_emerge &lt;list&gt;, emerge_detect &lt;list&gt;, spawn_detect &lt;list&gt;, oneMonth &lt;list&gt;, threeMonth &lt;list&gt;, fiveMonth &lt;list&gt;</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="models.html#cb65-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(cfirstObs2000_2001BKT, <span class="fu">aes</span>(observedLength, <span class="at">color =</span> <span class="fu">is.na</span>(tag))) <span class="sc">+</span></span>
<span id="cb65-2"><a href="models.html#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_freqpoly</span>() <span class="sc">+</span></span>
<span id="cb65-3"><a href="models.html#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">60</span>)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/untagged%202000,%202001-1.png" width="672" /></p>
</div>
</div>
<div id="models-based-on-yearly-means" class="section level3 hasAnchor" number="3.1.6">
<h3><span class="header-section-number">3.1.6</span> Models based on yearly means<a href="models.html#models-based-on-yearly-means" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Filter firstObsUnnestedWB for bkt, bnt and min/maxYear</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="models.html#cb66-1" aria-hidden="true" tabindex="-1"></a>d_WB_BKT_BNT <span class="ot">&lt;-</span> firstObsUnnestedWB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>, year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb66-2"><a href="models.html#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species01 =</span> <span class="fu">ifelse</span>(species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb66-3"><a href="models.html#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="models.html#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(d_WB_BKT_BNT<span class="sc">$</span>detectionDate, <span class="at">breaks =</span> <span class="dv">250</span>)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/filter%20firstObsUnnestedWB-1.png" width="672" /></p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="models.html#cb67-1" aria-hidden="true" tabindex="-1"></a>d_BKT_BNT <span class="ot">&lt;-</span> firstObsUnnested <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">!=</span> <span class="st">&quot;ats&quot;</span>, year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear) <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="models.html#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">species01 =</span> <span class="fu">ifelse</span>(species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span></code></pre></div>
<p>Mean model functions</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="models.html#cb68-1" aria-hidden="true" tabindex="-1"></a>getMeansData <span class="ot">&lt;-</span> <span class="cf">function</span>(d, t, f) {</span>
<span id="cb68-2"><a href="models.html#cb68-2" aria-hidden="true" tabindex="-1"></a>  means <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb68-3"><a href="models.html#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, year) <span class="sc">%&gt;%</span> </span>
<span id="cb68-4"><a href="models.html#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">meanLength =</span> <span class="fu">mean</span>(observedLength, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb68-5"><a href="models.html#cb68-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumTScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-6"><a href="models.html#cb68-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumFScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-7"><a href="models.html#cb68-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanTTime_sumTScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(t), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-8"><a href="models.html#cb68-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanFTime_sumFScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(f), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-9"><a href="models.html#cb68-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanYdayScaled =</span> <span class="fu">mean</span>(ydayScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-10"><a href="models.html#cb68-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanCount_Scaled =</span> <span class="fu">mean</span>(count_Scaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-11"><a href="models.html#cb68-11" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb68-12"><a href="models.html#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(means)</span>
<span id="cb68-13"><a href="models.html#cb68-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-14"><a href="models.html#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="models.html#cb68-15" aria-hidden="true" tabindex="-1"></a>getMeansDataByRiver <span class="ot">&lt;-</span> <span class="cf">function</span>(d, t, f) {</span>
<span id="cb68-16"><a href="models.html#cb68-16" aria-hidden="true" tabindex="-1"></a>  means <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb68-17"><a href="models.html#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, year, river) <span class="sc">%&gt;%</span> </span>
<span id="cb68-18"><a href="models.html#cb68-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">meanLength =</span> <span class="fu">mean</span>(observedLength, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb68-19"><a href="models.html#cb68-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumTScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-20"><a href="models.html#cb68-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanEmerge_detect_sumFScaled =</span> <span class="fu">mean</span>(emerge_detect_sumTScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-21"><a href="models.html#cb68-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanTTime_sumTScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(t), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-22"><a href="models.html#cb68-22" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanFTime_sumFScaled =</span> <span class="fu">mean</span>(<span class="fu">get</span>(f), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-23"><a href="models.html#cb68-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanYdayScaled =</span> <span class="fu">mean</span>(ydayScaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb68-24"><a href="models.html#cb68-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">meanCount_Scaled =</span> <span class="fu">mean</span>(count_Scaled, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb68-25"><a href="models.html#cb68-25" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb68-26"><a href="models.html#cb68-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(means)</span>
<span id="cb68-27"><a href="models.html#cb68-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-28"><a href="models.html#cb68-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-29"><a href="models.html#cb68-29" aria-hidden="true" tabindex="-1"></a>plotMeans <span class="ot">&lt;-</span> <span class="cf">function</span>(means){</span>
<span id="cb68-30"><a href="models.html#cb68-30" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb68-31"><a href="models.html#cb68-31" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(means, <span class="fu">aes</span>(meanTTime_sumTScaled, meanLength, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb68-32"><a href="models.html#cb68-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb68-33"><a href="models.html#cb68-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-34"><a href="models.html#cb68-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-35"><a href="models.html#cb68-35" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(means, <span class="fu">aes</span>(meanFTime_sumFScaled, meanLength, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb68-36"><a href="models.html#cb68-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb68-37"><a href="models.html#cb68-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-38"><a href="models.html#cb68-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-39"><a href="models.html#cb68-39" aria-hidden="true" tabindex="-1"></a>  out[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(means, <span class="fu">aes</span>(meanTTime_sumTScaled, meanFTime_sumFScaled, <span class="at">color =</span> species)) <span class="sc">+</span></span>
<span id="cb68-40"><a href="models.html#cb68-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb68-41"><a href="models.html#cb68-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb68-42"><a href="models.html#cb68-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb68-43"><a href="models.html#cb68-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-44"><a href="models.html#cb68-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-45"><a href="models.html#cb68-45" aria-hidden="true" tabindex="-1"></a>runMeanModels <span class="ot">&lt;-</span> <span class="cf">function</span>(means) {</span>
<span id="cb68-46"><a href="models.html#cb68-46" aria-hidden="true" tabindex="-1"></a>  modLMMeans1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> meanFTime_sumFScaled <span class="sc">+</span> meanTTime_sumTScaled <span class="sc">+</span> meanYdayScaled <span class="sc">+</span> meanCount_Scaled), <span class="at">data =</span> means)</span>
<span id="cb68-47"><a href="models.html#cb68-47" aria-hidden="true" tabindex="-1"></a>  modLMMeans2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> meanFTime_sumFScaled <span class="sc">+</span> meanTTime_sumTScaled <span class="sc">+</span> meanYdayScaled <span class="sc">+</span> meanCount_Scaled)<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> means)</span>
<span id="cb68-48"><a href="models.html#cb68-48" aria-hidden="true" tabindex="-1"></a>  modLMMeans3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(meanLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> meanFTime_sumFScaled <span class="sc">+</span> meanTTime_sumTScaled <span class="sc">+</span> meanYdayScaled <span class="sc">+</span> meanCount_Scaled)<span class="sc">^</span><span class="dv">3</span>, <span class="at">data =</span> means)</span>
<span id="cb68-49"><a href="models.html#cb68-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(modLMMeans1, modLMMeans2, modLMMeans3))</span>
<span id="cb68-50"><a href="models.html#cb68-50" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Mean lengths by river. This is information only. Using the WB data only shown here and in the next graph for the models.
<img src="westBrook-book_files/figure-html/meanLengthsR-1.png" width="672" /></p>
<p>Mean lengths for the mean length model.
<img src="westBrook-book_files/figure-html/meanLengths-1.png" width="672" /></p>
<p>Graphs for variables that do not depend on number of months
<img src="westBrook-book_files/figure-html/staticGraphs-1.png" width="672" /><img src="westBrook-book_files/figure-html/staticGraphs-2.png" width="672" /></p>
<div id="models-with-flow-and-temperature-from-previous-one-month" class="section level4 hasAnchor" number="3.1.6.1">
<h4><span class="header-section-number">3.1.6.1</span> Models with flow and temperature from previous <em>one</em> month<a href="models.html#models-with-flow-and-temperature-from-previous-one-month" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## [[1]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means1Month-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means1Month-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means1Month-3.png" width="672" /></p>
<pre><code>##           df      AIC
## mod1[[2]] 17 176.2075
## mod1[[3]] 27 181.7035
## mod1[[1]]  7 181.8187</code></pre>
<pre><code>## 
## Call:
## lm(formula = meanLength ~ (factor(species) + meanFTime_sumFScaled + 
##     meanTTime_sumTScaled + meanYdayScaled + meanCount_Scaled), 
##     data = means)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -6.2779 -1.9839 -0.8754  1.0981 10.5908 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)           72.4359     1.0722  67.558  &lt; 2e-16 ***
## factor(species)bnt     0.6550     1.3128   0.499 0.622039    
## meanFTime_sumFScaled   1.6769     0.3849   4.356 0.000184 ***
## meanTTime_sumTScaled -10.3842     2.3734  -4.375 0.000175 ***
## meanYdayScaled        -3.4856     1.7314  -2.013 0.054554 .  
## meanCount_Scaled      -2.5187     0.7068  -3.564 0.001443 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 3.695 on 26 degrees of freedom
## Multiple R-squared:  0.6966, Adjusted R-squared:  0.6383 
## F-statistic: 11.94 on 5 and 26 DF,  p-value: 4.544e-06</code></pre>
<p>Relative importance for main effects model</p>
<pre><code>##      factor(species) meanFTime_sumFScaled meanTTime_sumTScaled       meanYdayScaled     meanCount_Scaled 
##           0.00395522           0.24940595           0.19990058           0.06280977           0.18053989</code></pre>
</div>
<div id="models-with-flow-and-temperature-from-previous-three-months" class="section level4 hasAnchor" number="3.1.6.2">
<h4><span class="header-section-number">3.1.6.2</span> Models with flow and temperature from previous <em>three</em> months<a href="models.html#models-with-flow-and-temperature-from-previous-three-months" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## [[1]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means3Month-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means3Month-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means3Month-3.png" width="672" /></p>
<pre><code>##           df      AIC
## mod3[[3]] 27 177.0683
## mod3[[2]] 17 181.7547
## mod3[[1]]  7 187.3979</code></pre>
<pre><code>## 
## Call:
## lm(formula = meanLength ~ (factor(species) + meanFTime_sumFScaled + 
##     meanTTime_sumTScaled + meanYdayScaled + meanCount_Scaled), 
##     data = means)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -6.3569 -2.8523  0.3445  1.8018  9.2951 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)           73.4882     1.8809  39.070  &lt; 2e-16 ***
## factor(species)bnt     0.8334     1.4312   0.582 0.565351    
## meanFTime_sumFScaled   2.2450     0.5866   3.827 0.000732 ***
## meanTTime_sumTScaled  -8.8499     3.6769  -2.407 0.023489 *  
## meanYdayScaled         0.7120     1.4287   0.498 0.622411    
## meanCount_Scaled      -3.1604     0.7937  -3.982 0.000490 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 4.032 on 26 degrees of freedom
## Multiple R-squared:  0.6388, Adjusted R-squared:  0.5694 
## F-statistic: 9.197 on 5 and 26 DF,  p-value: 3.902e-05</code></pre>
<p>Relative importance for main effects model</p>
<pre><code>##      factor(species) meanFTime_sumFScaled meanTTime_sumTScaled       meanYdayScaled     meanCount_Scaled 
##          0.004325792          0.281631981          0.060776249          0.066333713          0.225756051</code></pre>
</div>
<div id="models-with-flow-and-temperature-from-previous-five-months" class="section level4 hasAnchor" number="3.1.6.3">
<h4><span class="header-section-number">3.1.6.3</span> Models with flow and temperature from previous <em>five</em> months<a href="models.html#models-with-flow-and-temperature-from-previous-five-months" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<pre><code>## [[1]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means5Month-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means5Month-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="westBrook-book_files/figure-html/means5Month-3.png" width="672" /></p>
<pre><code>##           df      AIC
## mod5[[3]] 27 167.4034
## mod5[[1]]  7 193.2144
## mod5[[2]] 17 208.3847</code></pre>
<pre><code>## 
## Call:
## lm(formula = meanLength ~ (factor(species) + meanFTime_sumFScaled + 
##     meanTTime_sumTScaled + meanYdayScaled + meanCount_Scaled), 
##     data = means)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -5.9186 -3.3732  0.3856  2.4470 11.8564 
## 
## Coefficients:
##                      Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)           71.1144     1.9342  36.767  &lt; 2e-16 ***
## factor(species)bnt     0.8911     1.5671   0.569  0.57450    
## meanFTime_sumFScaled   2.6934     0.8705   3.094  0.00468 ** 
## meanTTime_sumTScaled  -3.5748     2.9746  -1.202  0.24029    
## meanYdayScaled         3.2403     1.5506   2.090  0.04657 *  
## meanCount_Scaled      -2.8957     0.8613  -3.362  0.00240 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 4.415 on 26 degrees of freedom
## Multiple R-squared:  0.5668, Adjusted R-squared:  0.4835 
## F-statistic: 6.805 on 5 and 26 DF,  p-value: 0.0003537</code></pre>
<p>Relative importance for main effects model</p>
<pre><code>##      factor(species) meanFTime_sumFScaled meanTTime_sumTScaled       meanYdayScaled     meanCount_Scaled 
##          0.004330339          0.226812955          0.017322018          0.107186866          0.211177826</code></pre>
r-squared values and AICs for 1st, 2nd (2-way interactions) and 3rd (3-way interactions) order models
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
Order
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.697
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.864
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.913
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
Order
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.639
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.838
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.925
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:right;">
Order
</th>
<th style="text-align:right;">
r2
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.567
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0.628
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
0.945
</td>
<td style="text-align:right;">
5
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mod1[[2]]
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
176.207
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
mod1[[3]]
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
181.703
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
mod1[[1]]
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
181.819
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mod3[[3]]
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
177.068
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
mod3[[2]]
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
181.755
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
mod3[[1]]
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
187.398
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
df
</th>
<th style="text-align:right;">
AIC
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mod5[[3]]
</td>
<td style="text-align:right;">
27
</td>
<td style="text-align:right;">
167.403
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
mod5[[1]]
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
193.214
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
mod5[[2]]
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
208.385
</td>
<td style="text-align:right;">
5
</td>
</tr>
</tbody>
</table>
Relative importance of main effects models (repeat of above, but all in one place here)
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
var
</th>
<th style="text-align:right;">
relImp
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
factor(species)
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanFTime_sumFScaled
</td>
<td style="text-align:right;">
0.249
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanTTime_sumTScaled
</td>
<td style="text-align:right;">
0.200
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanYdayScaled
</td>
<td style="text-align:right;">
0.063
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
meanCount_Scaled
</td>
<td style="text-align:right;">
0.181
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
var
</th>
<th style="text-align:right;">
relImp
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
factor(species)
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanFTime_sumFScaled
</td>
<td style="text-align:right;">
0.282
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanTTime_sumTScaled
</td>
<td style="text-align:right;">
0.061
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanYdayScaled
</td>
<td style="text-align:right;">
0.066
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
meanCount_Scaled
</td>
<td style="text-align:right;">
0.226
</td>
<td style="text-align:right;">
3
</td>
</tr>
</tbody>
</table>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
var
</th>
<th style="text-align:right;">
relImp
</th>
<th style="text-align:right;">
numMonths
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
factor(species)
</td>
<td style="text-align:right;">
0.004
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanFTime_sumFScaled
</td>
<td style="text-align:right;">
0.227
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanTTime_sumTScaled
</td>
<td style="text-align:right;">
0.017
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanYdayScaled
</td>
<td style="text-align:right;">
0.107
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
meanCount_Scaled
</td>
<td style="text-align:right;">
0.211
</td>
<td style="text-align:right;">
5
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="models-with-extreme-flow-events-droughts" class="section level3 hasAnchor" number="3.1.7">
<h3><span class="header-section-number">3.1.7</span> Models with extreme flow events (droughts)<a href="models.html#models-with-extreme-flow-events-droughts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We get negative cumulFlows because we have some negative flows from the flow extension model</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="models.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># put some of these calculations into envDataWB</span></span>
<span id="cb87-2"><a href="models.html#cb87-2" aria-hidden="true" tabindex="-1"></a>envDataWBFlow <span class="ot">=</span> envDataWB <span class="sc">%&gt;%</span></span>
<span id="cb87-3"><a href="models.html#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(dateDate),</span>
<span id="cb87-4"><a href="models.html#cb87-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">yday =</span> <span class="fu">yday</span>(dateDate),</span>
<span id="cb87-5"><a href="models.html#cb87-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">flowNoNAs =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(flow), <span class="dv">0</span>, flow),</span>
<span id="cb87-6"><a href="models.html#cb87-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">tempNoNAs =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(temperature), <span class="dv">0</span>, temperature)) <span class="sc">%&gt;%</span></span>
<span id="cb87-7"><a href="models.html#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear, </span>
<span id="cb87-8"><a href="models.html#cb87-8" aria-hidden="true" tabindex="-1"></a>         yday <span class="sc">&gt;</span> <span class="dv">100</span>, yday <span class="sc">&lt;</span> <span class="dv">300</span>,</span>
<span id="cb87-9"><a href="models.html#cb87-9" aria-hidden="true" tabindex="-1"></a>         river <span class="sc">==</span> <span class="st">&quot;west brook&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb87-10"><a href="models.html#cb87-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb87-11"><a href="models.html#cb87-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumulFlow =</span> <span class="fu">cumsum</span>(flowNoNAs),</span>
<span id="cb87-12"><a href="models.html#cb87-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">cumulFlow01 =</span> cumulFlow <span class="sc">/</span> <span class="fu">max</span>(cumulFlow),</span>
<span id="cb87-13"><a href="models.html#cb87-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">cumulTemp =</span> <span class="fu">cumsum</span>(tempNoNAs)) <span class="sc">%&gt;%</span></span>
<span id="cb87-14"><a href="models.html#cb87-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb87-15"><a href="models.html#cb87-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-16"><a href="models.html#cb87-16" aria-hidden="true" tabindex="-1"></a>firstObsYears <span class="ot">&lt;-</span> firstObs <span class="sc">%&gt;%</span></span>
<span id="cb87-17"><a href="models.html#cb87-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">%in%</span> minYear<span class="sc">:</span>maxYear, </span>
<span id="cb87-18"><a href="models.html#cb87-18" aria-hidden="true" tabindex="-1"></a>           yday <span class="sc">&gt;</span> <span class="dv">100</span>, yday <span class="sc">&lt;</span> <span class="dv">300</span>)</span>
<span id="cb87-19"><a href="models.html#cb87-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-20"><a href="models.html#cb87-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, flow)) <span class="sc">+</span></span>
<span id="cb87-21"><a href="models.html#cb87-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, observedLength<span class="sc">/</span><span class="dv">20</span>), <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">&#39;lightblue&#39;</span>, <span class="at">data =</span> firstObsYears) <span class="sc">+</span></span>
<span id="cb87-22"><a href="models.html#cb87-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb87-23"><a href="models.html#cb87-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">300</span>, <span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb87-24"><a href="models.html#cb87-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-1.png" width="672" /></p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="models.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, cumulFlow <span class="sc">/</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb88-2"><a href="models.html#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, observedLength <span class="sc">/</span> <span class="dv">20</span>), <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">&#39;lightblue&#39;</span>, <span class="at">data =</span> firstObsYears) <span class="sc">+</span></span>
<span id="cb88-3"><a href="models.html#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&#39;darkgrey&#39;</span>) <span class="sc">+</span></span>
<span id="cb88-4"><a href="models.html#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, cumulTemp <span class="sc">/</span> <span class="dv">800</span>), <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">color =</span> <span class="st">&quot;orange&quot;</span>, <span class="at">data =</span> envDataWBFlow) <span class="sc">+</span></span>
<span id="cb88-5"><a href="models.html#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(yday, flow), <span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">data =</span> envDataWBFlow) <span class="sc">+</span></span>
<span id="cb88-6"><a href="models.html#cb88-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">300</span>, <span class="dv">30</span>)) <span class="sc">+</span></span>
<span id="cb88-7"><a href="models.html#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#theme_publication() +</span></span>
<span id="cb88-8"><a href="models.html#cb88-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-2.png" width="672" /></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="models.html#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, cumulFlow, <span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb89-2"><a href="models.html#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb89-3"><a href="models.html#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">300</span>, <span class="dv">30</span>)) </span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-3.png" width="672" /></p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="models.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(envDataWBFlow, <span class="fu">aes</span>(yday, cumulTemp, <span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb90-2"><a href="models.html#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb90-3"><a href="models.html#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_point(aes(yday, cumulTemp / 800, color = factor(year)), data = tmp) +</span></span>
<span id="cb90-4"><a href="models.html#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">300</span>, <span class="dv">30</span>))</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/drought-4.png" width="672" /></p>
<p>Is there a sampling section effect?</p>
<p>Note: there are fish in sections &gt; 50 for years 2002 and 2003, need to filter out early</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="models.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT <span class="sc">%&gt;%</span> <span class="fu">filter</span>( section <span class="sc">&lt;=</span> <span class="dv">47</span>), <span class="fu">aes</span>(<span class="fu">factor</span>(section), observedLength)) <span class="sc">+</span></span>
<span id="cb91-2"><a href="models.html#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb91-3"><a href="models.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb91-4"><a href="models.html#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="models.html#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT <span class="sc">%&gt;%</span> <span class="fu">filter</span>( section <span class="sc">&lt;=</span> <span class="dv">47</span>), <span class="fu">aes</span>(<span class="fu">factor</span>(year), observedLength)) <span class="sc">+</span></span>
<span id="cb92-2"><a href="models.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb92-3"><a href="models.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>() <span class="sc">+</span></span>
<span id="cb92-4"><a href="models.html#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>section)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-12-2.png" width="672" /></p>
</div>
<div id="models-based-on-individual-observations" class="section level3 hasAnchor" number="3.1.8">
<h3><span class="header-section-number">3.1.8</span> Models based on individual observations<a href="models.html#models-based-on-individual-observations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Probably not use these, too much individual variation</p>
<div id="are-flow-and-temperature-correlated-for-individual-observations" class="section level4 hasAnchor" number="3.1.8.1">
<h4><span class="header-section-number">3.1.8.1</span> Are flow and temperature correlated for individual observations?<a href="models.html#are-flow-and-temperature-correlated-for-individual-observations" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="models.html#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(oneMonth_sumTScaled, oneMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb93-2"><a href="models.html#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb93-3"><a href="models.html#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb93-4"><a href="models.html#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-1.png" width="672" /></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="models.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(threeMonth_sumTScaled, threeMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb94-2"><a href="models.html#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb94-3"><a href="models.html#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb94-4"><a href="models.html#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-2.png" width="672" /></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="models.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(fiveMonth_sumTScaled, fiveMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb95-2"><a href="models.html#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (year))) <span class="sc">+</span></span>
<span id="cb95-3"><a href="models.html#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb95-4"><a href="models.html#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-3.png" width="672" /></p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="models.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># water getting warmer during a sample</span></span>
<span id="cb96-2"><a href="models.html#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(fiveMonth_sumTScaled, fiveMonth_sumFScaled)) <span class="sc">+</span></span>
<span id="cb96-3"><a href="models.html#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> (yday))) <span class="sc">+</span></span>
<span id="cb96-4"><a href="models.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb96-5"><a href="models.html#cb96-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowTempCor-4.png" width="672" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="models.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB<span class="sc">$</span>oneMonth_sumTScaled, firstObsUnnestedWB<span class="sc">$</span>oneMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.1778785</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="models.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB<span class="sc">$</span>threeMonth_sumTScaled, firstObsUnnestedWB<span class="sc">$</span>threeMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.01625096</code></pre>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="models.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB<span class="sc">$</span>fiveMonth_sumTScaled, firstObsUnnestedWB<span class="sc">$</span>fiveMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.09445786</code></pre>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="models.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># brook trout</span></span>
<span id="cb103-2"><a href="models.html#cb103-2" aria-hidden="true" tabindex="-1"></a>firstObsUnnestedWB_BKT <span class="ot">&lt;-</span> firstObsUnnestedWB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">==</span> <span class="st">&quot;bkt&quot;</span>)</span>
<span id="cb103-3"><a href="models.html#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BKT<span class="sc">$</span>oneMonth_sumTScaled, firstObsUnnestedWB_BKT<span class="sc">$</span>oneMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] 0.05756251</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="models.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BKT<span class="sc">$</span>threeMonth_sumTScaled, firstObsUnnestedWB_BKT<span class="sc">$</span>threeMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.008944376</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="models.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BKT<span class="sc">$</span>fiveMonth_sumTScaled, firstObsUnnestedWB_BKT<span class="sc">$</span>fiveMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.1172725</code></pre>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="models.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># brown trout</span></span>
<span id="cb109-2"><a href="models.html#cb109-2" aria-hidden="true" tabindex="-1"></a>firstObsUnnestedWB_BNT <span class="ot">&lt;-</span> firstObsUnnestedWB <span class="sc">%&gt;%</span> <span class="fu">filter</span>(species <span class="sc">==</span> <span class="st">&quot;bnt&quot;</span>)</span>
<span id="cb109-3"><a href="models.html#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BNT<span class="sc">$</span>oneMonth_sumTScaled, firstObsUnnestedWB_BNT<span class="sc">$</span>oneMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] 0.1403489</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="models.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BNT<span class="sc">$</span>threeMonth_sumTScaled, firstObsUnnestedWB_BNT<span class="sc">$</span>threeMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.103418</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="models.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(firstObsUnnestedWB_BNT<span class="sc">$</span>fiveMonth_sumTScaled, firstObsUnnestedWB_BNT<span class="sc">$</span>fiveMonth_sumFScaled)</span></code></pre></div>
<pre><code>## [1] -0.009179518</code></pre>
<p>Do fish from long samples get bigger over time?<br />
No clear evidence.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="models.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(firstObsUnnestedWB, <span class="fu">aes</span>(yday, observedLength)) <span class="sc">+</span></span>
<span id="cb115-2"><a href="models.html#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb115-3"><a href="models.html#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb115-4"><a href="models.html#cb115-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>year)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Assign the month interval (one, three, five) for flow and temperature variables. The variable will be accessed using e.g. <code>get(tTime)</code> in formulas and filters</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="models.html#cb116-1" aria-hidden="true" tabindex="-1"></a>tTime <span class="ot">&lt;-</span> <span class="st">&quot;threeMonth_sumTScaled&quot;</span></span>
<span id="cb116-2"><a href="models.html#cb116-2" aria-hidden="true" tabindex="-1"></a>fTime <span class="ot">&lt;-</span> <span class="st">&quot;threeMonth_sumFScaled&quot;</span> <span class="co">#&quot;fiveMonth_sumFScaled&quot;</span></span></code></pre></div>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="models.html#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb117-2"><a href="models.html#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(relaimpo)</span>
<span id="cb117-3"><a href="models.html#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="models.html#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="models.html#cb117-5" aria-hidden="true" tabindex="-1"></a>modLM1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime) <span class="sc">*</span> <span class="fu">get</span>(fTime) <span class="sc">*</span> ydayScaled <span class="sc">*</span> count_Scaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-6"><a href="models.html#cb117-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-7"><a href="models.html#cb117-7" aria-hidden="true" tabindex="-1"></a>modLM2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-8"><a href="models.html#cb117-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-9"><a href="models.html#cb117-9" aria-hidden="true" tabindex="-1"></a>modLM3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled)<span class="sc">^</span><span class="dv">2</span>, <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-10"><a href="models.html#cb117-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-11"><a href="models.html#cb117-11" aria-hidden="true" tabindex="-1"></a>modLM1a <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species)), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-12"><a href="models.html#cb117-12" aria-hidden="true" tabindex="-1"></a>modLM1b <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime)), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-13"><a href="models.html#cb117-13" aria-hidden="true" tabindex="-1"></a>modLM1c <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(fTime)), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-14"><a href="models.html#cb117-14" aria-hidden="true" tabindex="-1"></a>modLM1d <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> ydayScaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-15"><a href="models.html#cb117-15" aria-hidden="true" tabindex="-1"></a>modLM1e <span class="ot">&lt;-</span> <span class="fu">lm</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> count_Scaled), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb117-16"><a href="models.html#cb117-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-17"><a href="models.html#cb117-17" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(modLM1, modLM2, modLM3, modLM1a, modLM1b, modLM1c, modLM1d, modLM1e) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(AIC)</span></code></pre></div>
<pre><code>##         df      AIC
## modLM1  33 61643.33
## modLM3  17 61807.67
## modLM2   7 62669.02
## modLM1c  5 63224.10
## modLM1e  5 63624.09
## modLM1d  5 63755.95
## modLM1b  5 63777.11
## modLM1a  3 63918.49</code></pre>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="models.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co">#relaimpo::calc.relimp(modLM2) # slow for bigger models</span></span>
<span id="cb119-2"><a href="models.html#cb119-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-3"><a href="models.html#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="models.html#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="co"># get &#39;boundary (singular)&#39; error with model without 2-way interaction</span></span>
<span id="cb119-5"><a href="models.html#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co">#modLMER2 &lt;- lmer(observedLength ~ (factor(species) + emerge_detect_sumTScaled + emerge_detect_sumFScaled + ydayScaled +count_Scaled)^2 + 1|year, data = d_WB_BKT_BNT)</span></span></code></pre></div>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="models.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co">#https://gist.github.com/BERENZ/e9b581a4b7160357934e</span></span>
<span id="cb120-2"><a href="models.html#cb120-2" aria-hidden="true" tabindex="-1"></a>calc.relip.mm <span class="ot">&lt;-</span> <span class="cf">function</span>(model,<span class="at">type=</span><span class="st">&#39;lmg&#39;</span>) {</span>
<span id="cb120-3"><a href="models.html#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">isLMM</span>(model) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">isGLMM</span>(model)) {</span>
<span id="cb120-4"><a href="models.html#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">&#39;Currently supports only lmer/glmer objects&#39;</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb120-5"><a href="models.html#cb120-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb120-6"><a href="models.html#cb120-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">require</span>(lme4)</span>
<span id="cb120-7"><a href="models.html#cb120-7" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">getME</span>(model,<span class="st">&#39;X&#39;</span>)</span>
<span id="cb120-8"><a href="models.html#cb120-8" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> X[,<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb120-9"><a href="models.html#cb120-9" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">getME</span>(model,<span class="st">&#39;y&#39;</span>)</span>
<span id="cb120-10"><a href="models.html#cb120-10" aria-hidden="true" tabindex="-1"></a>  s_resid <span class="ot">&lt;-</span> <span class="fu">sigma</span>(model)</span>
<span id="cb120-11"><a href="models.html#cb120-11" aria-hidden="true" tabindex="-1"></a>  s_effect <span class="ot">&lt;-</span> <span class="fu">getME</span>(model,<span class="st">&#39;theta&#39;</span>)<span class="sc">*</span>s_resid</span>
<span id="cb120-12"><a href="models.html#cb120-12" aria-hidden="true" tabindex="-1"></a>  s2 <span class="ot">&lt;-</span> <span class="fu">sum</span>(s_resid<span class="sc">^</span><span class="dv">2</span>,s_effect<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb120-13"><a href="models.html#cb120-13" aria-hidden="true" tabindex="-1"></a>  V <span class="ot">&lt;-</span> <span class="fu">Diagonal</span>(<span class="at">x =</span> s2,<span class="at">n=</span><span class="fu">nrow</span>(X))</span>
<span id="cb120-14"><a href="models.html#cb120-14" aria-hidden="true" tabindex="-1"></a>  YX <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Y,X)</span>
<span id="cb120-15"><a href="models.html#cb120-15" aria-hidden="true" tabindex="-1"></a>  cov_XY <span class="ot">&lt;-</span> <span class="fu">solve</span>( <span class="fu">t</span>(YX) <span class="sc">%*%</span> <span class="fu">solve</span>(V) <span class="sc">%*%</span> <span class="fu">as.matrix</span>(YX))</span>
<span id="cb120-16"><a href="models.html#cb120-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(cov_XY) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(cov_XY) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(YX)</span>
<span id="cb120-17"><a href="models.html#cb120-17" aria-hidden="true" tabindex="-1"></a>  importances <span class="ot">&lt;-</span> <span class="fu">calc.relimp</span>(<span class="fu">as.matrix</span>(cov_XY),<span class="at">rela=</span>T,<span class="at">type=</span>type)</span>
<span id="cb120-18"><a href="models.html#cb120-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(importances)</span>
<span id="cb120-19"><a href="models.html#cb120-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="models.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">#modLMER1 &lt;- lmer(observedLength ~ (factor(species) + get(tTime)|year + get(fTime)|year + ydayScaled|year + count_Scaled|year), data = d_WB_BKT_BNT)</span></span>
<span id="cb121-2"><a href="models.html#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="models.html#cb121-3" aria-hidden="true" tabindex="-1"></a>modLMER1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime) <span class="sc">*</span> <span class="fu">get</span>(fTime) <span class="sc">*</span> ydayScaled <span class="sc">*</span> count_Scaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-4"><a href="models.html#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="models.html#cb121-5" aria-hidden="true" tabindex="-1"></a>modLMER2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-6"><a href="models.html#cb121-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-7"><a href="models.html#cb121-7" aria-hidden="true" tabindex="-1"></a>modLMER3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">+</span> <span class="fu">get</span>(tTime) <span class="sc">+</span> <span class="fu">get</span>(fTime) <span class="sc">+</span> ydayScaled <span class="sc">+</span> count_Scaled)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-8"><a href="models.html#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="models.html#cb121-9" aria-hidden="true" tabindex="-1"></a><span class="co"># one-by-one</span></span>
<span id="cb121-10"><a href="models.html#cb121-10" aria-hidden="true" tabindex="-1"></a>modLMER1a <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species))  <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-11"><a href="models.html#cb121-11" aria-hidden="true" tabindex="-1"></a>modLMER1b <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(tTime))  <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-12"><a href="models.html#cb121-12" aria-hidden="true" tabindex="-1"></a>modLMER1c <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> <span class="fu">get</span>(fTime)) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-13"><a href="models.html#cb121-13" aria-hidden="true" tabindex="-1"></a>modLMER1d <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> ydayScaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-14"><a href="models.html#cb121-14" aria-hidden="true" tabindex="-1"></a>modLMER1e <span class="ot">&lt;-</span> <span class="fu">lmer</span>(observedLength <span class="sc">~</span> (<span class="fu">factor</span>(species) <span class="sc">*</span> count_Scaled) <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> d_WB_BKT_BNT)</span>
<span id="cb121-15"><a href="models.html#cb121-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-16"><a href="models.html#cb121-16" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(modLMER1, modLMER2, modLMER3, modLMER1a, modLMER1b, modLMER1c, modLMER1d, modLMER1e) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(AIC)</span></code></pre></div>
<pre><code>##           df      AIC
## modLMER1  34 61236.76
## modLMER3  18 61411.21
## modLMER1d  6 61466.63
## modLMER2   8 61470.46
## modLMER1e  6 61471.21
## modLMER1c  6 61472.64
## modLMER1b  6 61473.34
## modLMER1a  4 61475.77</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="models.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">calc.relip.mm</span>(modLMER3)</span></code></pre></div>
<pre><code>## Response variable: Y 
## Total response variance: 3.893283e-05 
## 
## 15 Regressors: 
## factor(species)bnt get(tTime) get(fTime) ydayScaled count_Scaled factor(species)bnt:get(tTime) factor(species)bnt:get(fTime) factor(species)bnt:ydayScaled factor(species)bnt:count_Scaled get(tTime):get(fTime) get(tTime):ydayScaled get(tTime):count_Scaled get(fTime):ydayScaled get(fTime):count_Scaled ydayScaled:count_Scaled 
## Proportion of variance explained by model: 94.15%
## Metrics are normalized to sum to 100% (rela=TRUE). 
## 
## Relative importance metrics: 
## 
##                                         lmg
## factor(species)bnt              0.097760307
## get(tTime)                      0.419878608
## get(fTime)                      0.092676088
## ydayScaled                      0.033569860
## count_Scaled                    0.078624107
## factor(species)bnt:get(tTime)   0.065441939
## factor(species)bnt:get(fTime)   0.012771321
## factor(species)bnt:ydayScaled   0.001781329
## factor(species)bnt:count_Scaled 0.019728183
## get(tTime):get(fTime)           0.071941193
## get(tTime):ydayScaled           0.029205652
## get(tTime):count_Scaled         0.041529196
## get(fTime):ydayScaled           0.011797805
## get(fTime):count_Scaled         0.012243731
## ydayScaled:count_Scaled         0.011050681
## 
## Average coefficients for different model sizes: 
## 
##                                            1X           2Xs           3Xs           4Xs           5Xs           6Xs
## factor(species)bnt              -0.0054984017 -0.0050704814 -0.0047545824 -0.0045389793 -0.0044124337 -4.364877e-03
## get(tTime)                      -0.0065705658 -0.0064807310 -0.0063924113 -0.0063084199 -0.0062305836 -6.159911e-03
## get(fTime)                      -0.0086478481 -0.0078930543 -0.0071804983 -0.0065359969 -0.0059811793 -5.531536e-03
## ydayScaled                       0.0031793857  0.0027052187  0.0022831959  0.0019197886  0.0016131058  1.358765e-03
## count_Scaled                    -0.0083583700 -0.0078052106 -0.0072775852 -0.0068141491 -0.0064372666 -6.153114e-03
## factor(species)bnt:get(tTime)    0.0025119506  0.0020567879  0.0016471742  0.0012672530  0.0009056673  5.550952e-04
## factor(species)bnt:get(fTime)    0.0060183654  0.0047218822  0.0036288022  0.0027025061  0.0019065191  1.208199e-03
## factor(species)bnt:ydayScaled   -0.0002196817 -0.0002660699 -0.0003114297 -0.0003574487 -0.0004026767 -4.443192e-04
## factor(species)bnt:count_Scaled  0.0067855005  0.0051864389  0.0038694571  0.0027807734  0.0018716941  1.101015e-03
## get(tTime):get(fTime)            0.0032931088  0.0027736154  0.0023758016  0.0020597885  0.0017908497  1.540839e-03
## get(tTime):ydayScaled           -0.0013525912 -0.0010122936 -0.0007224178 -0.0004705386 -0.0002496660 -5.582531e-05
## get(tTime):count_Scaled          0.0023356306  0.0018431949  0.0014769807  0.0011882760  0.0009424538  7.171659e-04
## get(fTime):ydayScaled           -0.0024680341 -0.0027398874 -0.0028756456 -0.0029246083 -0.0029130457 -2.855016e-03
## get(fTime):count_Scaled          0.0011703243 -0.0002162869 -0.0012391144 -0.0020246858 -0.0026437455 -3.130556e-03
## ydayScaled:count_Scaled         -0.0060601403 -0.0042294345 -0.0028505144 -0.0018549978 -0.0011694592 -7.240908e-04
##                                           7Xs           8Xs           9Xs          10Xs          11Xs          12Xs
## factor(species)bnt              -0.0043881071 -4.475745e-03 -0.0046223344 -0.0048218598 -5.066310e-03 -5.345099e-03
## get(tTime)                      -0.0060966732 -6.040385e-03 -0.0059898316 -0.0059432666 -5.898799e-03 -5.854907e-03
## get(fTime)                      -0.0051950013 -4.970278e-03 -0.0048458768 -0.0048005235 -4.804691e-03 -4.822743e-03
## ydayScaled                       0.0011534566  9.968974e-04  0.0008927463  0.0008487173  8.757443e-04  9.858444e-04
## count_Scaled                    -0.0059544293 -5.824393e-03 -0.0057402718 -0.0056771394 -5.612643e-03 -5.533014e-03
## factor(species)bnt:get(tTime)    0.0002111539 -1.287035e-04 -0.0004659555 -0.0008012831 -1.134412e-03 -1.463815e-03
## factor(species)bnt:get(fTime)    0.0005806889  3.882144e-06 -0.0005343247 -0.0010365233 -1.495172e-03 -1.894321e-03
## factor(species)bnt:ydayScaled   -0.0004787153 -5.010271e-04 -0.0005046357 -0.0004807007 -4.185323e-04 -3.073680e-04
## factor(species)bnt:count_Scaled  0.0004359225 -1.482176e-04 -0.0006682334 -0.0011336990 -1.548402e-03 -1.913621e-03
## get(tTime):get(fTime)            0.0012890129  1.022548e-03  0.0007363939  0.0004323806  1.179063e-04 -1.953488e-04
## get(tTime):ydayScaled            0.0001139192  2.627106e-04  0.0003945425  0.0005145068  6.287198e-04  7.438227e-04
## get(tTime):count_Scaled          0.0005002465  2.873275e-04  0.0000795192 -0.0001188814 -3.028894e-04 -4.695265e-04
## get(fTime):ydayScaled           -0.0027585842 -2.629436e-03 -0.0024725885 -0.0022926181 -2.093092e-03 -1.875890e-03
## get(fTime):count_Scaled         -0.0034980296 -3.748389e-03 -0.0038800558 -0.0038917388 -3.784748e-03 -3.564784e-03
## ydayScaled:count_Scaled         -0.0004553432 -3.058715e-04 -0.0002237541 -0.0001619201 -7.825575e-05  6.336058e-05
##                                          13Xs          14Xs          15Xs
## factor(species)bnt              -0.0056461457 -5.959040e-03 -0.0062796744
## get(tTime)                      -0.0058109959 -5.767910e-03 -0.0057282815
## get(fTime)                      -0.0048158521 -4.746171e-03 -0.0045799533
## ydayScaled                       0.0011888137  1.489186e-03  0.0018864288
## count_Scaled                    -0.0054389891 -5.349606e-03 -0.0053039170
## factor(species)bnt:get(tTime)   -0.0017867916 -2.100436e-03 -0.0024036120
## factor(species)bnt:get(fTime)   -0.0022142922 -2.438114e-03 -0.0025565105
## factor(species)bnt:ydayScaled   -0.0001392003  8.910015e-05  0.0003764257
## factor(species)bnt:count_Scaled -0.0022331996 -2.519186e-03 -0.0027966124
## get(tTime):get(fTime)           -0.0004927221 -7.584234e-04 -0.0009773304
## get(tTime):ydayScaled            0.0008660298  1.000118e-03  0.0011493099
## get(tTime):count_Scaled         -0.0006202278 -7.623248e-04 -0.0009098491
## get(fTime):ydayScaled           -0.0016406077 -1.384448e-03 -0.0011021992
## get(fTime):count_Scaled         -0.0032439647 -2.841580e-03 -0.0023829029
## ydayScaled:count_Scaled          0.0002913468  6.252846e-04  0.0010782461</code></pre>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="models.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MuMIn)</span>
<span id="cb125-2"><a href="models.html#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">r.squaredGLMM</span>(modLMER1)</span></code></pre></div>
<pre><code>##            R2m       R2c
## [1,] 0.2001733 0.6185189</code></pre>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="models.html#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(modLMER1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: observedLength ~ (factor(species) * get(tTime) * get(fTime) *      ydayScaled * count_Scaled) + (1 | year)
##    Data: d_WB_BKT_BNT
## 
## REML criterion at convergence: 61168.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.4018 -0.6876 -0.0288  0.6436  6.6810 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  year     (Intercept) 85.83    9.264   
##  Residual             78.27    8.847   
## Number of obs: 8499, groups:  year, 16
## 
## Fixed effects:
##                                                                  Estimate Std. Error t value
## (Intercept)                                                       80.8481     4.1701  19.388
## factor(species)bnt                                                -4.9284     1.4042  -3.510
## get(tTime)                                                       -21.6554     7.2622  -2.982
## get(fTime)                                                         9.4220     4.0516   2.325
## ydayScaled                                                        -4.0731     2.7473  -1.483
## count_Scaled                                                      -6.0394     4.2307  -1.427
## factor(species)bnt:get(tTime)                                     12.0455     2.5799   4.669
## factor(species)bnt:get(fTime)                                      0.3451     1.5233   0.227
## get(tTime):get(fTime)                                            -16.8596     7.6738  -2.197
## factor(species)bnt:ydayScaled                                      0.6682     3.0523   0.219
## get(tTime):ydayScaled                                              1.0575     5.4994   0.192
## get(fTime):ydayScaled                                             -9.3848     2.6598  -3.528
## factor(species)bnt:count_Scaled                                    0.8883     1.0017   0.887
## get(tTime):count_Scaled                                           13.6476     9.5497   1.429
## get(fTime):count_Scaled                                          -15.7569     3.8771  -4.064
## ydayScaled:count_Scaled                                            9.2820     2.0254   4.583
## factor(species)bnt:get(tTime):get(fTime)                          -7.3923     3.1937  -2.315
## factor(species)bnt:get(tTime):ydayScaled                           2.1106     6.5449   0.322
## factor(species)bnt:get(fTime):ydayScaled                          -0.9930     2.7942  -0.355
## get(tTime):get(fTime):ydayScaled                                  10.3113     5.9959   1.720
## factor(species)bnt:get(tTime):count_Scaled                        -2.1328     2.5544  -0.835
## factor(species)bnt:get(fTime):count_Scaled                         6.4230     1.8794   3.418
## get(tTime):get(fTime):count_Scaled                                18.3310     9.7834   1.874
## factor(species)bnt:ydayScaled:count_Scaled                        -5.4154     2.0331  -2.664
## get(tTime):ydayScaled:count_Scaled                               -18.1465     5.1346  -3.534
## get(fTime):ydayScaled:count_Scaled                                 5.0809     2.7461   1.850
## factor(species)bnt:get(tTime):get(fTime):ydayScaled                6.9942     7.1420   0.979
## factor(species)bnt:get(tTime):get(fTime):count_Scaled            -16.6416     4.1143  -4.045
## factor(species)bnt:get(tTime):ydayScaled:count_Scaled             12.3811     5.7403   2.157
## factor(species)bnt:get(fTime):ydayScaled:count_Scaled              0.8281     3.2880   0.252
## get(tTime):get(fTime):ydayScaled:count_Scaled                    -15.0936     7.8332  -1.927
## factor(species)bnt:get(tTime):get(fTime):ydayScaled:count_Scaled   0.3270     9.4661   0.035</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="models.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ranef</span>(modLMER1)</span></code></pre></div>
<pre><code>## $year
##      (Intercept)
## 2000   8.8500565
## 2001  -8.4985347
## 2002  -7.3323965
## 2003  -1.5660312
## 2004  -5.1466870
## 2005  -1.0172900
## 2006   3.5989690
## 2007  10.3090430
## 2008  -0.7230606
## 2009   6.7853759
## 2010   5.6472890
## 2011 -21.6975629
## 2012  -3.4055069
## 2013   9.6487802
## 2014   4.0152310
## 2015   0.5323252
## 
## with conditional variances for &quot;year&quot;</code></pre>
<p>Raw data exploration following the models</p>
<p>relaimpo::calc.relimp(modLM2) - other models are too big
lmg
factor(species) 0.005339423
emerge_detect_sumTScaled 0.006883496
emerge_detect_sumFScaled 0.063450197
ydayScaled 0.012116064
count_Scaled 0.028031531</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="models.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(<span class="fu">get</span>(fTime), observedLength)) <span class="sc">+</span></span>
<span id="cb131-2"><a href="models.html#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb131-3"><a href="models.html#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb131-4"><a href="models.html#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-1.png" width="672" /></p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="models.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(count_Scaled, observedLength)) <span class="sc">+</span></span>
<span id="cb132-2"><a href="models.html#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb132-3"><a href="models.html#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-4"><a href="models.html#cb132-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-2.png" width="672" /></p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="models.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(ydayScaled, observedLength)) <span class="sc">+</span></span>
<span id="cb133-2"><a href="models.html#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb133-3"><a href="models.html#cb133-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb133-4"><a href="models.html#cb133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-3.png" width="672" /></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="models.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d_WB_BKT_BNT, <span class="fu">aes</span>(<span class="fu">get</span>(tTime), observedLength)) <span class="sc">+</span></span>
<span id="cb134-2"><a href="models.html#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb134-3"><a href="models.html#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span></span>
<span id="cb134-4"><a href="models.html#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>species)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/plotRawInd-4.png" width="672" /></p>

</div>
</div>
</div>
<div id="modelFlow" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Flow model<a href="models.html#modelFlow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="models.html#cb135-1" aria-hidden="true" tabindex="-1"></a>dataFlow <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./dataIn/wbFlow/EcoDrought_Continuous_MA.csv&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="models.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(dataFlow)</span></code></pre></div>
<pre><code>## # A tibble: 582,388 × 9
##    Station_No Site_Name   DateTime_EST   GageHeight_Hobo_ft Discharge_Hobo_cfs WaterTemperature_HOBO_DegF AirPressure_PSI AirTemperature_HOBO_de… X    
##         &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;                       &lt;dbl&gt;              &lt;dbl&gt;                      &lt;dbl&gt;           &lt;dbl&gt;                   &lt;dbl&gt; &lt;lgl&gt;
##  1    1171000 Avery Brook 2/20/2020 0:00               4.17               5.37                       32.0              NA                      NA NA   
##  2    1171000 Avery Brook 2/20/2020 0:15               4.17               5.3                        32.0              NA                      NA NA   
##  3    1171000 Avery Brook 2/20/2020 0:30               4.16               5.17                       32.0              NA                      NA NA   
##  4    1171000 Avery Brook 2/20/2020 0:45               4.17               5.27                       32.0              NA                      NA NA   
##  5    1171000 Avery Brook 2/20/2020 1:00               4.17               5.3                        32.0              NA                      NA NA   
##  6    1171000 Avery Brook 2/20/2020 1:15               4.15               4.94                       31.9              NA                      NA NA   
##  7    1171000 Avery Brook 2/20/2020 1:30               4.13               4.56                       31.9              NA                      NA NA   
##  8    1171000 Avery Brook 2/20/2020 1:45               4.1                4.14                       31.9              NA                      NA NA   
##  9    1171000 Avery Brook 2/20/2020 2:00               4.08               3.84                       31.9              NA                      NA NA   
## 10    1171000 Avery Brook 2/20/2020 2:15               4.09               4.02                       31.9              NA                      NA NA   
## # … with 582,378 more rows</code></pre>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="models.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dataFlow<span class="sc">$</span>Site_Name)</span></code></pre></div>
<pre><code>## 
##          Avery Brook          Jimmy Brook       Mitchell Brook    Obear Brook Lower      Sanderson Brook         West Brook 0     West Brook Lower 
##                56536                57849                56978                60392                55336                58548                61279 
## West Brook Reservoir     West Brook Upper   West Whately Brook 
##                61059                57301                57110</code></pre>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="models.html#cb140-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> dataFlow <span class="sc">%&gt;%</span></span>
<span id="cb140-2"><a href="models.html#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Site_Name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Jimmy Brook&quot;</span>, <span class="st">&quot;Mitchell Brook&quot;</span>, <span class="st">&quot;Obear Brook Lower&quot;</span>, <span class="st">&quot;West Brook 0&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb140-3"><a href="models.html#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">mdy_hm</span>(DateTime_EST),</span>
<span id="cb140-4"><a href="models.html#cb140-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">site =</span> <span class="fu">recode</span>(Site_Name, <span class="st">&quot;Jimmy Brook&quot;</span> <span class="ot">=</span> <span class="st">&quot;OL&quot;</span>, <span class="st">&quot;Mitchell Brook&quot;</span> <span class="ot">=</span> <span class="st">&quot;OS&quot;</span>, <span class="st">&quot;Obear Brook Lower&quot;</span> <span class="ot">=</span> <span class="st">&quot;IS&quot;</span>, <span class="st">&quot;West Brook 0&quot;</span> <span class="ot">=</span> <span class="st">&quot;WB&quot;</span>),</span>
<span id="cb140-5"><a href="models.html#cb140-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">dischargeLog =</span> <span class="fu">log</span>(Discharge_Hobo_cfs <span class="sc">+</span> <span class="fl">0.01</span>))</span>
<span id="cb140-6"><a href="models.html#cb140-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-7"><a href="models.html#cb140-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-8"><a href="models.html#cb140-8" aria-hidden="true" tabindex="-1"></a>d <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">is.infinite</span>(dischargeLog))</span></code></pre></div>
<pre><code>##  [1] Station_No                 Site_Name                  DateTime_EST               GageHeight_Hobo_ft         Discharge_Hobo_cfs        
##  [6] WaterTemperature_HOBO_DegF AirPressure_PSI            AirTemperature_HOBO_degF   X                          date                      
## [11] site                       dischargeLog              
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="models.html#cb142-1" aria-hidden="true" tabindex="-1"></a>scaleCol <span class="ot">&lt;-</span> <span class="cf">function</span>(d){</span>
<span id="cb142-2"><a href="models.html#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (d <span class="sc">-</span> <span class="fu">mean</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span> <span class="fu">sd</span>(d, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb142-3"><a href="models.html#cb142-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb142-4"><a href="models.html#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="co"># hard-coded for now</span></span>
<span id="cb142-5"><a href="models.html#cb142-5" aria-hidden="true" tabindex="-1"></a>dWide <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> </span>
<span id="cb142-6"><a href="models.html#cb142-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> date, </span>
<span id="cb142-7"><a href="models.html#cb142-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> dischargeLog, </span>
<span id="cb142-8"><a href="models.html#cb142-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> site</span>
<span id="cb142-9"><a href="models.html#cb142-9" aria-hidden="true" tabindex="-1"></a>             ) <span class="sc">%&gt;%</span></span>
<span id="cb142-10"><a href="models.html#cb142-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb142-11"><a href="models.html#cb142-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">OLScaled =</span> <span class="fu">scaleCol</span>(OL),</span>
<span id="cb142-12"><a href="models.html#cb142-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">ISScaled =</span> <span class="fu">scaleCol</span>(IS),</span>
<span id="cb142-13"><a href="models.html#cb142-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">OSScaled =</span> <span class="fu">scaleCol</span>(OS),</span>
<span id="cb142-14"><a href="models.html#cb142-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">WBScaled =</span> <span class="fu">scaleCol</span>(WB),</span>
<span id="cb142-15"><a href="models.html#cb142-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">yday =</span> <span class="fu">yday</span>(date),</span>
<span id="cb142-16"><a href="models.html#cb142-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">year</span>(date)</span>
<span id="cb142-17"><a href="models.html#cb142-17" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="models.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d, <span class="fu">aes</span>(date, dischargeLog, <span class="at">color =</span> Site_Name)) <span class="sc">+</span></span>
<span id="cb143-2"><a href="models.html#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.02</span>) <span class="sc">+</span></span>
<span id="cb143-3"><a href="models.html#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Site_Name)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-1.png" width="672" /></p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="models.html#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(dWide,</span>
<span id="cb144-2"><a href="models.html#cb144-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb144-3"><a href="models.html#cb144-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(year), <span class="at">alpha =</span> <span class="fl">0.7</span>),</span>
<span id="cb144-4"><a href="models.html#cb144-4" aria-hidden="true" tabindex="-1"></a>          <span class="co">#diag = list(continuous = myDens),</span></span>
<span id="cb144-5"><a href="models.html#cb144-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">&quot;points&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size=</span><span class="fl">0.1</span>), </span>
<span id="cb144-6"><a href="models.html#cb144-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">combo =</span> <span class="fu">wrap</span>(<span class="st">&quot;dot&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.2</span>))</span>
<span id="cb144-7"><a href="models.html#cb144-7" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-2.png" width="672" /></p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="models.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(dWide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(yday <span class="sc">&gt;</span> <span class="dv">90</span>, yday <span class="sc">&lt;</span> <span class="dv">300</span>),</span>
<span id="cb145-2"><a href="models.html#cb145-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb145-3"><a href="models.html#cb145-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(year)),</span>
<span id="cb145-4"><a href="models.html#cb145-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">&quot;points&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size=</span><span class="fl">0.1</span>), </span>
<span id="cb145-5"><a href="models.html#cb145-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">combo =</span> <span class="fu">wrap</span>(<span class="st">&quot;dot&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.2</span>))</span>
<span id="cb145-6"><a href="models.html#cb145-6" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-3.png" width="672" /></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="models.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(dWide <span class="sc">%&gt;%</span> <span class="fu">filter</span>(yday <span class="sc">==</span> <span class="dv">110</span>),</span>
<span id="cb146-2"><a href="models.html#cb146-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">columns =</span> <span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>,</span>
<span id="cb146-3"><a href="models.html#cb146-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.factor</span>(year)),</span>
<span id="cb146-4"><a href="models.html#cb146-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">lower =</span> <span class="fu">list</span>(<span class="at">continuous =</span> <span class="fu">wrap</span>(<span class="st">&quot;points&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size=</span><span class="fl">0.2</span>), </span>
<span id="cb146-5"><a href="models.html#cb146-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">combo =</span> <span class="fu">wrap</span>(<span class="st">&quot;dot&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">size=</span><span class="fl">0.2</span>))</span>
<span id="cb146-6"><a href="models.html#cb146-6" aria-hidden="true" tabindex="-1"></a>        )</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/flowPlots-4.png" width="672" /></p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="models.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">#mod0 &lt;- lmer(OL ~ WB * yday + as.factor(year) + 1|yday, data = dWide)</span></span></code></pre></div>

</div>
<div id="modelCMR_Flow_River_OBear" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Flow effects on survival (phi) models - O’Bear only<a href="models.html#modelCMR_Flow_River_OBear" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The goal of this modelling exercise is to evaluate the effect of new tributary-specific stream flow estimates on survival of brook trout and brown trout. We will compare survival across the WB and tributaries with flow input data as 1) single flow estimate for all locations (historical approach) and 2) hindcasted flows for each tributary based on new tributary-specific flows which are available since 2000.</p>
<p>The goal is to find the best structure for the survival model, then compare survival estimates with tributary-specific flow to estimates with common flow across locations.</p>
<p>Structure options include
[species, cohort, season, isYOY, flow, flow^2]</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="models.html#cb148-1" aria-hidden="true" tabindex="-1"></a>rerunSurivalModels <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb148-2"><a href="models.html#cb148-2" aria-hidden="true" tabindex="-1"></a>plotMCMCOutput <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="models.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/dataOut/eh_2002200320042005200620072008200920102011201220132014_wb obear.RData&#39;</span>)</span></code></pre></div>
<div id="model-phi_p" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Model phi_p<a href="models.html#model-phi_p" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Single estimates of phi and p (across, time, cohorts, flow)</p>
<div id="set-up-and-run-model" class="section level4 hasAnchor" number="3.3.1.1">
<h4><span class="header-section-number">3.3.1.1</span> Set up and run model<a href="models.html#set-up-and-run-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="models.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb150-2"><a href="models.html#cb150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-3"><a href="models.html#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb150-4"><a href="models.html#cb150-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb150-5"><a href="models.html#cb150-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-6"><a href="models.html#cb150-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb150-7"><a href="models.html#cb150-7" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb150-8"><a href="models.html#cb150-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-9"><a href="models.html#cb150-9" aria-hidden="true" tabindex="-1"></a>  hmm.phi_p <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb150-10"><a href="models.html#cb150-10" aria-hidden="true" tabindex="-1"></a>    phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior survival</span></span>
<span id="cb150-11"><a href="models.html#cb150-11" aria-hidden="true" tabindex="-1"></a>    p <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="co"># prior detection</span></span>
<span id="cb150-12"><a href="models.html#cb150-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb150-13"><a href="models.html#cb150-13" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> phi      <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb150-14"><a href="models.html#cb150-14" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi  <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb150-15"><a href="models.html#cb150-15" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb150-16"><a href="models.html#cb150-16" aria-hidden="true" tabindex="-1"></a>    gamma[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb150-17"><a href="models.html#cb150-17" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb150-18"><a href="models.html#cb150-18" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb150-19"><a href="models.html#cb150-19" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">1</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p    <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb150-20"><a href="models.html#cb150-20" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">1</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> p        <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb150-21"><a href="models.html#cb150-21" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">2</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb150-22"><a href="models.html#cb150-22" aria-hidden="true" tabindex="-1"></a>    omega[<span class="dv">2</span>,<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>        <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb150-23"><a href="models.html#cb150-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-24"><a href="models.html#cb150-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb150-25"><a href="models.html#cb150-25" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb150-26"><a href="models.html#cb150-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb150-27"><a href="models.html#cb150-27" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb150-28"><a href="models.html#cb150-28" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb150-29"><a href="models.html#cb150-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb150-30"><a href="models.html#cb150-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb150-31"><a href="models.html#cb150-31" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb150-32"><a href="models.html#cb150-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb150-33"><a href="models.html#cb150-33" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb150-34"><a href="models.html#cb150-34" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb150-35"><a href="models.html#cb150-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-36"><a href="models.html#cb150-36" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb150-37"><a href="models.html#cb150-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb150-38"><a href="models.html#cb150-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb150-39"><a href="models.html#cb150-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last)</span>
<span id="cb150-40"><a href="models.html#cb150-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-41"><a href="models.html#cb150-41" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb150-42"><a href="models.html#cb150-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-43"><a href="models.html#cb150-43" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb150-44"><a href="models.html#cb150-44" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb150-45"><a href="models.html#cb150-45" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">phi =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb150-46"><a href="models.html#cb150-46" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">p =</span> <span class="fu">runif</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb150-47"><a href="models.html#cb150-47" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">z =</span> zinits</span>
<span id="cb150-48"><a href="models.html#cb150-48" aria-hidden="true" tabindex="-1"></a>                                    )</span>
<span id="cb150-49"><a href="models.html#cb150-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-50"><a href="models.html#cb150-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-51"><a href="models.html#cb150-51" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>)  </span>
<span id="cb150-52"><a href="models.html#cb150-52" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb150-53"><a href="models.html#cb150-53" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb150-54"><a href="models.html#cb150-54" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb150-55"><a href="models.html#cb150-55" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb150-56"><a href="models.html#cb150-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-57"><a href="models.html#cb150-57" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb150-58"><a href="models.html#cb150-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-59"><a href="models.html#cb150-59" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb150-60"><a href="models.html#cb150-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phi_p, </span>
<span id="cb150-61"><a href="models.html#cb150-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb150-62"><a href="models.html#cb150-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb150-63"><a href="models.html#cb150-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb150-64"><a href="models.html#cb150-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb150-65"><a href="models.html#cb150-65" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb150-66"><a href="models.html#cb150-66" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb150-67"><a href="models.html#cb150-67" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb150-68"><a href="models.html#cb150-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb150-69"><a href="models.html#cb150-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb150-70"><a href="models.html#cb150-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-71"><a href="models.html#cb150-71" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb150-72"><a href="models.html#cb150-72" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb150-73"><a href="models.html#cb150-73" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb150-74"><a href="models.html#cb150-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-75"><a href="models.html#cb150-75" aria-hidden="true" tabindex="-1"></a>  mcmc.phi_p <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb150-76"><a href="models.html#cb150-76" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb150-77"><a href="models.html#cb150-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb150-78"><a href="models.html#cb150-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb150-79"><a href="models.html#cb150-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb150-80"><a href="models.html#cb150-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb150-81"><a href="models.html#cb150-81" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb150-82"><a href="models.html#cb150-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-83"><a href="models.html#cb150-83" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb150-84"><a href="models.html#cb150-84" aria-hidden="true" tabindex="-1"></a>  elapsed_phi_p <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb150-85"><a href="models.html#cb150-85" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb150-86"><a href="models.html#cb150-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phi_p, </span>
<span id="cb150-87"><a href="models.html#cb150-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phi_p,</span>
<span id="cb150-88"><a href="models.html#cb150-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phi_p&quot;</span>,</span>
<span id="cb150-89"><a href="models.html#cb150-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb150-90"><a href="models.html#cb150-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb150-91"><a href="models.html#cb150-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb150-92"><a href="models.html#cb150-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb150-93"><a href="models.html#cb150-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb150-94"><a href="models.html#cb150-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb150-95"><a href="models.html#cb150-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb150-96"><a href="models.html#cb150-96" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb150-97"><a href="models.html#cb150-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phi_p_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb150-98"><a href="models.html#cb150-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phi_p_mostRecent.RData&#39;</span>)</span>
<span id="cb150-99"><a href="models.html#cb150-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-100"><a href="models.html#cb150-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output for Xioawei</span></span>
<span id="cb150-101"><a href="models.html#cb150-101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(toSave)){</span>
<span id="cb150-102"><a href="models.html#cb150-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(toSave[[i]], <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/phi_p/&#39;</span>, </span>
<span id="cb150-103"><a href="models.html#cb150-103" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">names</span>(toSave)[i], </span>
<span id="cb150-104"><a href="models.html#cb150-104" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;.csv&quot;</span>), </span>
<span id="cb150-105"><a href="models.html#cb150-105" aria-hidden="true" tabindex="-1"></a>              <span class="at">row.names =</span> F)</span>
<span id="cb150-106"><a href="models.html#cb150-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb150-107"><a href="models.html#cb150-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="fu">MCMCsummary</span>(toSave<span class="sc">$</span>mcmc), <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/phi_p/mcmcSummary.csv&#39;</span>)</span>
<span id="cb150-108"><a href="models.html#cb150-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-109"><a href="models.html#cb150-109" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb150-110"><a href="models.html#cb150-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phi_p_mostRecent.RData&#39;</span>)</span>
<span id="cb150-111"><a href="models.html#cb150-111" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb150-112"><a href="models.html#cb150-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-113"><a href="models.html#cb150-113" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb150-114"><a href="models.html#cb150-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc)</span>
<span id="cb150-115"><a href="models.html#cb150-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCsummary</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">round =</span> <span class="dv">3</span>)</span>
<span id="cb150-116"><a href="models.html#cb150-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb150-117"><a href="models.html#cb150-117" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb150-118"><a href="models.html#cb150-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb150-119"><a href="models.html#cb150-119" aria-hidden="true" tabindex="-1"></a>            <span class="at">ISB =</span> <span class="cn">FALSE</span>,</span>
<span id="cb150-120"><a href="models.html#cb150-120" aria-hidden="true" tabindex="-1"></a>            <span class="at">exact =</span> <span class="cn">TRUE</span>, </span>
<span id="cb150-121"><a href="models.html#cb150-121" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>),</span>
<span id="cb150-122"><a href="models.html#cb150-122" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb150-123"><a href="models.html#cb150-123" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb150-124"><a href="models.html#cb150-124" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phi_p-1.png" width="672" /><img src="westBrook-book_files/figure-html/phi_p-2.png" width="672" /></p>
</div>
</div>
<div id="model-phit_pt" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Model phiT_pT<a href="models.html#model-phit_pt" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Phi and p vary by sampling occasion (time)</p>
<div id="set-up-and-run-model-1" class="section level4 hasAnchor" number="3.3.2.1">
<h4><span class="header-section-number">3.3.2.1</span> Set up and run model<a href="models.html#set-up-and-run-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="models.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb151-2"><a href="models.html#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb151-3"><a href="models.html#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="models.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb151-5"><a href="models.html#cb151-5" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb151-6"><a href="models.html#cb151-6" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb151-7"><a href="models.html#cb151-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-8"><a href="models.html#cb151-8" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb151-9"><a href="models.html#cb151-9" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb151-10"><a href="models.html#cb151-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb151-11"><a href="models.html#cb151-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb151-12"><a href="models.html#cb151-12" aria-hidden="true" tabindex="-1"></a>      phi[t] <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)           <span class="co"># prior survival</span></span>
<span id="cb151-13"><a href="models.html#cb151-13" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">1</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> phi[t]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb151-14"><a href="models.html#cb151-14" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">1</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb151-15"><a href="models.html#cb151-15" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">2</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb151-16"><a href="models.html#cb151-16" aria-hidden="true" tabindex="-1"></a>      gamma[<span class="dv">2</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb151-17"><a href="models.html#cb151-17" aria-hidden="true" tabindex="-1"></a>      p[t] <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)             <span class="co"># prior detection</span></span>
<span id="cb151-18"><a href="models.html#cb151-18" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">1</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb151-19"><a href="models.html#cb151-19" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">1</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> p[t]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb151-20"><a href="models.html#cb151-20" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">2</span>,<span class="dv">1</span>,t] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb151-21"><a href="models.html#cb151-21" aria-hidden="true" tabindex="-1"></a>      omega[<span class="dv">2</span>,<span class="dv">2</span>,t] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb151-22"><a href="models.html#cb151-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-23"><a href="models.html#cb151-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb151-24"><a href="models.html#cb151-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb151-25"><a href="models.html#cb151-25" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb151-26"><a href="models.html#cb151-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb151-27"><a href="models.html#cb151-27" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>])</span>
<span id="cb151-28"><a href="models.html#cb151-28" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>])</span>
<span id="cb151-29"><a href="models.html#cb151-29" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb151-30"><a href="models.html#cb151-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb151-31"><a href="models.html#cb151-31" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb151-32"><a href="models.html#cb151-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb151-33"><a href="models.html#cb151-33" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb151-34"><a href="models.html#cb151-34" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb151-35"><a href="models.html#cb151-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-36"><a href="models.html#cb151-36" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb151-37"><a href="models.html#cb151-37" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb151-38"><a href="models.html#cb151-38" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb151-39"><a href="models.html#cb151-39" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last)</span>
<span id="cb151-40"><a href="models.html#cb151-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-41"><a href="models.html#cb151-41" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb151-42"><a href="models.html#cb151-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-43"><a href="models.html#cb151-43" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb151-44"><a href="models.html#cb151-44" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb151-45"><a href="models.html#cb151-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-46"><a href="models.html#cb151-46" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(<span class="at">phi =</span> <span class="fu">runif</span>(myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb151-47"><a href="models.html#cb151-47" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">p =</span> <span class="fu">runif</span>(myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb151-48"><a href="models.html#cb151-48" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">z =</span> zinits)</span>
<span id="cb151-49"><a href="models.html#cb151-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-50"><a href="models.html#cb151-50" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;z&quot;</span>)  </span>
<span id="cb151-51"><a href="models.html#cb151-51" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb151-52"><a href="models.html#cb151-52" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb151-53"><a href="models.html#cb151-53" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb151-54"><a href="models.html#cb151-54" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb151-55"><a href="models.html#cb151-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-56"><a href="models.html#cb151-56" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb151-57"><a href="models.html#cb151-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-58"><a href="models.html#cb151-58" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb151-59"><a href="models.html#cb151-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT, </span>
<span id="cb151-60"><a href="models.html#cb151-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb151-61"><a href="models.html#cb151-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb151-62"><a href="models.html#cb151-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb151-63"><a href="models.html#cb151-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb151-64"><a href="models.html#cb151-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-65"><a href="models.html#cb151-65" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb151-66"><a href="models.html#cb151-66" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb151-67"><a href="models.html#cb151-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb151-68"><a href="models.html#cb151-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-69"><a href="models.html#cb151-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-70"><a href="models.html#cb151-70" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb151-71"><a href="models.html#cb151-71" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb151-72"><a href="models.html#cb151-72" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb151-73"><a href="models.html#cb151-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-74"><a href="models.html#cb151-74" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb151-75"><a href="models.html#cb151-75" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb151-76"><a href="models.html#cb151-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb151-77"><a href="models.html#cb151-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb151-78"><a href="models.html#cb151-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb151-79"><a href="models.html#cb151-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb151-80"><a href="models.html#cb151-80" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb151-81"><a href="models.html#cb151-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-82"><a href="models.html#cb151-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-83"><a href="models.html#cb151-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-84"><a href="models.html#cb151-84" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb151-85"><a href="models.html#cb151-85" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb151-86"><a href="models.html#cb151-86" aria-hidden="true" tabindex="-1"></a>    toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb151-87"><a href="models.html#cb151-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">mcmc =</span> mcmc.phiT_pT, </span>
<span id="cb151-88"><a href="models.html#cb151-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">elapsed =</span> elapsed_phiT_pT,</span>
<span id="cb151-89"><a href="models.html#cb151-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;phiT_pT&quot;</span>,</span>
<span id="cb151-90"><a href="models.html#cb151-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">myConstants =</span> myConstants, </span>
<span id="cb151-91"><a href="models.html#cb151-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">nIter =</span> nIter, </span>
<span id="cb151-92"><a href="models.html#cb151-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb151-93"><a href="models.html#cb151-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">thinRate =</span> thinRate, </span>
<span id="cb151-94"><a href="models.html#cb151-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb151-95"><a href="models.html#cb151-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb151-96"><a href="models.html#cb151-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">nChains =</span> nChains</span>
<span id="cb151-97"><a href="models.html#cb151-97" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb151-98"><a href="models.html#cb151-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb151-99"><a href="models.html#cb151-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_mostRecent.RData&#39;</span>)</span>
<span id="cb151-100"><a href="models.html#cb151-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-101"><a href="models.html#cb151-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output for Xioawei</span></span>
<span id="cb151-102"><a href="models.html#cb151-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(toSave)){</span>
<span id="cb151-103"><a href="models.html#cb151-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(toSave[[i]], <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/phiT_pT/&#39;</span>, </span>
<span id="cb151-104"><a href="models.html#cb151-104" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">names</span>(toSave)[i], </span>
<span id="cb151-105"><a href="models.html#cb151-105" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;.csv&quot;</span>), </span>
<span id="cb151-106"><a href="models.html#cb151-106" aria-hidden="true" tabindex="-1"></a>              <span class="at">row.names =</span> F)</span>
<span id="cb151-107"><a href="models.html#cb151-107" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb151-108"><a href="models.html#cb151-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(<span class="fu">MCMCsummary</span>(toSave<span class="sc">$</span>mcmc), <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/phiT_pT/mcmcSummary.csv&#39;</span>)</span>
<span id="cb151-109"><a href="models.html#cb151-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-110"><a href="models.html#cb151-110" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb151-111"><a href="models.html#cb151-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_mostRecent.RData&#39;</span>)</span>
<span id="cb151-112"><a href="models.html#cb151-112" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb151-113"><a href="models.html#cb151-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb151-114"><a href="models.html#cb151-114" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (plotMCMCOutput) {  </span>
<span id="cb151-115"><a href="models.html#cb151-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc)</span>
<span id="cb151-116"><a href="models.html#cb151-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCsummary</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">round =</span> <span class="dv">3</span>)</span>
<span id="cb151-117"><a href="models.html#cb151-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-118"><a href="models.html#cb151-118" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb151-119"><a href="models.html#cb151-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb151-120"><a href="models.html#cb151-120" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb151-121"><a href="models.html#cb151-121" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb151-122"><a href="models.html#cb151-122" aria-hidden="true" tabindex="-1"></a>            <span class="co">#params = c(&quot;phi[1]&quot;, &quot;phi[2]&quot;, &quot;phi[3]&quot;, &quot;phi[4]&quot;, &quot;phi[5]&quot;, &quot;phi[9]&quot;, &quot;phi[10]&quot;,</span></span>
<span id="cb151-123"><a href="models.html#cb151-123" aria-hidden="true" tabindex="-1"></a>            <span class="co">#           &quot;p[1]&quot;, &quot;p[2]&quot;, &quot;p[3]&quot;, &quot;p[4]&quot;, &quot;p[5]&quot;),</span></span>
<span id="cb151-124"><a href="models.html#cb151-124" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>),</span>
<span id="cb151-125"><a href="models.html#cb151-125" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb151-126"><a href="models.html#cb151-126" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb151-127"><a href="models.html#cb151-127" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT-5.png" width="672" /></p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="models.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">#meanPost &lt;- MCMCpstr(toSave$mcmc)</span></span>
<span id="cb152-2"><a href="models.html#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="co">#sdPost &lt;- MCMCpstr(toSave$mcmc, func = sd)</span></span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Model phiT_pT_cohort<a href="models.html#model-phit_pt_cohort" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Phi and p vary by time and there is a cohort effect on phi</p>
<div id="set-up-and-run-model-2" class="section level4 hasAnchor" number="3.3.3.1">
<h4><span class="header-section-number">3.3.3.1</span> Set up and run model<a href="models.html#set-up-and-run-model-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="models.html#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb153-2"><a href="models.html#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb153-3"><a href="models.html#cb153-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-4"><a href="models.html#cb153-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb153-5"><a href="models.html#cb153-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb153-6"><a href="models.html#cb153-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-7"><a href="models.html#cb153-7" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb153-8"><a href="models.html#cb153-8" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb153-9"><a href="models.html#cb153-9" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb153-10"><a href="models.html#cb153-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-11"><a href="models.html#cb153-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb153-12"><a href="models.html#cb153-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb153-13"><a href="models.html#cb153-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> betaPhi[t,cohort[i]]           <span class="co"># prior survival</span></span>
<span id="cb153-14"><a href="models.html#cb153-14" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb153-15"><a href="models.html#cb153-15" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb153-16"><a href="models.html#cb153-16" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb153-17"><a href="models.html#cb153-17" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb153-18"><a href="models.html#cb153-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb153-19"><a href="models.html#cb153-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb153-20"><a href="models.html#cb153-20" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb153-21"><a href="models.html#cb153-21" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb153-22"><a href="models.html#cb153-22" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb153-23"><a href="models.html#cb153-23" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb153-24"><a href="models.html#cb153-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb153-25"><a href="models.html#cb153-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-26"><a href="models.html#cb153-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-27"><a href="models.html#cb153-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-28"><a href="models.html#cb153-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb153-29"><a href="models.html#cb153-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb153-30"><a href="models.html#cb153-30" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb153-31"><a href="models.html#cb153-31" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb153-32"><a href="models.html#cb153-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb153-33"><a href="models.html#cb153-33" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c], <span class="dv">1</span>)</span>
<span id="cb153-34"><a href="models.html#cb153-34" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c], <span class="dv">1</span>)</span>
<span id="cb153-35"><a href="models.html#cb153-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb153-36"><a href="models.html#cb153-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-37"><a href="models.html#cb153-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-38"><a href="models.html#cb153-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb153-39"><a href="models.html#cb153-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb153-40"><a href="models.html#cb153-40" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb153-41"><a href="models.html#cb153-41" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb153-42"><a href="models.html#cb153-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb153-43"><a href="models.html#cb153-43" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb153-44"><a href="models.html#cb153-44" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb153-45"><a href="models.html#cb153-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb153-46"><a href="models.html#cb153-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-47"><a href="models.html#cb153-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-48"><a href="models.html#cb153-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb153-49"><a href="models.html#cb153-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb153-50"><a href="models.html#cb153-50" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb153-51"><a href="models.html#cb153-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]){</span>
<span id="cb153-52"><a href="models.html#cb153-52" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb153-53"><a href="models.html#cb153-53" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb153-54"><a href="models.html#cb153-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb153-55"><a href="models.html#cb153-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb153-56"><a href="models.html#cb153-56" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb153-57"><a href="models.html#cb153-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-58"><a href="models.html#cb153-58" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb153-59"><a href="models.html#cb153-59" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb153-60"><a href="models.html#cb153-60" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb153-61"><a href="models.html#cb153-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-62"><a href="models.html#cb153-62" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb153-63"><a href="models.html#cb153-63" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb153-64"><a href="models.html#cb153-64" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb153-65"><a href="models.html#cb153-65" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb153-66"><a href="models.html#cb153-66" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb153-67"><a href="models.html#cb153-67" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts</span>
<span id="cb153-68"><a href="models.html#cb153-68" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb153-69"><a href="models.html#cb153-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-70"><a href="models.html#cb153-70" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb153-71"><a href="models.html#cb153-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-72"><a href="models.html#cb153-72" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb153-73"><a href="models.html#cb153-73" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb153-74"><a href="models.html#cb153-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-75"><a href="models.html#cb153-75" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb153-76"><a href="models.html#cb153-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb153-77"><a href="models.html#cb153-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb153-78"><a href="models.html#cb153-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zinits,</span>
<span id="cb153-79"><a href="models.html#cb153-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb153-80"><a href="models.html#cb153-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb153-81"><a href="models.html#cb153-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb153-82"><a href="models.html#cb153-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts))</span>
<span id="cb153-83"><a href="models.html#cb153-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb153-84"><a href="models.html#cb153-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-85"><a href="models.html#cb153-85" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>)  </span>
<span id="cb153-86"><a href="models.html#cb153-86" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb153-87"><a href="models.html#cb153-87" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb153-88"><a href="models.html#cb153-88" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb153-89"><a href="models.html#cb153-89" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">=</span> <span class="dv">5</span></span>
<span id="cb153-90"><a href="models.html#cb153-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-91"><a href="models.html#cb153-91" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb153-92"><a href="models.html#cb153-92" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb153-93"><a href="models.html#cb153-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort, </span>
<span id="cb153-94"><a href="models.html#cb153-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb153-95"><a href="models.html#cb153-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb153-96"><a href="models.html#cb153-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb153-97"><a href="models.html#cb153-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb153-98"><a href="models.html#cb153-98" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb153-99"><a href="models.html#cb153-99" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb153-100"><a href="models.html#cb153-100" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb153-101"><a href="models.html#cb153-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb153-102"><a href="models.html#cb153-102" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb153-103"><a href="models.html#cb153-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-104"><a href="models.html#cb153-104" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb153-105"><a href="models.html#cb153-105" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb153-106"><a href="models.html#cb153-106" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb153-107"><a href="models.html#cb153-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-108"><a href="models.html#cb153-108" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb153-109"><a href="models.html#cb153-109" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb153-110"><a href="models.html#cb153-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb153-111"><a href="models.html#cb153-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb153-112"><a href="models.html#cb153-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb153-113"><a href="models.html#cb153-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb153-114"><a href="models.html#cb153-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb153-115"><a href="models.html#cb153-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-116"><a href="models.html#cb153-116" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb153-117"><a href="models.html#cb153-117" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb153-118"><a href="models.html#cb153-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-119"><a href="models.html#cb153-119" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb153-120"><a href="models.html#cb153-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort, </span>
<span id="cb153-121"><a href="models.html#cb153-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort,</span>
<span id="cb153-122"><a href="models.html#cb153-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort&quot;</span>,</span>
<span id="cb153-123"><a href="models.html#cb153-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb153-124"><a href="models.html#cb153-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb153-125"><a href="models.html#cb153-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb153-126"><a href="models.html#cb153-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb153-127"><a href="models.html#cb153-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb153-128"><a href="models.html#cb153-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb153-129"><a href="models.html#cb153-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb153-130"><a href="models.html#cb153-130" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb153-131"><a href="models.html#cb153-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-132"><a href="models.html#cb153-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb153-133"><a href="models.html#cb153-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_mostRecent.RData&#39;</span>)</span>
<span id="cb153-134"><a href="models.html#cb153-134" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb153-135"><a href="models.html#cb153-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_mostRecent.RData&#39;</span>)</span>
<span id="cb153-136"><a href="models.html#cb153-136" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb153-137"><a href="models.html#cb153-137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-138"><a href="models.html#cb153-138" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) { </span>
<span id="cb153-139"><a href="models.html#cb153-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-140"><a href="models.html#cb153-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiOut&quot;</span>))</span>
<span id="cb153-141"><a href="models.html#cb153-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb153-142"><a href="models.html#cb153-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb153-143"><a href="models.html#cb153-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb153-144"><a href="models.html#cb153-144" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb153-145"><a href="models.html#cb153-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb153-146"><a href="models.html#cb153-146" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb153-147"><a href="models.html#cb153-147" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb153-148"><a href="models.html#cb153-148" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>),</span>
<span id="cb153-149"><a href="models.html#cb153-149" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb153-150"><a href="models.html#cb153-150" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb153-151"><a href="models.html#cb153-151" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort-12.png" width="672" /></p>
</div>
<div id="plot-phi-against-flow-data-phit_pt_cohort" class="section level4 hasAnchor" number="3.3.3.2">
<h4><span class="header-section-number">3.3.3.2</span> Plot phi against flow data phiT_pT_cohort<a href="models.html#plot-phi-against-flow-data-phit_pt_cohort" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="models.html#cb154-1" aria-hidden="true" tabindex="-1"></a>phiOut <span class="ot">&lt;-</span> <span class="fu">MCMCsummary</span>(toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&#39;betaPhiOut&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort_flow" class="section level3 hasAnchor" number="3.3.4">
<h3><span class="header-section-number">3.3.4</span> Model phiT_pT_cohort_flow<a href="models.html#model-phit_pt_cohort_flow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Add mean flow over the interval as a survival effect</p>
<div id="set-up-and-run-model-3" class="section level4 hasAnchor" number="3.3.4.1">
<h4><span class="header-section-number">3.3.4.1</span> Set up and run model<a href="models.html#set-up-and-run-model-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="models.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb155-2"><a href="models.html#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb155-3"><a href="models.html#cb155-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-4"><a href="models.html#cb155-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb155-5"><a href="models.html#cb155-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb155-6"><a href="models.html#cb155-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb155-7"><a href="models.html#cb155-7" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb155-8"><a href="models.html#cb155-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-9"><a href="models.html#cb155-9" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flow <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb155-10"><a href="models.html#cb155-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb155-11"><a href="models.html#cb155-11" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb155-12"><a href="models.html#cb155-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-13"><a href="models.html#cb155-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb155-14"><a href="models.html#cb155-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb155-15"><a href="models.html#cb155-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb155-16"><a href="models.html#cb155-16" aria-hidden="true" tabindex="-1"></a>          betaInt <span class="sc">+</span></span>
<span id="cb155-17"><a href="models.html#cb155-17" aria-hidden="true" tabindex="-1"></a>          betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb155-18"><a href="models.html#cb155-18" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">1</span>,season[t]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb155-19"><a href="models.html#cb155-19" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">2</span>,season[t]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb155-20"><a href="models.html#cb155-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># prior survival</span></span>
<span id="cb155-21"><a href="models.html#cb155-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb155-22"><a href="models.html#cb155-22" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb155-23"><a href="models.html#cb155-23" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb155-24"><a href="models.html#cb155-24" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb155-25"><a href="models.html#cb155-25" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb155-26"><a href="models.html#cb155-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb155-27"><a href="models.html#cb155-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb155-28"><a href="models.html#cb155-28" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb155-29"><a href="models.html#cb155-29" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb155-30"><a href="models.html#cb155-30" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb155-31"><a href="models.html#cb155-31" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb155-32"><a href="models.html#cb155-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb155-33"><a href="models.html#cb155-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb155-34"><a href="models.html#cb155-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-35"><a href="models.html#cb155-35" aria-hidden="true" tabindex="-1"></a>    betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb155-36"><a href="models.html#cb155-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-37"><a href="models.html#cb155-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb155-38"><a href="models.html#cb155-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb155-39"><a href="models.html#cb155-39" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co">#1</span></span>
<span id="cb155-40"><a href="models.html#cb155-40" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co">#1</span></span>
<span id="cb155-41"><a href="models.html#cb155-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb155-42"><a href="models.html#cb155-42" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c], <span class="dv">1</span>)</span>
<span id="cb155-43"><a href="models.html#cb155-43" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c], <span class="dv">1</span>)</span>
<span id="cb155-44"><a href="models.html#cb155-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb155-45"><a href="models.html#cb155-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb155-46"><a href="models.html#cb155-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-47"><a href="models.html#cb155-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb155-48"><a href="models.html#cb155-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb155-49"><a href="models.html#cb155-49" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb155-50"><a href="models.html#cb155-50" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb155-51"><a href="models.html#cb155-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb155-52"><a href="models.html#cb155-52" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb155-53"><a href="models.html#cb155-53" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb155-54"><a href="models.html#cb155-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb155-55"><a href="models.html#cb155-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb155-56"><a href="models.html#cb155-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-57"><a href="models.html#cb155-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb155-58"><a href="models.html#cb155-58" aria-hidden="true" tabindex="-1"></a>      betaFlow[<span class="dv">1</span>,s] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb155-59"><a href="models.html#cb155-59" aria-hidden="true" tabindex="-1"></a>      betaFlow[<span class="dv">2</span>,s] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb155-60"><a href="models.html#cb155-60" aria-hidden="true" tabindex="-1"></a>    }    </span>
<span id="cb155-61"><a href="models.html#cb155-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-62"><a href="models.html#cb155-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb155-63"><a href="models.html#cb155-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb155-64"><a href="models.html#cb155-64" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb155-65"><a href="models.html#cb155-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(last[i])){</span>
<span id="cb155-66"><a href="models.html#cb155-66" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb155-67"><a href="models.html#cb155-67" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb155-68"><a href="models.html#cb155-68" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb155-69"><a href="models.html#cb155-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb155-70"><a href="models.html#cb155-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb155-71"><a href="models.html#cb155-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb155-72"><a href="models.html#cb155-72" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb155-73"><a href="models.html#cb155-73" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb155-74"><a href="models.html#cb155-74" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb155-75"><a href="models.html#cb155-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-76"><a href="models.html#cb155-76" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb155-77"><a href="models.html#cb155-77" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb155-78"><a href="models.html#cb155-78" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb155-79"><a href="models.html#cb155-79" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb155-80"><a href="models.html#cb155-80" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb155-81"><a href="models.html#cb155-81" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb155-82"><a href="models.html#cb155-82" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb155-83"><a href="models.html#cb155-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">flow =</span> eh<span class="sc">$</span>flow</span>
<span id="cb155-84"><a href="models.html#cb155-84" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb155-85"><a href="models.html#cb155-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-86"><a href="models.html#cb155-86" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb155-87"><a href="models.html#cb155-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-88"><a href="models.html#cb155-88" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb155-89"><a href="models.html#cb155-89" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb155-90"><a href="models.html#cb155-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-91"><a href="models.html#cb155-91" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb155-92"><a href="models.html#cb155-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-93"><a href="models.html#cb155-93" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb155-94"><a href="models.html#cb155-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb155-95"><a href="models.html#cb155-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb155-96"><a href="models.html#cb155-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb155-97"><a href="models.html#cb155-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb155-98"><a href="models.html#cb155-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb155-99"><a href="models.html#cb155-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb155-100"><a href="models.html#cb155-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb155-101"><a href="models.html#cb155-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb155-102"><a href="models.html#cb155-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>))</span>
<span id="cb155-103"><a href="models.html#cb155-103" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-104"><a href="models.html#cb155-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-105"><a href="models.html#cb155-105" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb155-106"><a href="models.html#cb155-106" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, </span>
<span id="cb155-107"><a href="models.html#cb155-107" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb155-108"><a href="models.html#cb155-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, </span>
<span id="cb155-109"><a href="models.html#cb155-109" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb155-110"><a href="models.html#cb155-110" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>)  </span>
<span id="cb155-111"><a href="models.html#cb155-111" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb155-112"><a href="models.html#cb155-112" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb155-113"><a href="models.html#cb155-113" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb155-114"><a href="models.html#cb155-114" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb155-115"><a href="models.html#cb155-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-116"><a href="models.html#cb155-116" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb155-117"><a href="models.html#cb155-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-118"><a href="models.html#cb155-118" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb155-119"><a href="models.html#cb155-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort_flow, </span>
<span id="cb155-120"><a href="models.html#cb155-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb155-121"><a href="models.html#cb155-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb155-122"><a href="models.html#cb155-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb155-123"><a href="models.html#cb155-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb155-124"><a href="models.html#cb155-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-125"><a href="models.html#cb155-125" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb155-126"><a href="models.html#cb155-126" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb155-127"><a href="models.html#cb155-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb155-128"><a href="models.html#cb155-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-129"><a href="models.html#cb155-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-130"><a href="models.html#cb155-130" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb155-131"><a href="models.html#cb155-131" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb155-132"><a href="models.html#cb155-132" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb155-133"><a href="models.html#cb155-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-134"><a href="models.html#cb155-134" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flow <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb155-135"><a href="models.html#cb155-135" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb155-136"><a href="models.html#cb155-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb155-137"><a href="models.html#cb155-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb155-138"><a href="models.html#cb155-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb155-139"><a href="models.html#cb155-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb155-140"><a href="models.html#cb155-140" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-141"><a href="models.html#cb155-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-142"><a href="models.html#cb155-142" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb155-143"><a href="models.html#cb155-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-144"><a href="models.html#cb155-144" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flow <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb155-145"><a href="models.html#cb155-145" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb155-146"><a href="models.html#cb155-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flow, </span>
<span id="cb155-147"><a href="models.html#cb155-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flow,</span>
<span id="cb155-148"><a href="models.html#cb155-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flow&quot;</span>,</span>
<span id="cb155-149"><a href="models.html#cb155-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb155-150"><a href="models.html#cb155-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb155-151"><a href="models.html#cb155-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb155-152"><a href="models.html#cb155-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb155-153"><a href="models.html#cb155-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb155-154"><a href="models.html#cb155-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb155-155"><a href="models.html#cb155-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb155-156"><a href="models.html#cb155-156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb155-157"><a href="models.html#cb155-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flow_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb155-158"><a href="models.html#cb155-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flow_mostRecent.RData&#39;</span>)</span>
<span id="cb155-159"><a href="models.html#cb155-159" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb155-160"><a href="models.html#cb155-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flow_mostRecent.RData&#39;</span>)</span>
<span id="cb155-161"><a href="models.html#cb155-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-162"><a href="models.html#cb155-162" aria-hidden="true" tabindex="-1"></a><span class="co"># could consider forward algo to speed up convergence (https://oliviergimenez.github.io/banana-book/hmmcapturerecapture.html#nimble-implementation-1)</span></span>
<span id="cb155-163"><a href="models.html#cb155-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-164"><a href="models.html#cb155-164" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb155-165"><a href="models.html#cb155-165" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = toSave$mcmc, round = 2)</span></span>
<span id="cb155-166"><a href="models.html#cb155-166" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flow, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb155-167"><a href="models.html#cb155-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb155-168"><a href="models.html#cb155-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb155-169"><a href="models.html#cb155-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb155-170"><a href="models.html#cb155-170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-171"><a href="models.html#cb155-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohort&quot;</span>))</span>
<span id="cb155-172"><a href="models.html#cb155-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-173"><a href="models.html#cb155-173" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb155-174"><a href="models.html#cb155-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb155-175"><a href="models.html#cb155-175" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb155-176"><a href="models.html#cb155-176" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb155-177"><a href="models.html#cb155-177" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb155-178"><a href="models.html#cb155-178" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb155-179"><a href="models.html#cb155-179" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb155-180"><a href="models.html#cb155-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb155-181"><a href="models.html#cb155-181" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb155-182"><a href="models.html#cb155-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb155-183"><a href="models.html#cb155-183" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb155-184"><a href="models.html#cb155-184" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb155-185"><a href="models.html#cb155-185" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb155-186"><a href="models.html#cb155-186" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb155-187"><a href="models.html#cb155-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb155-188"><a href="models.html#cb155-188" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flow-12.png" width="672" /></p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="models.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run more iterations, if necessary</span></span>
<span id="cb156-2"><a href="models.html#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nIterAdd &lt;- 5000</span></span>
<span id="cb156-3"><a href="models.html#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmcmc$run(nIterAdd, reset = FALSE)</span></span>
<span id="cb156-4"><a href="models.html#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more_samples &lt;- as.matrix(Cmcmc$mvSamples)</span></span>
<span id="cb156-5"><a href="models.html#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb156-6"><a href="models.html#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCtrace(object = more_samples,</span></span>
<span id="cb156-7"><a href="models.html#cb156-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           #ISB = FALSE,</span></span>
<span id="cb156-8"><a href="models.html#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co">#           #exact = TRUE, </span></span>
<span id="cb156-9"><a href="models.html#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="co">#           params = c(&quot;betaFlow&quot;),</span></span>
<span id="cb156-10"><a href="models.html#cb156-10" aria-hidden="true" tabindex="-1"></a><span class="co">#           pdf = FALSE, </span></span>
<span id="cb156-11"><a href="models.html#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="co">#           priors = priors)</span></span></code></pre></div>
</div>
<div id="get-flow-effect-estimates" class="section level4 hasAnchor" number="3.3.4.2">
<h4><span class="header-section-number">3.3.4.2</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects fixed across cohorts</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="models.html#cb157-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb157-2"><a href="models.html#cb157-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb157-3"><a href="models.html#cb157-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t]] * flow[i,t] +</span></span>
<span id="cb157-4"><a href="models.html#cb157-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb157-5"><a href="models.html#cb157-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-6"><a href="models.html#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="models.html#cb157-7" aria-hidden="true" tabindex="-1"></a>getPredictionsFlow <span class="ot">&lt;-</span> <span class="cf">function</span>(mcmc, <span class="at">everyNIters =</span> <span class="dv">10</span>, <span class="at">flowStep =</span> <span class="fl">0.5</span>){</span>
<span id="cb157-8"><a href="models.html#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="models.html#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaInt</span></span>
<span id="cb157-10"><a href="models.html#cb157-10" aria-hidden="true" tabindex="-1"></a>  predictorsBetaInt <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb157-11"><a href="models.html#cb157-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters)</span>
<span id="cb157-12"><a href="models.html#cb157-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-13"><a href="models.html#cb157-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaInt)){</span>
<span id="cb157-14"><a href="models.html#cb157-14" aria-hidden="true" tabindex="-1"></a>    predictorsBetaInt<span class="sc">$</span>betaInt[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[ predictorsBetaInt[i, <span class="st">&quot;iter&quot;</span>], <span class="st">&quot;betaInt&quot;</span> ]]</span>
<span id="cb157-15"><a href="models.html#cb157-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-16"><a href="models.html#cb157-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-17"><a href="models.html#cb157-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-18"><a href="models.html#cb157-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaFlow</span></span>
<span id="cb157-19"><a href="models.html#cb157-19" aria-hidden="true" tabindex="-1"></a>  predictorsBetaFlow <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb157-20"><a href="models.html#cb157-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb157-21"><a href="models.html#cb157-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons</span>
<span id="cb157-22"><a href="models.html#cb157-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-23"><a href="models.html#cb157-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-24"><a href="models.html#cb157-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaFlow)){</span>
<span id="cb157-25"><a href="models.html#cb157-25" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow1[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb157-26"><a href="models.html#cb157-26" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[1, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb157-27"><a href="models.html#cb157-27" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb157-28"><a href="models.html#cb157-28" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb157-29"><a href="models.html#cb157-29" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow2[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb157-30"><a href="models.html#cb157-30" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[2, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb157-31"><a href="models.html#cb157-31" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb157-32"><a href="models.html#cb157-32" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb157-33"><a href="models.html#cb157-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-34"><a href="models.html#cb157-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-35"><a href="models.html#cb157-35" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaPhi</span></span>
<span id="cb157-36"><a href="models.html#cb157-36" aria-hidden="true" tabindex="-1"></a>  predictorsBetaPhi <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb157-37"><a href="models.html#cb157-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb157-38"><a href="models.html#cb157-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts</span>
<span id="cb157-39"><a href="models.html#cb157-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-40"><a href="models.html#cb157-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaPhi)){</span>
<span id="cb157-41"><a href="models.html#cb157-41" aria-hidden="true" tabindex="-1"></a>    predictorsBetaPhi<span class="sc">$</span>betaPhi[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaPhi[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb157-42"><a href="models.html#cb157-42" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaPhiCohort[&quot;</span>, predictorsBetaPhi[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb157-43"><a href="models.html#cb157-43" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb157-44"><a href="models.html#cb157-44" aria-hidden="true" tabindex="-1"></a>                                                ]]</span>
<span id="cb157-45"><a href="models.html#cb157-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb157-46"><a href="models.html#cb157-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-47"><a href="models.html#cb157-47" aria-hidden="true" tabindex="-1"></a>  predictorsAll <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb157-48"><a href="models.html#cb157-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb157-49"><a href="models.html#cb157-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts,</span>
<span id="cb157-50"><a href="models.html#cb157-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons,</span>
<span id="cb157-51"><a href="models.html#cb157-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">flow =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, flowStep)</span>
<span id="cb157-52"><a href="models.html#cb157-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-53"><a href="models.html#cb157-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-54"><a href="models.html#cb157-54" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> predictorsAll <span class="sc">%&gt;%</span></span>
<span id="cb157-55"><a href="models.html#cb157-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaInt) <span class="sc">%&gt;%</span></span>
<span id="cb157-56"><a href="models.html#cb157-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaFlow) <span class="sc">%&gt;%</span></span>
<span id="cb157-57"><a href="models.html#cb157-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaPhi) <span class="sc">%&gt;%</span></span>
<span id="cb157-58"><a href="models.html#cb157-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predPhi =</span> <span class="fu">plogis</span>(betaInt <span class="sc">+</span> betaPhi <span class="sc">+</span> betaFlow1 <span class="sc">*</span> flow <span class="sc">+</span> betaFlow2 <span class="sc">*</span> flow<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb157-59"><a href="models.html#cb157-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb157-60"><a href="models.html#cb157-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(preds)</span>
<span id="cb157-61"><a href="models.html#cb157-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb157-62"><a href="models.html#cb157-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-63"><a href="models.html#cb157-63" aria-hidden="true" tabindex="-1"></a>predFlow <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlow</span>(toSave<span class="sc">$</span>mcmc, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-flow-predictions-phit_pt_cohort_flow" class="section level4 hasAnchor" number="3.3.4.3">
<h4><span class="header-section-number">3.3.4.3</span> Plot flow predictions phiT_pT_cohort_flow<a href="models.html#plot-flow-predictions-phit_pt_cohort_flow" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="models.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlow, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb158-2"><a href="models.html#cb158-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb158-3"><a href="models.html#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="models.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlow %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb159-2"><a href="models.html#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb159-3"><a href="models.html#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb159-4"><a href="models.html#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-5"><a href="models.html#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlow %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb159-6"><a href="models.html#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb159-7"><a href="models.html#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb159-8"><a href="models.html#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-9"><a href="models.html#cb159-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlow %&gt;% filter(season ==1), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb159-10"><a href="models.html#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb159-11"><a href="models.html#cb159-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort_flowcohort" class="section level3 hasAnchor" number="3.3.5">
<h3><span class="header-section-number">3.3.5</span> Model phiT_pT_cohort_flowCohort<a href="models.html#model-phit_pt_cohort_flowcohort" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Flow effects vary by cohort</p>
<div id="set-up-and-run-model-4" class="section level4 hasAnchor" number="3.3.5.1">
<h4><span class="header-section-number">3.3.5.1</span> Set up and run model<a href="models.html#set-up-and-run-model-4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="models.html#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb160-2"><a href="models.html#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb160-3"><a href="models.html#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="models.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb160-5"><a href="models.html#cb160-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb160-6"><a href="models.html#cb160-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb160-7"><a href="models.html#cb160-7" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb160-8"><a href="models.html#cb160-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-9"><a href="models.html#cb160-9" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flowCohort <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb160-10"><a href="models.html#cb160-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb160-11"><a href="models.html#cb160-11" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb160-12"><a href="models.html#cb160-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-13"><a href="models.html#cb160-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb160-14"><a href="models.html#cb160-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb160-15"><a href="models.html#cb160-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb160-16"><a href="models.html#cb160-16" aria-hidden="true" tabindex="-1"></a>          betaInt <span class="sc">+</span></span>
<span id="cb160-17"><a href="models.html#cb160-17" aria-hidden="true" tabindex="-1"></a>          betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb160-18"><a href="models.html#cb160-18" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">1</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb160-19"><a href="models.html#cb160-19" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">2</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb160-20"><a href="models.html#cb160-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># prior survival</span></span>
<span id="cb160-21"><a href="models.html#cb160-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-22"><a href="models.html#cb160-22" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb160-23"><a href="models.html#cb160-23" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb160-24"><a href="models.html#cb160-24" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb160-25"><a href="models.html#cb160-25" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb160-26"><a href="models.html#cb160-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb160-27"><a href="models.html#cb160-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb160-28"><a href="models.html#cb160-28" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb160-29"><a href="models.html#cb160-29" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb160-30"><a href="models.html#cb160-30" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb160-31"><a href="models.html#cb160-31" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb160-32"><a href="models.html#cb160-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-33"><a href="models.html#cb160-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-34"><a href="models.html#cb160-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-35"><a href="models.html#cb160-35" aria-hidden="true" tabindex="-1"></a>    betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb160-36"><a href="models.html#cb160-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-37"><a href="models.html#cb160-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb160-38"><a href="models.html#cb160-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb160-39"><a href="models.html#cb160-39" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb160-40"><a href="models.html#cb160-40" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb160-41"><a href="models.html#cb160-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb160-42"><a href="models.html#cb160-42" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c], <span class="dv">1</span>)</span>
<span id="cb160-43"><a href="models.html#cb160-43" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c], <span class="dv">1</span>)</span>
<span id="cb160-44"><a href="models.html#cb160-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-45"><a href="models.html#cb160-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-46"><a href="models.html#cb160-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-47"><a href="models.html#cb160-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb160-48"><a href="models.html#cb160-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb160-49"><a href="models.html#cb160-49" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb160-50"><a href="models.html#cb160-50" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb160-51"><a href="models.html#cb160-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb160-52"><a href="models.html#cb160-52" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb160-53"><a href="models.html#cb160-53" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb160-54"><a href="models.html#cb160-54" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-55"><a href="models.html#cb160-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-56"><a href="models.html#cb160-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-57"><a href="models.html#cb160-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb160-58"><a href="models.html#cb160-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb160-59"><a href="models.html#cb160-59" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">1</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb160-60"><a href="models.html#cb160-60" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">2</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb160-61"><a href="models.html#cb160-61" aria-hidden="true" tabindex="-1"></a>      }   </span>
<span id="cb160-62"><a href="models.html#cb160-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-63"><a href="models.html#cb160-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-64"><a href="models.html#cb160-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb160-65"><a href="models.html#cb160-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb160-66"><a href="models.html#cb160-66" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb160-67"><a href="models.html#cb160-67" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(last[i])){</span>
<span id="cb160-68"><a href="models.html#cb160-68" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb160-69"><a href="models.html#cb160-69" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb160-70"><a href="models.html#cb160-70" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb160-71"><a href="models.html#cb160-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-72"><a href="models.html#cb160-72" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb160-73"><a href="models.html#cb160-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-74"><a href="models.html#cb160-74" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb160-75"><a href="models.html#cb160-75" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb160-76"><a href="models.html#cb160-76" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb160-77"><a href="models.html#cb160-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-78"><a href="models.html#cb160-78" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb160-79"><a href="models.html#cb160-79" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb160-80"><a href="models.html#cb160-80" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb160-81"><a href="models.html#cb160-81" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb160-82"><a href="models.html#cb160-82" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb160-83"><a href="models.html#cb160-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb160-84"><a href="models.html#cb160-84" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb160-85"><a href="models.html#cb160-85" aria-hidden="true" tabindex="-1"></a>                       <span class="at">flow =</span> eh<span class="sc">$</span>flow</span>
<span id="cb160-86"><a href="models.html#cb160-86" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb160-87"><a href="models.html#cb160-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-88"><a href="models.html#cb160-88" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb160-89"><a href="models.html#cb160-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-90"><a href="models.html#cb160-90" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb160-91"><a href="models.html#cb160-91" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb160-92"><a href="models.html#cb160-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-93"><a href="models.html#cb160-93" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb160-94"><a href="models.html#cb160-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-95"><a href="models.html#cb160-95" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb160-96"><a href="models.html#cb160-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb160-97"><a href="models.html#cb160-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb160-98"><a href="models.html#cb160-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb160-99"><a href="models.html#cb160-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb160-100"><a href="models.html#cb160-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb160-101"><a href="models.html#cb160-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb160-102"><a href="models.html#cb160-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb160-103"><a href="models.html#cb160-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb160-104"><a href="models.html#cb160-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, nCohorts))</span>
<span id="cb160-105"><a href="models.html#cb160-105" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-106"><a href="models.html#cb160-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-107"><a href="models.html#cb160-107" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb160-108"><a href="models.html#cb160-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb160-109"><a href="models.html#cb160-109" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb160-110"><a href="models.html#cb160-110" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>)  </span>
<span id="cb160-111"><a href="models.html#cb160-111" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span></span>
<span id="cb160-112"><a href="models.html#cb160-112" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb160-113"><a href="models.html#cb160-113" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb160-114"><a href="models.html#cb160-114" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb160-115"><a href="models.html#cb160-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-116"><a href="models.html#cb160-116" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb160-117"><a href="models.html#cb160-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-118"><a href="models.html#cb160-118" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb160-119"><a href="models.html#cb160-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort_flowCohort, </span>
<span id="cb160-120"><a href="models.html#cb160-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb160-121"><a href="models.html#cb160-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb160-122"><a href="models.html#cb160-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb160-123"><a href="models.html#cb160-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb160-124"><a href="models.html#cb160-124" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-125"><a href="models.html#cb160-125" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb160-126"><a href="models.html#cb160-126" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb160-127"><a href="models.html#cb160-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb160-128"><a href="models.html#cb160-128" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-129"><a href="models.html#cb160-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-130"><a href="models.html#cb160-130" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb160-131"><a href="models.html#cb160-131" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb160-132"><a href="models.html#cb160-132" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb160-133"><a href="models.html#cb160-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-134"><a href="models.html#cb160-134" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flowCohort <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb160-135"><a href="models.html#cb160-135" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb160-136"><a href="models.html#cb160-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb160-137"><a href="models.html#cb160-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb160-138"><a href="models.html#cb160-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb160-139"><a href="models.html#cb160-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb160-140"><a href="models.html#cb160-140" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-141"><a href="models.html#cb160-141" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-142"><a href="models.html#cb160-142" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb160-143"><a href="models.html#cb160-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-144"><a href="models.html#cb160-144" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flowCohort <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb160-145"><a href="models.html#cb160-145" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb160-146"><a href="models.html#cb160-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flowCohort, </span>
<span id="cb160-147"><a href="models.html#cb160-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flowCohort,</span>
<span id="cb160-148"><a href="models.html#cb160-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flowCohort&quot;</span>,</span>
<span id="cb160-149"><a href="models.html#cb160-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb160-150"><a href="models.html#cb160-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb160-151"><a href="models.html#cb160-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb160-152"><a href="models.html#cb160-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb160-153"><a href="models.html#cb160-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb160-154"><a href="models.html#cb160-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb160-155"><a href="models.html#cb160-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb160-156"><a href="models.html#cb160-156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-157"><a href="models.html#cb160-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohort_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb160-158"><a href="models.html#cb160-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohort_mostRecent.RData&#39;</span>)</span>
<span id="cb160-159"><a href="models.html#cb160-159" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb160-160"><a href="models.html#cb160-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohort_mostRecent.RData&#39;</span>)</span>
<span id="cb160-161"><a href="models.html#cb160-161" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-162"><a href="models.html#cb160-162" aria-hidden="true" tabindex="-1"></a><span class="co"># could consider forward algo to speed up convergence (https://oliviergimenez.github.io/banana-book/hmmcapturerecapture.html#nimble-implementation-1)</span></span>
<span id="cb160-163"><a href="models.html#cb160-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-164"><a href="models.html#cb160-164" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb160-165"><a href="models.html#cb160-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-166"><a href="models.html#cb160-166" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT_cohort_flow, round = 2)</span></span>
<span id="cb160-167"><a href="models.html#cb160-167" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flow, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb160-168"><a href="models.html#cb160-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb160-169"><a href="models.html#cb160-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb160-170"><a href="models.html#cb160-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb160-171"><a href="models.html#cb160-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-172"><a href="models.html#cb160-172" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb160-173"><a href="models.html#cb160-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb160-174"><a href="models.html#cb160-174" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb160-175"><a href="models.html#cb160-175" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb160-176"><a href="models.html#cb160-176" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb160-177"><a href="models.html#cb160-177" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb160-178"><a href="models.html#cb160-178" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb160-179"><a href="models.html#cb160-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-180"><a href="models.html#cb160-180" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb160-181"><a href="models.html#cb160-181" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb160-182"><a href="models.html#cb160-182" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb160-183"><a href="models.html#cb160-183" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb160-184"><a href="models.html#cb160-184" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb160-185"><a href="models.html#cb160-185" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb160-186"><a href="models.html#cb160-186" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb160-187"><a href="models.html#cb160-187" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-27.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-28.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-29.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-30.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-31.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-32.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-33.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-34.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-35.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-36.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-37.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-38.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-39.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-40.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-41.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-42.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohort-43.png" width="672" /></p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="models.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run more iterations, if necessary</span></span>
<span id="cb161-2"><a href="models.html#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nIterAdd &lt;- 5000</span></span>
<span id="cb161-3"><a href="models.html#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmcmc$run(nIterAdd, reset = FALSE)</span></span>
<span id="cb161-4"><a href="models.html#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more_samples &lt;- as.matrix(Cmcmc$mvSamples)</span></span>
<span id="cb161-5"><a href="models.html#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb161-6"><a href="models.html#cb161-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCtrace(object = more_samples,</span></span>
<span id="cb161-7"><a href="models.html#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           #ISB = FALSE,</span></span>
<span id="cb161-8"><a href="models.html#cb161-8" aria-hidden="true" tabindex="-1"></a><span class="co">#           #exact = TRUE, </span></span>
<span id="cb161-9"><a href="models.html#cb161-9" aria-hidden="true" tabindex="-1"></a><span class="co">#           params = c(&quot;betaFlow&quot;),</span></span>
<span id="cb161-10"><a href="models.html#cb161-10" aria-hidden="true" tabindex="-1"></a><span class="co">#           pdf = FALSE, </span></span>
<span id="cb161-11"><a href="models.html#cb161-11" aria-hidden="true" tabindex="-1"></a><span class="co">#           priors = priors)</span></span></code></pre></div>
</div>
<div id="get-flow-effect-estimates-1" class="section level4 hasAnchor" number="3.3.5.2">
<h4><span class="header-section-number">3.3.5.2</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects vary across cohorts</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="models.html#cb162-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb162-2"><a href="models.html#cb162-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb162-3"><a href="models.html#cb162-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t],cohort[i]] * flow[i,t] +</span></span>
<span id="cb162-4"><a href="models.html#cb162-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t],cohort[i]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb162-5"><a href="models.html#cb162-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-6"><a href="models.html#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="co"># load current flow model</span></span>
<span id="cb162-7"><a href="models.html#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="co">#load(&quot;C:/Users/bletcher/OneDrive - DOI/projects/westBrook-book/models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flow_2022-05-12 10.RData&quot;)</span></span>
<span id="cb162-8"><a href="models.html#cb162-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-9"><a href="models.html#cb162-9" aria-hidden="true" tabindex="-1"></a>getPredictionsFlowCohort <span class="ot">&lt;-</span> <span class="cf">function</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>, <span class="at">flowStep =</span> <span class="fl">0.5</span>){</span>
<span id="cb162-10"><a href="models.html#cb162-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-11"><a href="models.html#cb162-11" aria-hidden="true" tabindex="-1"></a>  mcmc <span class="ot">&lt;-</span> toSave<span class="sc">$</span>mcmc</span>
<span id="cb162-12"><a href="models.html#cb162-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaInt</span></span>
<span id="cb162-13"><a href="models.html#cb162-13" aria-hidden="true" tabindex="-1"></a>  predictorsBetaInt <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb162-14"><a href="models.html#cb162-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters)</span>
<span id="cb162-15"><a href="models.html#cb162-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb162-16"><a href="models.html#cb162-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaInt)){</span>
<span id="cb162-17"><a href="models.html#cb162-17" aria-hidden="true" tabindex="-1"></a>    predictorsBetaInt<span class="sc">$</span>betaInt[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[ predictorsBetaInt[i, <span class="st">&quot;iter&quot;</span>], <span class="st">&quot;betaInt&quot;</span> ]]</span>
<span id="cb162-18"><a href="models.html#cb162-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-19"><a href="models.html#cb162-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-20"><a href="models.html#cb162-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-21"><a href="models.html#cb162-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaFlow</span></span>
<span id="cb162-22"><a href="models.html#cb162-22" aria-hidden="true" tabindex="-1"></a>  predictorsBetaFlow <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb162-23"><a href="models.html#cb162-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb162-24"><a href="models.html#cb162-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons,</span>
<span id="cb162-25"><a href="models.html#cb162-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts</span>
<span id="cb162-26"><a href="models.html#cb162-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb162-27"><a href="models.html#cb162-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-28"><a href="models.html#cb162-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaFlow)){</span>
<span id="cb162-29"><a href="models.html#cb162-29" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow1[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb162-30"><a href="models.html#cb162-30" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[1, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb162-31"><a href="models.html#cb162-31" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;, &quot;</span>,           predictorsBetaFlow[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb162-32"><a href="models.html#cb162-32" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb162-33"><a href="models.html#cb162-33" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb162-34"><a href="models.html#cb162-34" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlow<span class="sc">$</span>betaFlow2[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlow[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb162-35"><a href="models.html#cb162-35" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaFlow[2, &quot;</span>, predictorsBetaFlow[i, <span class="st">&quot;season&quot;</span>],</span>
<span id="cb162-36"><a href="models.html#cb162-36" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;, &quot;</span>,           predictorsBetaFlow[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb162-37"><a href="models.html#cb162-37" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb162-38"><a href="models.html#cb162-38" aria-hidden="true" tabindex="-1"></a>                                                  ]]</span>
<span id="cb162-39"><a href="models.html#cb162-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-40"><a href="models.html#cb162-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-41"><a href="models.html#cb162-41" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaPhi</span></span>
<span id="cb162-42"><a href="models.html#cb162-42" aria-hidden="true" tabindex="-1"></a>  predictorsBetaPhi <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb162-43"><a href="models.html#cb162-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb162-44"><a href="models.html#cb162-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts</span>
<span id="cb162-45"><a href="models.html#cb162-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb162-46"><a href="models.html#cb162-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-47"><a href="models.html#cb162-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this step is very slow for some reason......</span></span>
<span id="cb162-48"><a href="models.html#cb162-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaPhi)){</span>
<span id="cb162-49"><a href="models.html#cb162-49" aria-hidden="true" tabindex="-1"></a>    predictorsBetaPhi<span class="sc">$</span>betaPhi[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaPhi[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb162-50"><a href="models.html#cb162-50" aria-hidden="true" tabindex="-1"></a>                                                   <span class="fu">paste0</span>(<span class="st">&quot;betaPhiCohort[&quot;</span>, predictorsBetaPhi[i, <span class="st">&quot;cohort&quot;</span>],</span>
<span id="cb162-51"><a href="models.html#cb162-51" aria-hidden="true" tabindex="-1"></a>                                                          <span class="st">&quot;]&quot;</span>)</span>
<span id="cb162-52"><a href="models.html#cb162-52" aria-hidden="true" tabindex="-1"></a>                                                ]]</span>
<span id="cb162-53"><a href="models.html#cb162-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb162-54"><a href="models.html#cb162-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-55"><a href="models.html#cb162-55" aria-hidden="true" tabindex="-1"></a>  predictorsAll <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb162-56"><a href="models.html#cb162-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb162-57"><a href="models.html#cb162-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">cohort =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nCohorts,</span>
<span id="cb162-58"><a href="models.html#cb162-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">season =</span> <span class="dv">1</span><span class="sc">:</span>toSave<span class="sc">$</span>nSeasons,</span>
<span id="cb162-59"><a href="models.html#cb162-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">flow =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, flowStep)</span>
<span id="cb162-60"><a href="models.html#cb162-60" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb162-61"><a href="models.html#cb162-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-62"><a href="models.html#cb162-62" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> predictorsAll <span class="sc">%&gt;%</span></span>
<span id="cb162-63"><a href="models.html#cb162-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaInt) <span class="sc">%&gt;%</span></span>
<span id="cb162-64"><a href="models.html#cb162-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaFlow) <span class="sc">%&gt;%</span></span>
<span id="cb162-65"><a href="models.html#cb162-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(predictorsBetaPhi) <span class="sc">%&gt;%</span></span>
<span id="cb162-66"><a href="models.html#cb162-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predPhi =</span> <span class="fu">plogis</span>(betaInt <span class="sc">+</span> betaPhi <span class="sc">+</span> betaFlow1 <span class="sc">*</span> flow <span class="sc">+</span> betaFlow2 <span class="sc">*</span> flow<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb162-67"><a href="models.html#cb162-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb162-68"><a href="models.html#cb162-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(preds)</span>
<span id="cb162-69"><a href="models.html#cb162-69" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb162-70"><a href="models.html#cb162-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-71"><a href="models.html#cb162-71" aria-hidden="true" tabindex="-1"></a>predFlowCohort <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowCohort</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-flow-predictions-phit_pt_cohort_flowcohort" class="section level4 hasAnchor" number="3.3.5.3">
<h4><span class="header-section-number">3.3.5.3</span> Plot flow predictions phiT_pT_cohort_flowCohort<a href="models.html#plot-flow-predictions-phit_pt_cohort_flowcohort" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="models.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlowCohort, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb163-2"><a href="models.html#cb163-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb163-3"><a href="models.html#cb163-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="models.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohort %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb164-2"><a href="models.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb164-3"><a href="models.html#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb164-4"><a href="models.html#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb164-5"><a href="models.html#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohort %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb164-6"><a href="models.html#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb164-7"><a href="models.html#cb164-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb164-8"><a href="models.html#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb164-9"><a href="models.html#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohort %&gt;% filter(season ==1), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb164-10"><a href="models.html#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb164-11"><a href="models.html#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
</div>
<div id="model-phit_pt_cohort_flowcohorthier" class="section level3 hasAnchor" number="3.3.6">
<h3><span class="header-section-number">3.3.6</span> Model phiT_pT_cohort_flowCohortHier<a href="models.html#model-phit_pt_cohort_flowcohorthier" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Flow effects vary by cohort, hierarchical across cohorts</p>
<div id="set-up-and-run-model-5" class="section level4 hasAnchor" number="3.3.6.1">
<h4><span class="header-section-number">3.3.6.1</span> Set up and run model<a href="models.html#set-up-and-run-model-5" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb165"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb165-1"><a href="models.html#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html</span></span>
<span id="cb165-2"><a href="models.html#cb165-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb165-3"><a href="models.html#cb165-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-4"><a href="models.html#cb165-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb165-5"><a href="models.html#cb165-5" aria-hidden="true" tabindex="-1"></a>  nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts))</span>
<span id="cb165-6"><a href="models.html#cb165-6" aria-hidden="true" tabindex="-1"></a>  nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons))</span>
<span id="cb165-7"><a href="models.html#cb165-7" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb165-8"><a href="models.html#cb165-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-9"><a href="models.html#cb165-9" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flowCohortHier <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb165-10"><a href="models.html#cb165-10" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb165-11"><a href="models.html#cb165-11" aria-hidden="true" tabindex="-1"></a>    delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb165-12"><a href="models.html#cb165-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-13"><a href="models.html#cb165-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb165-14"><a href="models.html#cb165-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb165-15"><a href="models.html#cb165-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb165-16"><a href="models.html#cb165-16" aria-hidden="true" tabindex="-1"></a>          betaInt <span class="sc">+</span></span>
<span id="cb165-17"><a href="models.html#cb165-17" aria-hidden="true" tabindex="-1"></a>          betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb165-18"><a href="models.html#cb165-18" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">1</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb165-19"><a href="models.html#cb165-19" aria-hidden="true" tabindex="-1"></a>          betaFlow[<span class="dv">2</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb165-20"><a href="models.html#cb165-20" aria-hidden="true" tabindex="-1"></a>           <span class="co"># prior survival</span></span>
<span id="cb165-21"><a href="models.html#cb165-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb165-22"><a href="models.html#cb165-22" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb165-23"><a href="models.html#cb165-23" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb165-24"><a href="models.html#cb165-24" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb165-25"><a href="models.html#cb165-25" aria-hidden="true" tabindex="-1"></a>        gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb165-26"><a href="models.html#cb165-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb165-27"><a href="models.html#cb165-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb165-28"><a href="models.html#cb165-28" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb165-29"><a href="models.html#cb165-29" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb165-30"><a href="models.html#cb165-30" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb165-31"><a href="models.html#cb165-31" aria-hidden="true" tabindex="-1"></a>        omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb165-32"><a href="models.html#cb165-32" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb165-33"><a href="models.html#cb165-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-34"><a href="models.html#cb165-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-35"><a href="models.html#cb165-35" aria-hidden="true" tabindex="-1"></a>    betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb165-36"><a href="models.html#cb165-36" aria-hidden="true" tabindex="-1"></a>    betaFlowTop[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.1</span>) <span class="co"># to 0.1</span></span>
<span id="cb165-37"><a href="models.html#cb165-37" aria-hidden="true" tabindex="-1"></a>    betaFlowTop[<span class="dv">2</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="fl">0.1</span>)</span>
<span id="cb165-38"><a href="models.html#cb165-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-39"><a href="models.html#cb165-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb165-40"><a href="models.html#cb165-40" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean values</span></span>
<span id="cb165-41"><a href="models.html#cb165-41" aria-hidden="true" tabindex="-1"></a>      betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb165-42"><a href="models.html#cb165-42" aria-hidden="true" tabindex="-1"></a>      betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb165-43"><a href="models.html#cb165-43" aria-hidden="true" tabindex="-1"></a>      betaFlowCohort[<span class="dv">1</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">1</span>],<span class="dv">1</span>)</span>
<span id="cb165-44"><a href="models.html#cb165-44" aria-hidden="true" tabindex="-1"></a>      betaFlowCohort[<span class="dv">2</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">2</span>],<span class="dv">1</span>)</span>
<span id="cb165-45"><a href="models.html#cb165-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb165-46"><a href="models.html#cb165-46" aria-hidden="true" tabindex="-1"></a>        betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c],<span class="dv">1</span>)</span>
<span id="cb165-47"><a href="models.html#cb165-47" aria-hidden="true" tabindex="-1"></a>        betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c],<span class="dv">1</span>)</span>
<span id="cb165-48"><a href="models.html#cb165-48" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb165-49"><a href="models.html#cb165-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-50"><a href="models.html#cb165-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-51"><a href="models.html#cb165-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># back-transform for examining output</span></span>
<span id="cb165-52"><a href="models.html#cb165-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb165-53"><a href="models.html#cb165-53" aria-hidden="true" tabindex="-1"></a>        betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb165-54"><a href="models.html#cb165-54" aria-hidden="true" tabindex="-1"></a>        betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb165-55"><a href="models.html#cb165-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb165-56"><a href="models.html#cb165-56" aria-hidden="true" tabindex="-1"></a>        betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb165-57"><a href="models.html#cb165-57" aria-hidden="true" tabindex="-1"></a>        betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb165-58"><a href="models.html#cb165-58" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb165-59"><a href="models.html#cb165-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-60"><a href="models.html#cb165-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-61"><a href="models.html#cb165-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb165-62"><a href="models.html#cb165-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb165-63"><a href="models.html#cb165-63" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">1</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">1</span>,c],<span class="dv">1</span>)</span>
<span id="cb165-64"><a href="models.html#cb165-64" aria-hidden="true" tabindex="-1"></a>        betaFlow[<span class="dv">2</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">2</span>,c],<span class="dv">1</span>)</span>
<span id="cb165-65"><a href="models.html#cb165-65" aria-hidden="true" tabindex="-1"></a>      }   </span>
<span id="cb165-66"><a href="models.html#cb165-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-67"><a href="models.html#cb165-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-68"><a href="models.html#cb165-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood</span></span>
<span id="cb165-69"><a href="models.html#cb165-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb165-70"><a href="models.html#cb165-70" aria-hidden="true" tabindex="-1"></a>      z[i,first[i]] <span class="sc">~</span> <span class="fu">dcat</span>(delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb165-71"><a href="models.html#cb165-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(last[i])){</span>
<span id="cb165-72"><a href="models.html#cb165-72" aria-hidden="true" tabindex="-1"></a>        z[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(gamma[z[i,j<span class="dv">-1</span>], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb165-73"><a href="models.html#cb165-73" aria-hidden="true" tabindex="-1"></a>        y[i,j] <span class="sc">~</span> <span class="fu">dcat</span>(omega[z[i,j], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, j<span class="dv">-1</span>, i])</span>
<span id="cb165-74"><a href="models.html#cb165-74" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb165-75"><a href="models.html#cb165-75" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb165-76"><a href="models.html#cb165-76" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb165-77"><a href="models.html#cb165-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb165-78"><a href="models.html#cb165-78" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb165-79"><a href="models.html#cb165-79" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb165-80"><a href="models.html#cb165-80" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb165-81"><a href="models.html#cb165-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-82"><a href="models.html#cb165-82" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb165-83"><a href="models.html#cb165-83" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb165-84"><a href="models.html#cb165-84" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb165-85"><a href="models.html#cb165-85" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb165-86"><a href="models.html#cb165-86" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort, </span>
<span id="cb165-87"><a href="models.html#cb165-87" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb165-88"><a href="models.html#cb165-88" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb165-89"><a href="models.html#cb165-89" aria-hidden="true" tabindex="-1"></a>                       <span class="at">flow =</span> eh<span class="sc">$</span>flow</span>
<span id="cb165-90"><a href="models.html#cb165-90" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb165-91"><a href="models.html#cb165-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-92"><a href="models.html#cb165-92" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb165-93"><a href="models.html#cb165-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-94"><a href="models.html#cb165-94" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb165-95"><a href="models.html#cb165-95" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb165-96"><a href="models.html#cb165-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-97"><a href="models.html#cb165-97" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb165-98"><a href="models.html#cb165-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-99"><a href="models.html#cb165-99" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb165-100"><a href="models.html#cb165-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb165-101"><a href="models.html#cb165-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb165-102"><a href="models.html#cb165-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> myConstants<span class="sc">$</span>N, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), myConstants<span class="sc">$</span>N)),</span>
<span id="cb165-103"><a href="models.html#cb165-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> zInitsNA,</span>
<span id="cb165-104"><a href="models.html#cb165-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb165-105"><a href="models.html#cb165-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb165-106"><a href="models.html#cb165-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb165-107"><a href="models.html#cb165-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb165-108"><a href="models.html#cb165-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, nCohorts)),</span>
<span id="cb165-109"><a href="models.html#cb165-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlowCohort =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, nCohorts)),</span>
<span id="cb165-110"><a href="models.html#cb165-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">betaFlowTop =</span> <span class="fu">rnorm</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb165-111"><a href="models.html#cb165-111" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb165-112"><a href="models.html#cb165-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-113"><a href="models.html#cb165-113" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb165-114"><a href="models.html#cb165-114" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb165-115"><a href="models.html#cb165-115" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb165-116"><a href="models.html#cb165-116" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>,</span>
<span id="cb165-117"><a href="models.html#cb165-117" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlowCohort&quot;</span>, <span class="st">&quot;betaFlowTop&quot;</span>)  </span>
<span id="cb165-118"><a href="models.html#cb165-118" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span> <span class="co">#30000</span></span>
<span id="cb165-119"><a href="models.html#cb165-119" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="co">#15000</span></span>
<span id="cb165-120"><a href="models.html#cb165-120" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb165-121"><a href="models.html#cb165-121" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb165-122"><a href="models.html#cb165-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-123"><a href="models.html#cb165-123" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb165-124"><a href="models.html#cb165-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-125"><a href="models.html#cb165-125" aria-hidden="true" tabindex="-1"></a>  Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb165-126"><a href="models.html#cb165-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> hmm.phiT_pT_cohort_flowCohortHier, </span>
<span id="cb165-127"><a href="models.html#cb165-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> myConstants,</span>
<span id="cb165-128"><a href="models.html#cb165-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> myData,              </span>
<span id="cb165-129"><a href="models.html#cb165-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb165-130"><a href="models.html#cb165-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb165-131"><a href="models.html#cb165-131" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb165-132"><a href="models.html#cb165-132" aria-hidden="true" tabindex="-1"></a>  conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb165-133"><a href="models.html#cb165-133" aria-hidden="true" tabindex="-1"></a>    Rmodel,</span>
<span id="cb165-134"><a href="models.html#cb165-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">monitors =</span> parametersToSave</span>
<span id="cb165-135"><a href="models.html#cb165-135" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb165-136"><a href="models.html#cb165-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-137"><a href="models.html#cb165-137" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb165-138"><a href="models.html#cb165-138" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb165-139"><a href="models.html#cb165-139" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb165-140"><a href="models.html#cb165-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-141"><a href="models.html#cb165-141" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flowCohortHier <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb165-142"><a href="models.html#cb165-142" aria-hidden="true" tabindex="-1"></a>    Cmcmc, </span>
<span id="cb165-143"><a href="models.html#cb165-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> nIter, </span>
<span id="cb165-144"><a href="models.html#cb165-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb165-145"><a href="models.html#cb165-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> thinRate, </span>
<span id="cb165-146"><a href="models.html#cb165-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nChains</span>
<span id="cb165-147"><a href="models.html#cb165-147" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb165-148"><a href="models.html#cb165-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-149"><a href="models.html#cb165-149" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb165-150"><a href="models.html#cb165-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-151"><a href="models.html#cb165-151" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flowCohortHier <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb165-152"><a href="models.html#cb165-152" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb165-153"><a href="models.html#cb165-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flowCohortHier, </span>
<span id="cb165-154"><a href="models.html#cb165-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flowCohortHier,</span>
<span id="cb165-155"><a href="models.html#cb165-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flowCohortHier&quot;</span>,</span>
<span id="cb165-156"><a href="models.html#cb165-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">myConstants =</span> myConstants, </span>
<span id="cb165-157"><a href="models.html#cb165-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">nIter =</span> nIter, </span>
<span id="cb165-158"><a href="models.html#cb165-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb165-159"><a href="models.html#cb165-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">thinRate =</span> thinRate, </span>
<span id="cb165-160"><a href="models.html#cb165-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb165-161"><a href="models.html#cb165-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb165-162"><a href="models.html#cb165-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">nChains =</span> nChains</span>
<span id="cb165-163"><a href="models.html#cb165-163" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb165-164"><a href="models.html#cb165-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb165-165"><a href="models.html#cb165-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_mostRecent.RData&#39;</span>)</span>
<span id="cb165-166"><a href="models.html#cb165-166" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb165-167"><a href="models.html#cb165-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_mostRecent.RData&#39;</span>)</span>
<span id="cb165-168"><a href="models.html#cb165-168" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb165-169"><a href="models.html#cb165-169" aria-hidden="true" tabindex="-1"></a><span class="co"># could consider forward algo to speed up convergence (https://oliviergimenez.github.io/banana-book/hmmcapturerecapture.html#nimble-implementation-1)</span></span>
<span id="cb165-170"><a href="models.html#cb165-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-171"><a href="models.html#cb165-171" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb165-172"><a href="models.html#cb165-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb165-173"><a href="models.html#cb165-173" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT_cohort_flowHier, round = 2)</span></span>
<span id="cb165-174"><a href="models.html#cb165-174" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flowHier, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb165-175"><a href="models.html#cb165-175" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlowTop&quot;</span>)</span>
<span id="cb165-176"><a href="models.html#cb165-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb165-177"><a href="models.html#cb165-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb165-178"><a href="models.html#cb165-178" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohort&quot;</span>))</span>
<span id="cb165-179"><a href="models.html#cb165-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb165-180"><a href="models.html#cb165-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowCohort&quot;</span>))</span>
<span id="cb165-181"><a href="models.html#cb165-181" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-182"><a href="models.html#cb165-182" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(.<span class="dv">1</span>))</span>
<span id="cb165-183"><a href="models.html#cb165-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb165-184"><a href="models.html#cb165-184" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb165-185"><a href="models.html#cb165-185" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb165-186"><a href="models.html#cb165-186" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowTop&quot;</span>),</span>
<span id="cb165-187"><a href="models.html#cb165-187" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb165-188"><a href="models.html#cb165-188" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb165-189"><a href="models.html#cb165-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-190"><a href="models.html#cb165-190" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb165-191"><a href="models.html#cb165-191" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb165-192"><a href="models.html#cb165-192" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb165-193"><a href="models.html#cb165-193" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb165-194"><a href="models.html#cb165-194" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb165-195"><a href="models.html#cb165-195" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb165-196"><a href="models.html#cb165-196" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb165-197"><a href="models.html#cb165-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb165-198"><a href="models.html#cb165-198" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb165-199"><a href="models.html#cb165-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb165-200"><a href="models.html#cb165-200" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb165-201"><a href="models.html#cb165-201" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb165-202"><a href="models.html#cb165-202" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb165-203"><a href="models.html#cb165-203" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb165-204"><a href="models.html#cb165-204" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb165-205"><a href="models.html#cb165-205" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-27.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-28.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-29.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-30.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-31.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-32.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-33.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-34.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-35.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-36.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-37.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-38.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-39.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-40.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-41.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-42.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-43.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-44.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-45.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-46.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHier-47.png" width="672" /></p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="models.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run more iterations, if necessary</span></span>
<span id="cb166-2"><a href="models.html#cb166-2" aria-hidden="true" tabindex="-1"></a><span class="co"># nIterAdd &lt;- 5000</span></span>
<span id="cb166-3"><a href="models.html#cb166-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cmcmc$run(nIterAdd, reset = FALSE)</span></span>
<span id="cb166-4"><a href="models.html#cb166-4" aria-hidden="true" tabindex="-1"></a><span class="co"># more_samples &lt;- as.matrix(Cmcmc$mvSamples)</span></span>
<span id="cb166-5"><a href="models.html#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb166-6"><a href="models.html#cb166-6" aria-hidden="true" tabindex="-1"></a><span class="co"># MCMCtrace(object = more_samples,</span></span>
<span id="cb166-7"><a href="models.html#cb166-7" aria-hidden="true" tabindex="-1"></a><span class="co">#           #ISB = FALSE,</span></span>
<span id="cb166-8"><a href="models.html#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="co">#           #exact = TRUE, </span></span>
<span id="cb166-9"><a href="models.html#cb166-9" aria-hidden="true" tabindex="-1"></a><span class="co">#           params = c(&quot;betaFlow&quot;),</span></span>
<span id="cb166-10"><a href="models.html#cb166-10" aria-hidden="true" tabindex="-1"></a><span class="co">#           pdf = FALSE, </span></span>
<span id="cb166-11"><a href="models.html#cb166-11" aria-hidden="true" tabindex="-1"></a><span class="co">#           priors = priors)</span></span></code></pre></div>
</div>
<div id="get-flow-effect-estimates-2" class="section level4 hasAnchor" number="3.3.6.2">
<h4><span class="header-section-number">3.3.6.2</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects vary across cohorts - hierarchical</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="models.html#cb167-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb167-2"><a href="models.html#cb167-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb167-3"><a href="models.html#cb167-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t],cohort[i]] * flow[i,t] +</span></span>
<span id="cb167-4"><a href="models.html#cb167-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t],cohort[i]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb167-5"><a href="models.html#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="models.html#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHier_mostRecent.RData&#39;</span>)</span>
<span id="cb167-7"><a href="models.html#cb167-7" aria-hidden="true" tabindex="-1"></a>predFlowCohortHier <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowCohort</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-predictions" class="section level4 hasAnchor" number="3.3.6.3">
<h4><span class="header-section-number">3.3.6.3</span> Plot predictions<a href="models.html#plot-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="models.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlowCohortHier, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb168-2"><a href="models.html#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb168-3"><a href="models.html#cb168-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="models.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb169-2"><a href="models.html#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb169-3"><a href="models.html#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb169-4"><a href="models.html#cb169-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb169-5"><a href="models.html#cb169-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb169-6"><a href="models.html#cb169-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb169-7"><a href="models.html#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb169-8"><a href="models.html#cb169-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb169-9"><a href="models.html#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb169-10"><a href="models.html#cb169-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(alpha = 0.1) +</span></span>
<span id="cb169-11"><a href="models.html#cb169-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
<div id="betaflowtop-predictions" class="section level4 hasAnchor" number="3.3.6.4">
<h4><span class="header-section-number">3.3.6.4</span> BetaflowTop predictions<a href="models.html#betaflowtop-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="models.html#cb170-1" aria-hidden="true" tabindex="-1"></a>getPredictionsFlowTop <span class="ot">&lt;-</span> <span class="cf">function</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>, <span class="at">flowStep =</span> <span class="fl">0.5</span>){</span>
<span id="cb170-2"><a href="models.html#cb170-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-3"><a href="models.html#cb170-3" aria-hidden="true" tabindex="-1"></a>  mcmc <span class="ot">&lt;-</span> toSave<span class="sc">$</span>mcmc</span>
<span id="cb170-4"><a href="models.html#cb170-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-5"><a href="models.html#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## betaFlow</span></span>
<span id="cb170-6"><a href="models.html#cb170-6" aria-hidden="true" tabindex="-1"></a>  predictorsBetaFlowTop <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb170-7"><a href="models.html#cb170-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">dim</span>(mcmc<span class="sc">$</span>chain1)[<span class="dv">1</span>], everyNIters),</span>
<span id="cb170-8"><a href="models.html#cb170-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">var =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,</span>
<span id="cb170-9"><a href="models.html#cb170-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">flow =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>, flowStep)</span>
<span id="cb170-10"><a href="models.html#cb170-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb170-11"><a href="models.html#cb170-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-12"><a href="models.html#cb170-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predictorsBetaFlowTop)){</span>
<span id="cb170-13"><a href="models.html#cb170-13" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlowTop<span class="sc">$</span>betaFlowTop1[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlowTop[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb170-14"><a href="models.html#cb170-14" aria-hidden="true" tabindex="-1"></a>                                                         <span class="dv">1</span></span>
<span id="cb170-15"><a href="models.html#cb170-15" aria-hidden="true" tabindex="-1"></a>                                                        ]]</span>
<span id="cb170-16"><a href="models.html#cb170-16" aria-hidden="true" tabindex="-1"></a>    predictorsBetaFlowTop<span class="sc">$</span>betaFlowTop2[i] <span class="ot">&lt;-</span> mcmc<span class="sc">$</span>chain1[[predictorsBetaFlowTop[i, <span class="st">&quot;iter&quot;</span>], </span>
<span id="cb170-17"><a href="models.html#cb170-17" aria-hidden="true" tabindex="-1"></a>                                                         <span class="dv">2</span></span>
<span id="cb170-18"><a href="models.html#cb170-18" aria-hidden="true" tabindex="-1"></a>                                                        ]]</span>
<span id="cb170-19"><a href="models.html#cb170-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb170-20"><a href="models.html#cb170-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-21"><a href="models.html#cb170-21" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> predictorsBetaFlowTop <span class="sc">%&gt;%</span></span>
<span id="cb170-22"><a href="models.html#cb170-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">predPhi =</span> <span class="fu">plogis</span>(betaFlowTop1 <span class="sc">*</span> flow <span class="sc">+</span> betaFlowTop2 <span class="sc">*</span> flow <span class="sc">*</span> flow))</span>
<span id="cb170-23"><a href="models.html#cb170-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb170-24"><a href="models.html#cb170-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(preds)</span>
<span id="cb170-25"><a href="models.html#cb170-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb170-26"><a href="models.html#cb170-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-27"><a href="models.html#cb170-27" aria-hidden="true" tabindex="-1"></a>predBetaFlowTop <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowTop</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>)</span>
<span id="cb170-28"><a href="models.html#cb170-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb170-29"><a href="models.html#cb170-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTop, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb170-30"><a href="models.html#cb170-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="co">#+</span></span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="models.html#cb171-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#facet_wrap(~iter)</span></span>
<span id="cb171-2"><a href="models.html#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="models.html#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTop, <span class="fu">aes</span>(betaFlowTop1, betaFlowTop2)) <span class="sc">+</span></span>
<span id="cb171-4"><a href="models.html#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-23-2.png" width="672" /></p>
</div>
</div>
<div id="model-phit_pt_cohort_flowcohorthiercjs" class="section level3 hasAnchor" number="3.3.7">
<h3><span class="header-section-number">3.3.7</span> Model phiT_pT_cohort_flowCohortHierCJS<a href="models.html#model-phit_pt_cohort_flowcohorthiercjs" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Flow effects vary by cohort, hierarchical across cohorts
Same as previous model, but using nimble Ecology to run models</p>
<div id="set-up-and-run-model-6" class="section level4 hasAnchor" number="3.3.7.1">
<h4><span class="header-section-number">3.3.7.1</span> Set up and run model<a href="models.html#set-up-and-run-model-6" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="models.html#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb172-2"><a href="models.html#cb172-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-3"><a href="models.html#cb172-3" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb172-4"><a href="models.html#cb172-4" aria-hidden="true" tabindex="-1"></a>  (nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts)))</span>
<span id="cb172-5"><a href="models.html#cb172-5" aria-hidden="true" tabindex="-1"></a>  (nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons)))</span>
<span id="cb172-6"><a href="models.html#cb172-6" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb172-7"><a href="models.html#cb172-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-8"><a href="models.html#cb172-8" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb172-9"><a href="models.html#cb172-9" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb172-10"><a href="models.html#cb172-10" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb172-11"><a href="models.html#cb172-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-12"><a href="models.html#cb172-12" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb172-13"><a href="models.html#cb172-13" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb172-14"><a href="models.html#cb172-14" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb172-15"><a href="models.html#cb172-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-16"><a href="models.html#cb172-16" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb172-17"><a href="models.html#cb172-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb172-18"><a href="models.html#cb172-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">first =</span> first,</span>
<span id="cb172-19"><a href="models.html#cb172-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">last =</span> last,</span>
<span id="cb172-20"><a href="models.html#cb172-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cohort =</span> cohort, </span>
<span id="cb172-21"><a href="models.html#cb172-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb172-22"><a href="models.html#cb172-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb172-23"><a href="models.html#cb172-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">flow =</span> eh<span class="sc">$</span>flow,</span>
<span id="cb172-24"><a href="models.html#cb172-24" aria-hidden="true" tabindex="-1"></a>                      <span class="do">## DT changes:</span></span>
<span id="cb172-25"><a href="models.html#cb172-25" aria-hidden="true" tabindex="-1"></a>                      <span class="do">## this is used by both the dCJS and dDHMM distributions</span></span>
<span id="cb172-26"><a href="models.html#cb172-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">length =</span> last <span class="sc">-</span> first <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb172-27"><a href="models.html#cb172-27" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb172-28"><a href="models.html#cb172-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-29"><a href="models.html#cb172-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## DT changes:</span></span>
<span id="cb172-30"><a href="models.html#cb172-30" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">yCJS =</span> y,    <span class="do">## data for CJS distribution</span></span>
<span id="cb172-31"><a href="models.html#cb172-31" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)   <span class="do">## data for DHMM distribution</span></span>
<span id="cb172-32"><a href="models.html#cb172-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-33"><a href="models.html#cb172-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-34"><a href="models.html#cb172-34" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb172-35"><a href="models.html#cb172-35" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb172-36"><a href="models.html#cb172-36" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## DT change:</span></span>
<span id="cb172-37"><a href="models.html#cb172-37" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## don&#39;t give phi and p initial values;</span></span>
<span id="cb172-38"><a href="models.html#cb172-38" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## they&#39;re deterministic nodes, so they&#39;ll be calculated</span></span>
<span id="cb172-39"><a href="models.html#cb172-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## in terms of other variables.  Also, when I made changes to these</span></span>
<span id="cb172-40"><a href="models.html#cb172-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## in the code, these (unnecessary) initial values were the wrong sizes</span></span>
<span id="cb172-41"><a href="models.html#cb172-41" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">##phi = array(runif((myConstants$T - 1) * myConstants$N, 0, 1),c((myConstants$T - 1), myConstants$N)),</span></span>
<span id="cb172-42"><a href="models.html#cb172-42" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">##p =   array(runif((myConstants$T - 1) * myConstants$N, 0, 1),c((myConstants$T - 1), myConstants$N)),</span></span>
<span id="cb172-43"><a href="models.html#cb172-43" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">z =</span> zInitsNA,</span>
<span id="cb172-44"><a href="models.html#cb172-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb172-45"><a href="models.html#cb172-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb172-46"><a href="models.html#cb172-46" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb172-47"><a href="models.html#cb172-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb172-48"><a href="models.html#cb172-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, nCohorts)),</span>
<span id="cb172-49"><a href="models.html#cb172-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaFlowCohort =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, nCohorts)),</span>
<span id="cb172-50"><a href="models.html#cb172-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaFlowTop =</span> <span class="fu">rnorm</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb172-51"><a href="models.html#cb172-51" aria-hidden="true" tabindex="-1"></a>                              )</span>
<span id="cb172-52"><a href="models.html#cb172-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-53"><a href="models.html#cb172-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-54"><a href="models.html#cb172-54" aria-hidden="true" tabindex="-1"></a>  <span class="do">## if you change this FALSE to TRUE</span></span>
<span id="cb172-55"><a href="models.html#cb172-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this makes the dataset smaller - only 200 observations,</span></span>
<span id="cb172-56"><a href="models.html#cb172-56" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for quicker testing</span></span>
<span id="cb172-57"><a href="models.html#cb172-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">FALSE</span>) {</span>
<span id="cb172-58"><a href="models.html#cb172-58" aria-hidden="true" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb172-59"><a href="models.html#cb172-59" aria-hidden="true" tabindex="-1"></a>      oldN <span class="ot">&lt;-</span> <span class="fu">dim</span>(y)[<span class="dv">1</span>]</span>
<span id="cb172-60"><a href="models.html#cb172-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb172-61"><a href="models.html#cb172-61" aria-hidden="true" tabindex="-1"></a>      indToKeep <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>oldN, <span class="at">size =</span> newN, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb172-62"><a href="models.html#cb172-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-63"><a href="models.html#cb172-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-64"><a href="models.html#cb172-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this removes the very last observation,</span></span>
<span id="cb172-65"><a href="models.html#cb172-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## since first[2376] = T = 12, which is not allowed</span></span>
<span id="cb172-66"><a href="models.html#cb172-66" aria-hidden="true" tabindex="-1"></a>  <span class="do">## to have the first observation occur on the final sampling period</span></span>
<span id="cb172-67"><a href="models.html#cb172-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for either CJS or DHMM distributions</span></span>
<span id="cb172-68"><a href="models.html#cb172-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">TRUE</span>) {</span>
<span id="cb172-69"><a href="models.html#cb172-69" aria-hidden="true" tabindex="-1"></a>      indToKeep <span class="ot">&lt;-</span> <span class="fu">which</span>(first <span class="sc">&lt;</span> <span class="dv">12</span>)</span>
<span id="cb172-70"><a href="models.html#cb172-70" aria-hidden="true" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="fu">length</span>(indToKeep)</span>
<span id="cb172-71"><a href="models.html#cb172-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb172-72"><a href="models.html#cb172-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-73"><a href="models.html#cb172-73" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb172-74"><a href="models.html#cb172-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> newN,</span>
<span id="cb172-75"><a href="models.html#cb172-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">T =</span> myConstants<span class="sc">$</span>T,</span>
<span id="cb172-76"><a href="models.html#cb172-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">first =</span> myConstants<span class="sc">$</span>first[indToKeep],</span>
<span id="cb172-77"><a href="models.html#cb172-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">last =</span> myConstants<span class="sc">$</span>last[indToKeep],</span>
<span id="cb172-78"><a href="models.html#cb172-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">cohort =</span> myConstants<span class="sc">$</span>cohort[indToKeep],</span>
<span id="cb172-79"><a href="models.html#cb172-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> myConstants<span class="sc">$</span>nCohorts,</span>
<span id="cb172-80"><a href="models.html#cb172-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">season =</span> myConstants<span class="sc">$</span>season,</span>
<span id="cb172-81"><a href="models.html#cb172-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> myConstants<span class="sc">$</span>flow[indToKeep,],</span>
<span id="cb172-82"><a href="models.html#cb172-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">length =</span> myConstants<span class="sc">$</span>length[indToKeep]</span>
<span id="cb172-83"><a href="models.html#cb172-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-84"><a href="models.html#cb172-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-85"><a href="models.html#cb172-85" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb172-86"><a href="models.html#cb172-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">yCJS =</span> myData<span class="sc">$</span>yCJS[indToKeep,],</span>
<span id="cb172-87"><a href="models.html#cb172-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> myData<span class="sc">$</span>y[indToKeep,]</span>
<span id="cb172-88"><a href="models.html#cb172-88" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-89"><a href="models.html#cb172-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-90"><a href="models.html#cb172-90" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> zInitsNA[indToKeep,]</span>
<span id="cb172-91"><a href="models.html#cb172-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-92"><a href="models.html#cb172-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-93"><a href="models.html#cb172-93" aria-hidden="true" tabindex="-1"></a>  <span class="do">## code using CJS distribution</span></span>
<span id="cb172-94"><a href="models.html#cb172-94" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flowCohortHierCJS <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb172-95"><a href="models.html#cb172-95" aria-hidden="true" tabindex="-1"></a>      <span class="do">## DT changes:</span></span>
<span id="cb172-96"><a href="models.html#cb172-96" aria-hidden="true" tabindex="-1"></a>      <span class="do">##delta[1] &lt;- 1                    # Pr(alive t = 1) = 1</span></span>
<span id="cb172-97"><a href="models.html#cb172-97" aria-hidden="true" tabindex="-1"></a>      <span class="do">##delta[2] &lt;- 0                    # Pr(dead t = 1) = 0</span></span>
<span id="cb172-98"><a href="models.html#cb172-98" aria-hidden="true" tabindex="-1"></a>      <span class="do">##</span></span>
<span id="cb172-99"><a href="models.html#cb172-99" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb172-100"><a href="models.html#cb172-100" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb172-101"><a href="models.html#cb172-101" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb172-102"><a href="models.html#cb172-102" aria-hidden="true" tabindex="-1"></a>                  betaInt <span class="sc">+</span></span>
<span id="cb172-103"><a href="models.html#cb172-103" aria-hidden="true" tabindex="-1"></a>                  betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb172-104"><a href="models.html#cb172-104" aria-hidden="true" tabindex="-1"></a>                  betaFlow[<span class="dv">1</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb172-105"><a href="models.html#cb172-105" aria-hidden="true" tabindex="-1"></a>                  betaFlow[<span class="dv">2</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb172-106"><a href="models.html#cb172-106" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb172-107"><a href="models.html#cb172-107" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb172-108"><a href="models.html#cb172-108" aria-hidden="true" tabindex="-1"></a>          <span class="do">## time t = first[i]:</span></span>
<span id="cb172-109"><a href="models.html#cb172-109" aria-hidden="true" tabindex="-1"></a>          <span class="do">## note this first value of p[] is not acually used by the dCJS distribution,</span></span>
<span id="cb172-110"><a href="models.html#cb172-110" aria-hidden="true" tabindex="-1"></a>          <span class="do">## but we include it for correctness</span></span>
<span id="cb172-111"><a href="models.html#cb172-111" aria-hidden="true" tabindex="-1"></a>          p[first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb172-112"><a href="models.html#cb172-112" aria-hidden="true" tabindex="-1"></a>          <span class="do">## time t &gt; first[i]:</span></span>
<span id="cb172-113"><a href="models.html#cb172-113" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span>(t <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]) {</span>
<span id="cb172-114"><a href="models.html#cb172-114" aria-hidden="true" tabindex="-1"></a>              <span class="do">## DT changes:</span></span>
<span id="cb172-115"><a href="models.html#cb172-115" aria-hidden="true" tabindex="-1"></a>              <span class="do">## note the indexing on betaP:</span></span>
<span id="cb172-116"><a href="models.html#cb172-116" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t<span class="dv">-1</span>,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb172-117"><a href="models.html#cb172-117" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb172-118"><a href="models.html#cb172-118" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb172-119"><a href="models.html#cb172-119" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb172-120"><a href="models.html#cb172-120" aria-hidden="true" tabindex="-1"></a>      betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb172-121"><a href="models.html#cb172-121" aria-hidden="true" tabindex="-1"></a>      betaFlowTop[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb172-122"><a href="models.html#cb172-122" aria-hidden="true" tabindex="-1"></a>      betaFlowTop[<span class="dv">2</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb172-123"><a href="models.html#cb172-123" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb172-124"><a href="models.html#cb172-124" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb172-125"><a href="models.html#cb172-125" aria-hidden="true" tabindex="-1"></a>          <span class="co"># mean values</span></span>
<span id="cb172-126"><a href="models.html#cb172-126" aria-hidden="true" tabindex="-1"></a>          betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb172-127"><a href="models.html#cb172-127" aria-hidden="true" tabindex="-1"></a>          betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb172-128"><a href="models.html#cb172-128" aria-hidden="true" tabindex="-1"></a>          betaFlowCohort[<span class="dv">1</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">1</span>],<span class="dv">1</span>)</span>
<span id="cb172-129"><a href="models.html#cb172-129" aria-hidden="true" tabindex="-1"></a>          betaFlowCohort[<span class="dv">2</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">2</span>],<span class="dv">1</span>)</span>
<span id="cb172-130"><a href="models.html#cb172-130" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb172-131"><a href="models.html#cb172-131" aria-hidden="true" tabindex="-1"></a>              betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c],<span class="dv">1</span>)</span>
<span id="cb172-132"><a href="models.html#cb172-132" aria-hidden="true" tabindex="-1"></a>              betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c],<span class="dv">1</span>)</span>
<span id="cb172-133"><a href="models.html#cb172-133" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb172-134"><a href="models.html#cb172-134" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb172-135"><a href="models.html#cb172-135" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb172-136"><a href="models.html#cb172-136" aria-hidden="true" tabindex="-1"></a>      <span class="co"># back-transform for examining output</span></span>
<span id="cb172-137"><a href="models.html#cb172-137" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb172-138"><a href="models.html#cb172-138" aria-hidden="true" tabindex="-1"></a>          betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb172-139"><a href="models.html#cb172-139" aria-hidden="true" tabindex="-1"></a>          betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb172-140"><a href="models.html#cb172-140" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb172-141"><a href="models.html#cb172-141" aria-hidden="true" tabindex="-1"></a>              betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb172-142"><a href="models.html#cb172-142" aria-hidden="true" tabindex="-1"></a>              betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb172-143"><a href="models.html#cb172-143" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb172-144"><a href="models.html#cb172-144" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb172-145"><a href="models.html#cb172-145" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb172-146"><a href="models.html#cb172-146" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb172-147"><a href="models.html#cb172-147" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb172-148"><a href="models.html#cb172-148" aria-hidden="true" tabindex="-1"></a>              betaFlow[<span class="dv">1</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">1</span>,c],<span class="dv">1</span>)</span>
<span id="cb172-149"><a href="models.html#cb172-149" aria-hidden="true" tabindex="-1"></a>              betaFlow[<span class="dv">2</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">2</span>,c],<span class="dv">1</span>)</span>
<span id="cb172-150"><a href="models.html#cb172-150" aria-hidden="true" tabindex="-1"></a>          }   </span>
<span id="cb172-151"><a href="models.html#cb172-151" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb172-152"><a href="models.html#cb172-152" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb172-153"><a href="models.html#cb172-153" aria-hidden="true" tabindex="-1"></a>      <span class="co"># likelihood</span></span>
<span id="cb172-154"><a href="models.html#cb172-154" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb172-155"><a href="models.html#cb172-155" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb172-156"><a href="models.html#cb172-156" aria-hidden="true" tabindex="-1"></a>          <span class="do">##z[i,first[i]] ~ dcat(delta[1:2])</span></span>
<span id="cb172-157"><a href="models.html#cb172-157" aria-hidden="true" tabindex="-1"></a>          <span class="do">##for (j in (first[i]+1):(last[i])){</span></span>
<span id="cb172-158"><a href="models.html#cb172-158" aria-hidden="true" tabindex="-1"></a>          <span class="do">##    z[i,j] ~ dcat(gamma[z[i,j-1], 1:2, j-1, i])</span></span>
<span id="cb172-159"><a href="models.html#cb172-159" aria-hidden="true" tabindex="-1"></a>          <span class="do">##    y[i,j] ~ dcat(omega[z[i,j], 1:2, j-1, i])</span></span>
<span id="cb172-160"><a href="models.html#cb172-160" aria-hidden="true" tabindex="-1"></a>          <span class="do">##}</span></span>
<span id="cb172-161"><a href="models.html#cb172-161" aria-hidden="true" tabindex="-1"></a>          yCJS[i,first[i]<span class="sc">:</span>last[i]] <span class="sc">~</span> <span class="fu">dCJS_vv</span>(<span class="at">probSurvive =</span> phi[first[i]<span class="sc">:</span>last[i], i],</span>
<span id="cb172-162"><a href="models.html#cb172-162" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">probCapture =</span> p[first[i]<span class="sc">:</span>last[i], i],</span>
<span id="cb172-163"><a href="models.html#cb172-163" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">len =</span> length[i])</span>
<span id="cb172-164"><a href="models.html#cb172-164" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb172-165"><a href="models.html#cb172-165" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb172-166"><a href="models.html#cb172-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-167"><a href="models.html#cb172-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb172-168"><a href="models.html#cb172-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-169"><a href="models.html#cb172-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>(</span>
<span id="cb172-170"><a href="models.html#cb172-170" aria-hidden="true" tabindex="-1"></a>      Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb172-171"><a href="models.html#cb172-171" aria-hidden="true" tabindex="-1"></a>          <span class="at">code =</span> hmm.phiT_pT_cohort_flowCohortHierCJS,</span>
<span id="cb172-172"><a href="models.html#cb172-172" aria-hidden="true" tabindex="-1"></a>          <span class="at">constants =</span> myConstants,</span>
<span id="cb172-173"><a href="models.html#cb172-173" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> myData,              </span>
<span id="cb172-174"><a href="models.html#cb172-174" aria-hidden="true" tabindex="-1"></a>          <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb172-175"><a href="models.html#cb172-175" aria-hidden="true" tabindex="-1"></a>          <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb172-176"><a href="models.html#cb172-176" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb172-177"><a href="models.html#cb172-177" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-178"><a href="models.html#cb172-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-179"><a href="models.html#cb172-179" aria-hidden="true" tabindex="-1"></a>  Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb172-180"><a href="models.html#cb172-180" aria-hidden="true" tabindex="-1"></a>  <span class="do">## latent state (200 ind): -2847.746</span></span>
<span id="cb172-181"><a href="models.html#cb172-181" aria-hidden="true" tabindex="-1"></a>  <span class="do">## dCJS_vv (200 individuals): -1199.098</span></span>
<span id="cb172-182"><a href="models.html#cb172-182" aria-hidden="true" tabindex="-1"></a>  <span class="do">## dCJS_vv (all but last observation): -1217.127</span></span>
<span id="cb172-183"><a href="models.html#cb172-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-184"><a href="models.html#cb172-184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-185"><a href="models.html#cb172-185" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb172-186"><a href="models.html#cb172-186" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb172-187"><a href="models.html#cb172-187" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb172-188"><a href="models.html#cb172-188" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>,</span>
<span id="cb172-189"><a href="models.html#cb172-189" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlowCohort&quot;</span>, <span class="st">&quot;betaFlowTop&quot;</span>)  </span>
<span id="cb172-190"><a href="models.html#cb172-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-191"><a href="models.html#cb172-191" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span> <span class="co">#30000</span></span>
<span id="cb172-192"><a href="models.html#cb172-192" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="co">#15000</span></span>
<span id="cb172-193"><a href="models.html#cb172-193" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb172-194"><a href="models.html#cb172-194" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb172-195"><a href="models.html#cb172-195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-196"><a href="models.html#cb172-196" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb172-197"><a href="models.html#cb172-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-198"><a href="models.html#cb172-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>(</span>
<span id="cb172-199"><a href="models.html#cb172-199" aria-hidden="true" tabindex="-1"></a>      conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb172-200"><a href="models.html#cb172-200" aria-hidden="true" tabindex="-1"></a>          Rmodel,</span>
<span id="cb172-201"><a href="models.html#cb172-201" aria-hidden="true" tabindex="-1"></a>          <span class="at">monitors =</span> parametersToSave</span>
<span id="cb172-202"><a href="models.html#cb172-202" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb172-203"><a href="models.html#cb172-203" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-204"><a href="models.html#cb172-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-205"><a href="models.html#cb172-205" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb172-206"><a href="models.html#cb172-206" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb172-207"><a href="models.html#cb172-207" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb172-208"><a href="models.html#cb172-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-209"><a href="models.html#cb172-209" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flowCohortHierCJS <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb172-210"><a href="models.html#cb172-210" aria-hidden="true" tabindex="-1"></a>      Cmcmc, </span>
<span id="cb172-211"><a href="models.html#cb172-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">niter =</span> nIter, </span>
<span id="cb172-212"><a href="models.html#cb172-212" aria-hidden="true" tabindex="-1"></a>      <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb172-213"><a href="models.html#cb172-213" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> thinRate, </span>
<span id="cb172-214"><a href="models.html#cb172-214" aria-hidden="true" tabindex="-1"></a>      <span class="at">nchains =</span> nChains</span>
<span id="cb172-215"><a href="models.html#cb172-215" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-216"><a href="models.html#cb172-216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-217"><a href="models.html#cb172-217" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb172-218"><a href="models.html#cb172-218" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-219"><a href="models.html#cb172-219" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flowCohortHierCJS <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb172-220"><a href="models.html#cb172-220" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb172-221"><a href="models.html#cb172-221" aria-hidden="true" tabindex="-1"></a>      <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flowCohortHierCJS, </span>
<span id="cb172-222"><a href="models.html#cb172-222" aria-hidden="true" tabindex="-1"></a>      <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flowCohortHierCJS,</span>
<span id="cb172-223"><a href="models.html#cb172-223" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flowCohortHierCJS&quot;</span>,</span>
<span id="cb172-224"><a href="models.html#cb172-224" aria-hidden="true" tabindex="-1"></a>      <span class="at">myConstants =</span> myConstants, </span>
<span id="cb172-225"><a href="models.html#cb172-225" aria-hidden="true" tabindex="-1"></a>      <span class="at">nIter =</span> nIter, </span>
<span id="cb172-226"><a href="models.html#cb172-226" aria-hidden="true" tabindex="-1"></a>      <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb172-227"><a href="models.html#cb172-227" aria-hidden="true" tabindex="-1"></a>      <span class="at">thinRate =</span> thinRate, </span>
<span id="cb172-228"><a href="models.html#cb172-228" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb172-229"><a href="models.html#cb172-229" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb172-230"><a href="models.html#cb172-230" aria-hidden="true" tabindex="-1"></a>      <span class="at">nChains =</span> nChains</span>
<span id="cb172-231"><a href="models.html#cb172-231" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-232"><a href="models.html#cb172-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-233"><a href="models.html#cb172-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierCJS_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb172-234"><a href="models.html#cb172-234" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierCJS_mostRecent.RData&#39;</span>)</span>
<span id="cb172-235"><a href="models.html#cb172-235" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb172-236"><a href="models.html#cb172-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierCJS_mostRecent.RData&#39;</span>)</span>
<span id="cb172-237"><a href="models.html#cb172-237" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb172-238"><a href="models.html#cb172-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-239"><a href="models.html#cb172-239" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb172-240"><a href="models.html#cb172-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-241"><a href="models.html#cb172-241" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT_cohort_flowHier, round = 2)</span></span>
<span id="cb172-242"><a href="models.html#cb172-242" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flowHier, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb172-243"><a href="models.html#cb172-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlowTop&quot;</span>)</span>
<span id="cb172-244"><a href="models.html#cb172-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb172-245"><a href="models.html#cb172-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb172-246"><a href="models.html#cb172-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohort&quot;</span>))</span>
<span id="cb172-247"><a href="models.html#cb172-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb172-248"><a href="models.html#cb172-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowCohort&quot;</span>))</span>
<span id="cb172-249"><a href="models.html#cb172-249" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-250"><a href="models.html#cb172-250" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(.<span class="dv">1</span>))</span>
<span id="cb172-251"><a href="models.html#cb172-251" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb172-252"><a href="models.html#cb172-252" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb172-253"><a href="models.html#cb172-253" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb172-254"><a href="models.html#cb172-254" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowTop&quot;</span>),</span>
<span id="cb172-255"><a href="models.html#cb172-255" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb172-256"><a href="models.html#cb172-256" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb172-257"><a href="models.html#cb172-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-258"><a href="models.html#cb172-258" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb172-259"><a href="models.html#cb172-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb172-260"><a href="models.html#cb172-260" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb172-261"><a href="models.html#cb172-261" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb172-262"><a href="models.html#cb172-262" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb172-263"><a href="models.html#cb172-263" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb172-264"><a href="models.html#cb172-264" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb172-265"><a href="models.html#cb172-265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb172-266"><a href="models.html#cb172-266" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb172-267"><a href="models.html#cb172-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb172-268"><a href="models.html#cb172-268" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb172-269"><a href="models.html#cb172-269" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb172-270"><a href="models.html#cb172-270" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb172-271"><a href="models.html#cb172-271" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb172-272"><a href="models.html#cb172-272" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb172-273"><a href="models.html#cb172-273" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-27.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-28.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-29.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-30.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-31.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-32.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-33.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-34.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-35.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-36.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-37.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-38.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-39.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-40.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-41.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-42.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-43.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-44.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-45.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-46.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierCJS-47.png" width="672" /></p>
</div>
<div id="get-flow-effect-estimates-3" class="section level4 hasAnchor" number="3.3.7.2">
<h4><span class="header-section-number">3.3.7.2</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects vary across cohorts - hierarchical</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="models.html#cb173-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb173-2"><a href="models.html#cb173-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb173-3"><a href="models.html#cb173-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t],cohort[i]] * flow[i,t] +</span></span>
<span id="cb173-4"><a href="models.html#cb173-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t],cohort[i]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb173-5"><a href="models.html#cb173-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-6"><a href="models.html#cb173-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierCJS_mostRecent.RData&#39;</span>)</span>
<span id="cb173-7"><a href="models.html#cb173-7" aria-hidden="true" tabindex="-1"></a>predFlowCohortHierCJS <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowCohort</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-predictions-1" class="section level4 hasAnchor" number="3.3.7.3">
<h4><span class="header-section-number">3.3.7.3</span> Plot predictions<a href="models.html#plot-predictions-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="models.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlowCohortHierCJS, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb174-2"><a href="models.html#cb174-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb174-3"><a href="models.html#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="models.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb175-2"><a href="models.html#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb175-3"><a href="models.html#cb175-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb175-4"><a href="models.html#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb175-5"><a href="models.html#cb175-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb175-6"><a href="models.html#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb175-7"><a href="models.html#cb175-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb175-8"><a href="models.html#cb175-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb175-9"><a href="models.html#cb175-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb175-10"><a href="models.html#cb175-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(alpha = 0.1) +</span></span>
<span id="cb175-11"><a href="models.html#cb175-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
<div id="betaflowtop-predictions-1" class="section level4 hasAnchor" number="3.3.7.4">
<h4><span class="header-section-number">3.3.7.4</span> BetaflowTop predictions<a href="models.html#betaflowtop-predictions-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="models.html#cb176-1" aria-hidden="true" tabindex="-1"></a>predBetaFlowTopCJS <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowTop</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>)</span>
<span id="cb176-2"><a href="models.html#cb176-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-3"><a href="models.html#cb176-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTopCJS, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb176-4"><a href="models.html#cb176-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="co">#+</span></span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="models.html#cb177-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#facet_wrap(~iter)</span></span>
<span id="cb177-2"><a href="models.html#cb177-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-3"><a href="models.html#cb177-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTopCJS, <span class="fu">aes</span>(betaFlowTop1, betaFlowTop2)) <span class="sc">+</span></span>
<span id="cb177-4"><a href="models.html#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-26-2.png" width="672" /></p>
</div>
</div>
<div id="model-phit_pt_cohort_flowcohorthierdhmm" class="section level3 hasAnchor" number="3.3.8">
<h3><span class="header-section-number">3.3.8</span> Model phiT_pT_cohort_flowCohortHierDHMM<a href="models.html#model-phit_pt_cohort_flowcohorthierdhmm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Flow effects vary by cohort, hierarchical across cohorts
Using nimble Ecology to run multistate models</p>
<div id="set-up-and-run-model-7" class="section level4 hasAnchor" number="3.3.8.1">
<h4><span class="header-section-number">3.3.8.1</span> Set up and run model<a href="models.html#set-up-and-run-model-7" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="models.html#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb178-2"><a href="models.html#cb178-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-3"><a href="models.html#cb178-3" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh</span>
<span id="cb178-4"><a href="models.html#cb178-4" aria-hidden="true" tabindex="-1"></a>  (nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts)))</span>
<span id="cb178-5"><a href="models.html#cb178-5" aria-hidden="true" tabindex="-1"></a>  (nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons)))</span>
<span id="cb178-6"><a href="models.html#cb178-6" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb178-7"><a href="models.html#cb178-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-8"><a href="models.html#cb178-8" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb178-9"><a href="models.html#cb178-9" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb178-10"><a href="models.html#cb178-10" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb178-11"><a href="models.html#cb178-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-12"><a href="models.html#cb178-12" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb178-13"><a href="models.html#cb178-13" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb178-14"><a href="models.html#cb178-14" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb178-15"><a href="models.html#cb178-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-16"><a href="models.html#cb178-16" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y), </span>
<span id="cb178-17"><a href="models.html#cb178-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">T =</span> <span class="fu">ncol</span>(y), </span>
<span id="cb178-18"><a href="models.html#cb178-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">first =</span> first,</span>
<span id="cb178-19"><a href="models.html#cb178-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">last =</span> last,</span>
<span id="cb178-20"><a href="models.html#cb178-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">cohort =</span> cohort, </span>
<span id="cb178-21"><a href="models.html#cb178-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb178-22"><a href="models.html#cb178-22" aria-hidden="true" tabindex="-1"></a>                      <span class="at">season =</span> seasonArray, <span class="co">#eh$seasons$season,</span></span>
<span id="cb178-23"><a href="models.html#cb178-23" aria-hidden="true" tabindex="-1"></a>                      <span class="at">flow =</span> eh<span class="sc">$</span>flow,</span>
<span id="cb178-24"><a href="models.html#cb178-24" aria-hidden="true" tabindex="-1"></a>                      <span class="do">## DT changes:</span></span>
<span id="cb178-25"><a href="models.html#cb178-25" aria-hidden="true" tabindex="-1"></a>                      <span class="do">## this is used by both the dCJS and dDHMM distributions</span></span>
<span id="cb178-26"><a href="models.html#cb178-26" aria-hidden="true" tabindex="-1"></a>                      <span class="at">length =</span> last <span class="sc">-</span> first <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb178-27"><a href="models.html#cb178-27" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb178-28"><a href="models.html#cb178-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-29"><a href="models.html#cb178-29" aria-hidden="true" tabindex="-1"></a>  <span class="do">## DT changes:</span></span>
<span id="cb178-30"><a href="models.html#cb178-30" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">yCJS =</span> y,    <span class="do">## data for CJS distribution</span></span>
<span id="cb178-31"><a href="models.html#cb178-31" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span>)   <span class="do">## data for DHMM distribution</span></span>
<span id="cb178-32"><a href="models.html#cb178-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-33"><a href="models.html#cb178-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-34"><a href="models.html#cb178-34" aria-hidden="true" tabindex="-1"></a>  initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">list</span>(</span>
<span id="cb178-35"><a href="models.html#cb178-35" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaInt =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb178-36"><a href="models.html#cb178-36" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## DT change:</span></span>
<span id="cb178-37"><a href="models.html#cb178-37" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## don&#39;t give phi and p initial values;</span></span>
<span id="cb178-38"><a href="models.html#cb178-38" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## they&#39;re deterministic nodes, so they&#39;ll be calculated</span></span>
<span id="cb178-39"><a href="models.html#cb178-39" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## in terms of other variables.  Also, when I made changes to these</span></span>
<span id="cb178-40"><a href="models.html#cb178-40" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">## in the code, these (unnecessary) initial values were the wrong sizes</span></span>
<span id="cb178-41"><a href="models.html#cb178-41" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">##phi = array(runif((myConstants$T - 1) * myConstants$N, 0, 1),c((myConstants$T - 1), myConstants$N)),</span></span>
<span id="cb178-42"><a href="models.html#cb178-42" aria-hidden="true" tabindex="-1"></a>                                  <span class="do">##p =   array(runif((myConstants$T - 1) * myConstants$N, 0, 1),c((myConstants$T - 1), myConstants$N)),</span></span>
<span id="cb178-43"><a href="models.html#cb178-43" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">z =</span> zInitsNA,</span>
<span id="cb178-44"><a href="models.html#cb178-44" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb178-45"><a href="models.html#cb178-45" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaP =</span>   <span class="fu">array</span>(<span class="fu">runif</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>((myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb178-46"><a href="models.html#cb178-46" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaPhiCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb178-47"><a href="models.html#cb178-47" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaPCohort =</span>   <span class="fu">array</span>(<span class="fu">runif</span>(nCohorts, <span class="dv">0</span>, <span class="dv">1</span>),<span class="fu">c</span>(nCohorts)),</span>
<span id="cb178-48"><a href="models.html#cb178-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaFlow =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">4</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, nCohorts)),</span>
<span id="cb178-49"><a href="models.html#cb178-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaFlowCohort =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(<span class="dv">2</span> <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, nCohorts)),</span>
<span id="cb178-50"><a href="models.html#cb178-50" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">betaFlowTop =</span> <span class="fu">rnorm</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb178-51"><a href="models.html#cb178-51" aria-hidden="true" tabindex="-1"></a>                              )</span>
<span id="cb178-52"><a href="models.html#cb178-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-53"><a href="models.html#cb178-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-54"><a href="models.html#cb178-54" aria-hidden="true" tabindex="-1"></a>  <span class="do">## if you change this FALSE to TRUE</span></span>
<span id="cb178-55"><a href="models.html#cb178-55" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this makes the dataset smaller - only 200 observations,</span></span>
<span id="cb178-56"><a href="models.html#cb178-56" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for quicker testing</span></span>
<span id="cb178-57"><a href="models.html#cb178-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">FALSE</span>) {</span>
<span id="cb178-58"><a href="models.html#cb178-58" aria-hidden="true" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb178-59"><a href="models.html#cb178-59" aria-hidden="true" tabindex="-1"></a>      oldN <span class="ot">&lt;-</span> <span class="fu">dim</span>(y)[<span class="dv">1</span>]</span>
<span id="cb178-60"><a href="models.html#cb178-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb178-61"><a href="models.html#cb178-61" aria-hidden="true" tabindex="-1"></a>      indToKeep <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>oldN, <span class="at">size =</span> newN, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb178-62"><a href="models.html#cb178-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-63"><a href="models.html#cb178-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-64"><a href="models.html#cb178-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this removes the very last observation,</span></span>
<span id="cb178-65"><a href="models.html#cb178-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## since first[2376] = T = 12, which is not allowed</span></span>
<span id="cb178-66"><a href="models.html#cb178-66" aria-hidden="true" tabindex="-1"></a>  <span class="do">## to have the first observation occur on the final sampling period</span></span>
<span id="cb178-67"><a href="models.html#cb178-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for either CJS or DHMM distributions</span></span>
<span id="cb178-68"><a href="models.html#cb178-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">TRUE</span>) {</span>
<span id="cb178-69"><a href="models.html#cb178-69" aria-hidden="true" tabindex="-1"></a>      indToKeep <span class="ot">&lt;-</span> <span class="fu">which</span>(first <span class="sc">&lt;</span> <span class="dv">12</span>)</span>
<span id="cb178-70"><a href="models.html#cb178-70" aria-hidden="true" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="fu">length</span>(indToKeep)</span>
<span id="cb178-71"><a href="models.html#cb178-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb178-72"><a href="models.html#cb178-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-73"><a href="models.html#cb178-73" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb178-74"><a href="models.html#cb178-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> newN,</span>
<span id="cb178-75"><a href="models.html#cb178-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">T =</span> myConstants<span class="sc">$</span>T,</span>
<span id="cb178-76"><a href="models.html#cb178-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">first =</span> myConstants<span class="sc">$</span>first[indToKeep],</span>
<span id="cb178-77"><a href="models.html#cb178-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">last =</span> myConstants<span class="sc">$</span>last[indToKeep],</span>
<span id="cb178-78"><a href="models.html#cb178-78" aria-hidden="true" tabindex="-1"></a>      <span class="at">cohort =</span> myConstants<span class="sc">$</span>cohort[indToKeep],</span>
<span id="cb178-79"><a href="models.html#cb178-79" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> myConstants<span class="sc">$</span>nCohorts,</span>
<span id="cb178-80"><a href="models.html#cb178-80" aria-hidden="true" tabindex="-1"></a>      <span class="at">season =</span> myConstants<span class="sc">$</span>season,</span>
<span id="cb178-81"><a href="models.html#cb178-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">flow =</span> myConstants<span class="sc">$</span>flow[indToKeep,],</span>
<span id="cb178-82"><a href="models.html#cb178-82" aria-hidden="true" tabindex="-1"></a>      <span class="at">length =</span> myConstants<span class="sc">$</span>length[indToKeep]</span>
<span id="cb178-83"><a href="models.html#cb178-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-84"><a href="models.html#cb178-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-85"><a href="models.html#cb178-85" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb178-86"><a href="models.html#cb178-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">yCJS =</span> myData<span class="sc">$</span>yCJS[indToKeep,],</span>
<span id="cb178-87"><a href="models.html#cb178-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> myData<span class="sc">$</span>y[indToKeep,]</span>
<span id="cb178-88"><a href="models.html#cb178-88" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-89"><a href="models.html#cb178-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-90"><a href="models.html#cb178-90" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> zInitsNA[indToKeep,]</span>
<span id="cb178-91"><a href="models.html#cb178-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-92"><a href="models.html#cb178-92" aria-hidden="true" tabindex="-1"></a>  <span class="do">## model code using DHMMo distribution</span></span>
<span id="cb178-93"><a href="models.html#cb178-93" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_cohort_flowCohortHierDHMM <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb178-94"><a href="models.html#cb178-94" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span>                    <span class="co"># Pr(alive t = 1) = 1</span></span>
<span id="cb178-95"><a href="models.html#cb178-95" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb178-96"><a href="models.html#cb178-96" aria-hidden="true" tabindex="-1"></a>      <span class="do">##</span></span>
<span id="cb178-97"><a href="models.html#cb178-97" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb178-98"><a href="models.html#cb178-98" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb178-99"><a href="models.html#cb178-99" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(phi[t,i]) <span class="ot">&lt;-</span> </span>
<span id="cb178-100"><a href="models.html#cb178-100" aria-hidden="true" tabindex="-1"></a>                  betaInt <span class="sc">+</span></span>
<span id="cb178-101"><a href="models.html#cb178-101" aria-hidden="true" tabindex="-1"></a>                  betaPhi[t,cohort[i]] <span class="sc">+</span> </span>
<span id="cb178-102"><a href="models.html#cb178-102" aria-hidden="true" tabindex="-1"></a>                  betaFlow[<span class="dv">1</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">+</span></span>
<span id="cb178-103"><a href="models.html#cb178-103" aria-hidden="true" tabindex="-1"></a>                  betaFlow[<span class="dv">2</span>,season[t],cohort[i]] <span class="sc">*</span> flow[i,t] <span class="sc">*</span> flow[i,t]</span>
<span id="cb178-104"><a href="models.html#cb178-104" aria-hidden="true" tabindex="-1"></a>              <span class="co"># prior survival</span></span>
<span id="cb178-105"><a href="models.html#cb178-105" aria-hidden="true" tabindex="-1"></a>              <span class="do">##</span></span>
<span id="cb178-106"><a href="models.html#cb178-106" aria-hidden="true" tabindex="-1"></a>              gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> phi[t,i]         <span class="co"># Pr(alive t -&gt; alive t+1)</span></span>
<span id="cb178-107"><a href="models.html#cb178-107" aria-hidden="true" tabindex="-1"></a>              gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> phi[t,i]     <span class="co"># Pr(alive t -&gt; dead t+1)</span></span>
<span id="cb178-108"><a href="models.html#cb178-108" aria-hidden="true" tabindex="-1"></a>              gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; alive t+1)</span></span>
<span id="cb178-109"><a href="models.html#cb178-109" aria-hidden="true" tabindex="-1"></a>              gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; dead t+1)</span></span>
<span id="cb178-110"><a href="models.html#cb178-110" aria-hidden="true" tabindex="-1"></a>              <span class="do">##            </span></span>
<span id="cb178-111"><a href="models.html#cb178-111" aria-hidden="true" tabindex="-1"></a>              <span class="do">## DT changes:</span></span>
<span id="cb178-112"><a href="models.html#cb178-112" aria-hidden="true" tabindex="-1"></a>              <span class="do">## definition of omega is moved below, to make it</span></span>
<span id="cb178-113"><a href="models.html#cb178-113" aria-hidden="true" tabindex="-1"></a>              <span class="do">## correctly condition on the first (positive) observation</span></span>
<span id="cb178-114"><a href="models.html#cb178-114" aria-hidden="true" tabindex="-1"></a>              <span class="do">##logit(p[t,i]) &lt;- betaP[t,cohort[i]]             # prior detection</span></span>
<span id="cb178-115"><a href="models.html#cb178-115" aria-hidden="true" tabindex="-1"></a>              <span class="do">##omega[1,1,t,i] &lt;- 1 - p[t,i]       # Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb178-116"><a href="models.html#cb178-116" aria-hidden="true" tabindex="-1"></a>              <span class="do">##omega[1,2,t,i] &lt;- p[t,i]           # Pr(alive t -&gt; detected t)</span></span>
<span id="cb178-117"><a href="models.html#cb178-117" aria-hidden="true" tabindex="-1"></a>              <span class="do">##omega[2,1,t,i] &lt;- 1              # Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb178-118"><a href="models.html#cb178-118" aria-hidden="true" tabindex="-1"></a>              <span class="do">##omega[2,2,t,i] &lt;- 0              # Pr(dead t -&gt; detected t)</span></span>
<span id="cb178-119"><a href="models.html#cb178-119" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb178-120"><a href="models.html#cb178-120" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb178-121"><a href="models.html#cb178-121" aria-hidden="true" tabindex="-1"></a>          <span class="do">## need to pad the gamma matrix with an extra t=T row, to ensure it&#39;s</span></span>
<span id="cb178-122"><a href="models.html#cb178-122" aria-hidden="true" tabindex="-1"></a>          <span class="do">## always a matrix.  This values are never actually used (except maybe for internal checking of row sums = 1),</span></span>
<span id="cb178-123"><a href="models.html#cb178-123" aria-hidden="true" tabindex="-1"></a>          <span class="do">## but defining them is necessary.</span></span>
<span id="cb178-124"><a href="models.html#cb178-124" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">1</span>,T,i] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb178-125"><a href="models.html#cb178-125" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">2</span>,T,i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb178-126"><a href="models.html#cb178-126" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">1</span>,T,i] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb178-127"><a href="models.html#cb178-127" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">2</span>,T,i] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb178-128"><a href="models.html#cb178-128" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb178-129"><a href="models.html#cb178-129" aria-hidden="true" tabindex="-1"></a>          <span class="do">## time period t = first[i]: guaranteed detection:</span></span>
<span id="cb178-130"><a href="models.html#cb178-130" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb178-131"><a href="models.html#cb178-131" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb178-132"><a href="models.html#cb178-132" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb178-133"><a href="models.html#cb178-133" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb178-134"><a href="models.html#cb178-134" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb178-135"><a href="models.html#cb178-135" aria-hidden="true" tabindex="-1"></a>          <span class="do">## time t &gt; first[i]:</span></span>
<span id="cb178-136"><a href="models.html#cb178-136" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span>(t <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]) {</span>
<span id="cb178-137"><a href="models.html#cb178-137" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(p[t,i]) <span class="ot">&lt;-</span> betaP[t<span class="dv">-1</span>,cohort[i]]             <span class="co"># prior detection</span></span>
<span id="cb178-138"><a href="models.html#cb178-138" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> p[t,i]       <span class="co"># Pr(alive t -&gt; non-detected t)</span></span>
<span id="cb178-139"><a href="models.html#cb178-139" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> p[t,i]           <span class="co"># Pr(alive t -&gt; detected t)</span></span>
<span id="cb178-140"><a href="models.html#cb178-140" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>              <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb178-141"><a href="models.html#cb178-141" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>              <span class="co"># Pr(dead t -&gt; detected t)</span></span>
<span id="cb178-142"><a href="models.html#cb178-142" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb178-143"><a href="models.html#cb178-143" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb178-144"><a href="models.html#cb178-144" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb178-145"><a href="models.html#cb178-145" aria-hidden="true" tabindex="-1"></a>      betaInt <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb178-146"><a href="models.html#cb178-146" aria-hidden="true" tabindex="-1"></a>      betaFlowTop[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb178-147"><a href="models.html#cb178-147" aria-hidden="true" tabindex="-1"></a>      betaFlowTop[<span class="dv">2</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb178-148"><a href="models.html#cb178-148" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb178-149"><a href="models.html#cb178-149" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb178-150"><a href="models.html#cb178-150" aria-hidden="true" tabindex="-1"></a>          <span class="co"># mean values</span></span>
<span id="cb178-151"><a href="models.html#cb178-151" aria-hidden="true" tabindex="-1"></a>          betaPhiCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb178-152"><a href="models.html#cb178-152" aria-hidden="true" tabindex="-1"></a>          betaPCohort[c] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb178-153"><a href="models.html#cb178-153" aria-hidden="true" tabindex="-1"></a>          betaFlowCohort[<span class="dv">1</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">1</span>],<span class="dv">1</span>)</span>
<span id="cb178-154"><a href="models.html#cb178-154" aria-hidden="true" tabindex="-1"></a>          betaFlowCohort[<span class="dv">2</span>,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowTop[<span class="dv">2</span>],<span class="dv">1</span>)</span>
<span id="cb178-155"><a href="models.html#cb178-155" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb178-156"><a href="models.html#cb178-156" aria-hidden="true" tabindex="-1"></a>              betaPhi[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiCohort[c],<span class="dv">1</span>)</span>
<span id="cb178-157"><a href="models.html#cb178-157" aria-hidden="true" tabindex="-1"></a>              betaP[t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPCohort[c],<span class="dv">1</span>)</span>
<span id="cb178-158"><a href="models.html#cb178-158" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb178-159"><a href="models.html#cb178-159" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb178-160"><a href="models.html#cb178-160" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb178-161"><a href="models.html#cb178-161" aria-hidden="true" tabindex="-1"></a>      <span class="co"># back-transform for examining output</span></span>
<span id="cb178-162"><a href="models.html#cb178-162" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb178-163"><a href="models.html#cb178-163" aria-hidden="true" tabindex="-1"></a>          betaPhiCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhiCohort[c]))</span>
<span id="cb178-164"><a href="models.html#cb178-164" aria-hidden="true" tabindex="-1"></a>          betaPCohortOut[c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPCohort[c]))</span>
<span id="cb178-165"><a href="models.html#cb178-165" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ </span>
<span id="cb178-166"><a href="models.html#cb178-166" aria-hidden="true" tabindex="-1"></a>              betaPhiOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaPhi[t,c]))</span>
<span id="cb178-167"><a href="models.html#cb178-167" aria-hidden="true" tabindex="-1"></a>              betaPOut[t,c] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>betaP[t,c])) </span>
<span id="cb178-168"><a href="models.html#cb178-168" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb178-169"><a href="models.html#cb178-169" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb178-170"><a href="models.html#cb178-170" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb178-171"><a href="models.html#cb178-171" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (s <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSeasons){</span>
<span id="cb178-172"><a href="models.html#cb178-172" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb178-173"><a href="models.html#cb178-173" aria-hidden="true" tabindex="-1"></a>              betaFlow[<span class="dv">1</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">1</span>,c],<span class="dv">1</span>)</span>
<span id="cb178-174"><a href="models.html#cb178-174" aria-hidden="true" tabindex="-1"></a>              betaFlow[<span class="dv">2</span>,s,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaFlowCohort[<span class="dv">2</span>,c],<span class="dv">1</span>)</span>
<span id="cb178-175"><a href="models.html#cb178-175" aria-hidden="true" tabindex="-1"></a>          }   </span>
<span id="cb178-176"><a href="models.html#cb178-176" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb178-177"><a href="models.html#cb178-177" aria-hidden="true" tabindex="-1"></a>      <span class="do">##    </span></span>
<span id="cb178-178"><a href="models.html#cb178-178" aria-hidden="true" tabindex="-1"></a>      <span class="co"># likelihood</span></span>
<span id="cb178-179"><a href="models.html#cb178-179" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb178-180"><a href="models.html#cb178-180" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb178-181"><a href="models.html#cb178-181" aria-hidden="true" tabindex="-1"></a>          <span class="do">##z[i,first[i]] ~ dcat(delta[1:2])</span></span>
<span id="cb178-182"><a href="models.html#cb178-182" aria-hidden="true" tabindex="-1"></a>          <span class="do">##for (j in (first[i]+1):(last[i])){</span></span>
<span id="cb178-183"><a href="models.html#cb178-183" aria-hidden="true" tabindex="-1"></a>          <span class="do">##    z[i,j] ~ dcat(gamma[z[i,j-1], 1:2, j-1, i])</span></span>
<span id="cb178-184"><a href="models.html#cb178-184" aria-hidden="true" tabindex="-1"></a>          <span class="do">##    y[i,j] ~ dcat(omega[z[i,j], 1:2, j-1, i])</span></span>
<span id="cb178-185"><a href="models.html#cb178-185" aria-hidden="true" tabindex="-1"></a>          <span class="do">##}</span></span>
<span id="cb178-186"><a href="models.html#cb178-186" aria-hidden="true" tabindex="-1"></a>          y[i,first[i]<span class="sc">:</span>last[i]] <span class="sc">~</span> <span class="fu">dDHMMo</span>(<span class="at">init =</span> delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>],</span>
<span id="cb178-187"><a href="models.html#cb178-187" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">probTrans =</span> gamma[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, first[i]<span class="sc">:</span>last[i], i],</span>
<span id="cb178-188"><a href="models.html#cb178-188" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">probObs =</span> omega[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, first[i]<span class="sc">:</span>last[i], i],</span>
<span id="cb178-189"><a href="models.html#cb178-189" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">len =</span> length[i],</span>
<span id="cb178-190"><a href="models.html#cb178-190" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">checkRowSums =</span> <span class="dv">1</span>)</span>
<span id="cb178-191"><a href="models.html#cb178-191" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb178-192"><a href="models.html#cb178-192" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb178-193"><a href="models.html#cb178-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-194"><a href="models.html#cb178-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb178-195"><a href="models.html#cb178-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-196"><a href="models.html#cb178-196" aria-hidden="true" tabindex="-1"></a>  <span class="do">## you&#39;ll get warnings that the data &#39;yCJS&#39; is not used, and the &#39;z&#39; initial</span></span>
<span id="cb178-197"><a href="models.html#cb178-197" aria-hidden="true" tabindex="-1"></a>  <span class="do">## values are not in the model.  Those don&#39;t cause any problems,</span></span>
<span id="cb178-198"><a href="models.html#cb178-198" aria-hidden="true" tabindex="-1"></a>  <span class="do">## and let us use the same myData and initialValue() for both models.</span></span>
<span id="cb178-199"><a href="models.html#cb178-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>(</span>
<span id="cb178-200"><a href="models.html#cb178-200" aria-hidden="true" tabindex="-1"></a>      Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb178-201"><a href="models.html#cb178-201" aria-hidden="true" tabindex="-1"></a>          <span class="at">code =</span> hmm.phiT_pT_cohort_flowCohortHierDHMM,</span>
<span id="cb178-202"><a href="models.html#cb178-202" aria-hidden="true" tabindex="-1"></a>          <span class="at">constants =</span> myConstants,</span>
<span id="cb178-203"><a href="models.html#cb178-203" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> myData,              </span>
<span id="cb178-204"><a href="models.html#cb178-204" aria-hidden="true" tabindex="-1"></a>          <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb178-205"><a href="models.html#cb178-205" aria-hidden="true" tabindex="-1"></a>          <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb178-206"><a href="models.html#cb178-206" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb178-207"><a href="models.html#cb178-207" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-208"><a href="models.html#cb178-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-209"><a href="models.html#cb178-209" aria-hidden="true" tabindex="-1"></a>  Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb178-210"><a href="models.html#cb178-210" aria-hidden="true" tabindex="-1"></a>  <span class="do">## latent state: -29141.62</span></span>
<span id="cb178-211"><a href="models.html#cb178-211" aria-hidden="true" tabindex="-1"></a>  <span class="do">## latent state (200 ind): -2847.746</span></span>
<span id="cb178-212"><a href="models.html#cb178-212" aria-hidden="true" tabindex="-1"></a>  <span class="do">## dDHMMo (200 ind): -1199.098 (same as CJS)</span></span>
<span id="cb178-213"><a href="models.html#cb178-213" aria-hidden="true" tabindex="-1"></a>  <span class="do">## dDHMMo (all but last observation): -1217.127 (same as CJS)</span></span>
<span id="cb178-214"><a href="models.html#cb178-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-215"><a href="models.html#cb178-215" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaInt&quot;</span>, </span>
<span id="cb178-216"><a href="models.html#cb178-216" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaP&quot;</span>, <span class="st">&quot;betaPhiCohort&quot;</span>, <span class="st">&quot;betaPCohort&quot;</span>,</span>
<span id="cb178-217"><a href="models.html#cb178-217" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPOut&quot;</span>, <span class="st">&quot;betaPhiCohortOut&quot;</span>, <span class="st">&quot;betaPCohortOut&quot;</span>, </span>
<span id="cb178-218"><a href="models.html#cb178-218" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlow&quot;</span>,</span>
<span id="cb178-219"><a href="models.html#cb178-219" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaFlowCohort&quot;</span>, <span class="st">&quot;betaFlowTop&quot;</span>)  </span>
<span id="cb178-220"><a href="models.html#cb178-220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-221"><a href="models.html#cb178-221" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">20000</span> <span class="co">#30000</span></span>
<span id="cb178-222"><a href="models.html#cb178-222" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">10000</span> <span class="co">#15000</span></span>
<span id="cb178-223"><a href="models.html#cb178-223" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb178-224"><a href="models.html#cb178-224" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb178-225"><a href="models.html#cb178-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-226"><a href="models.html#cb178-226" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb178-227"><a href="models.html#cb178-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-228"><a href="models.html#cb178-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>(</span>
<span id="cb178-229"><a href="models.html#cb178-229" aria-hidden="true" tabindex="-1"></a>      conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb178-230"><a href="models.html#cb178-230" aria-hidden="true" tabindex="-1"></a>          Rmodel,</span>
<span id="cb178-231"><a href="models.html#cb178-231" aria-hidden="true" tabindex="-1"></a>          <span class="at">monitors =</span> parametersToSave</span>
<span id="cb178-232"><a href="models.html#cb178-232" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb178-233"><a href="models.html#cb178-233" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-234"><a href="models.html#cb178-234" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-235"><a href="models.html#cb178-235" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb178-236"><a href="models.html#cb178-236" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb178-237"><a href="models.html#cb178-237" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb178-238"><a href="models.html#cb178-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-239"><a href="models.html#cb178-239" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_cohort_flowCohortHierDHMM <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb178-240"><a href="models.html#cb178-240" aria-hidden="true" tabindex="-1"></a>      Cmcmc, </span>
<span id="cb178-241"><a href="models.html#cb178-241" aria-hidden="true" tabindex="-1"></a>      <span class="at">niter =</span> nIter, </span>
<span id="cb178-242"><a href="models.html#cb178-242" aria-hidden="true" tabindex="-1"></a>      <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb178-243"><a href="models.html#cb178-243" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> thinRate, </span>
<span id="cb178-244"><a href="models.html#cb178-244" aria-hidden="true" tabindex="-1"></a>      <span class="at">nchains =</span> nChains</span>
<span id="cb178-245"><a href="models.html#cb178-245" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-246"><a href="models.html#cb178-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-247"><a href="models.html#cb178-247" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb178-248"><a href="models.html#cb178-248" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_cohort_flowCohortHierDHMM <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb178-249"><a href="models.html#cb178-249" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb178-250"><a href="models.html#cb178-250" aria-hidden="true" tabindex="-1"></a>      <span class="at">mcmc =</span> mcmc.phiT_pT_cohort_flowCohortHierDHMM, </span>
<span id="cb178-251"><a href="models.html#cb178-251" aria-hidden="true" tabindex="-1"></a>      <span class="at">elapsed =</span> elapsed_phiT_pT_cohort_flowCohortHierDHMM,</span>
<span id="cb178-252"><a href="models.html#cb178-252" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;phiT_pT_cohort_flowCohortHierDHMM&quot;</span>,</span>
<span id="cb178-253"><a href="models.html#cb178-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">myConstants =</span> myConstants, </span>
<span id="cb178-254"><a href="models.html#cb178-254" aria-hidden="true" tabindex="-1"></a>      <span class="at">nIter =</span> nIter, </span>
<span id="cb178-255"><a href="models.html#cb178-255" aria-hidden="true" tabindex="-1"></a>      <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb178-256"><a href="models.html#cb178-256" aria-hidden="true" tabindex="-1"></a>      <span class="at">thinRate =</span> thinRate, </span>
<span id="cb178-257"><a href="models.html#cb178-257" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb178-258"><a href="models.html#cb178-258" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb178-259"><a href="models.html#cb178-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">nChains =</span> nChains</span>
<span id="cb178-260"><a href="models.html#cb178-260" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb178-261"><a href="models.html#cb178-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-262"><a href="models.html#cb178-262" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierDHMM_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb178-263"><a href="models.html#cb178-263" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierDHMM_mostRecent.RData&#39;</span>)</span>
<span id="cb178-264"><a href="models.html#cb178-264" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb178-265"><a href="models.html#cb178-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierDHMM_mostRecent.RData&#39;</span>)</span>
<span id="cb178-266"><a href="models.html#cb178-266" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb178-267"><a href="models.html#cb178-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-268"><a href="models.html#cb178-268" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb178-269"><a href="models.html#cb178-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-270"><a href="models.html#cb178-270" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCsummary(object = mcmc.phiT_pT_cohort_flowHier, round = 2)</span></span>
<span id="cb178-271"><a href="models.html#cb178-271" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flowHier, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb178-272"><a href="models.html#cb178-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlowTop&quot;</span>)</span>
<span id="cb178-273"><a href="models.html#cb178-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaFlow&quot;</span>)<span class="co"># </span></span>
<span id="cb178-274"><a href="models.html#cb178-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>))</span>
<span id="cb178-275"><a href="models.html#cb178-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohort&quot;</span>))</span>
<span id="cb178-276"><a href="models.html#cb178-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPCohortOut&quot;</span>))</span>
<span id="cb178-277"><a href="models.html#cb178-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowCohort&quot;</span>))</span>
<span id="cb178-278"><a href="models.html#cb178-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-279"><a href="models.html#cb178-279" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(.<span class="dv">1</span>))</span>
<span id="cb178-280"><a href="models.html#cb178-280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb178-281"><a href="models.html#cb178-281" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb178-282"><a href="models.html#cb178-282" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb178-283"><a href="models.html#cb178-283" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlowTop&quot;</span>),</span>
<span id="cb178-284"><a href="models.html#cb178-284" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb178-285"><a href="models.html#cb178-285" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb178-286"><a href="models.html#cb178-286" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-287"><a href="models.html#cb178-287" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb178-288"><a href="models.html#cb178-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb178-289"><a href="models.html#cb178-289" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb178-290"><a href="models.html#cb178-290" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb178-291"><a href="models.html#cb178-291" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiCohortOut&quot;</span>),</span>
<span id="cb178-292"><a href="models.html#cb178-292" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb178-293"><a href="models.html#cb178-293" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb178-294"><a href="models.html#cb178-294" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb178-295"><a href="models.html#cb178-295" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb178-296"><a href="models.html#cb178-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb178-297"><a href="models.html#cb178-297" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb178-298"><a href="models.html#cb178-298" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb178-299"><a href="models.html#cb178-299" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaFlow&quot;</span>),</span>
<span id="cb178-300"><a href="models.html#cb178-300" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb178-301"><a href="models.html#cb178-301" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb178-302"><a href="models.html#cb178-302" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-7.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-27.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-28.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-29.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-30.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-31.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-32.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-33.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-34.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-35.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-36.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-37.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-38.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-39.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-40.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-41.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-42.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-43.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-44.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-45.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-46.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_cohort_flowCohortHierDHMM-47.png" width="672" /></p>
</div>
<div id="get-flow-effect-estimates-4" class="section level4 hasAnchor" number="3.3.8.2">
<h4><span class="header-section-number">3.3.8.2</span> Get flow effect estimates<a href="models.html#get-flow-effect-estimates-4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Flow effects vary across cohorts - hierarchical</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="models.html#cb179-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaInt +</span></span>
<span id="cb179-2"><a href="models.html#cb179-2" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaPhi[t,cohort[i]] + </span></span>
<span id="cb179-3"><a href="models.html#cb179-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[1,season[t],cohort[i]] * flow[i,t] +</span></span>
<span id="cb179-4"><a href="models.html#cb179-4" aria-hidden="true" tabindex="-1"></a>   <span class="co">#     betaFlow[2,season[t],cohort[i]] * flow[i,t] * flow[i,t]</span></span>
<span id="cb179-5"><a href="models.html#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="models.html#cb179-6" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlowOB/runsOut/mcmc_phiT_pT_cohort_flowCohortHierDHMM_mostRecent.RData&#39;</span>)</span>
<span id="cb179-7"><a href="models.html#cb179-7" aria-hidden="true" tabindex="-1"></a>predFlowCohortHierDHMM <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowCohort</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="plot-predictions-2" class="section level4 hasAnchor" number="3.3.8.3">
<h4><span class="header-section-number">3.3.8.3</span> Plot predictions<a href="models.html#plot-predictions-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="models.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predFlowCohortHierDHMM, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb180-2"><a href="models.html#cb180-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.025</span>) <span class="sc">+</span></span>
<span id="cb180-3"><a href="models.html#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(season <span class="sc">~</span> cohort)</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="models.html#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==1, cohort == 6), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb181-2"><a href="models.html#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.5) +</span></span>
<span id="cb181-3"><a href="models.html#cb181-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_grid(cohort ~ season)</span></span>
<span id="cb181-4"><a href="models.html#cb181-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb181-5"><a href="models.html#cb181-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(cohort == 3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb181-6"><a href="models.html#cb181-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_line(alpha = 0.1) +</span></span>
<span id="cb181-7"><a href="models.html#cb181-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   facet_wrap( ~ season)</span></span>
<span id="cb181-8"><a href="models.html#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb181-9"><a href="models.html#cb181-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(predFlowCohortHier %&gt;% filter(season ==3), aes(flow, predPhi, group = iter)) +</span></span>
<span id="cb181-10"><a href="models.html#cb181-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_line(alpha = 0.1) +</span></span>
<span id="cb181-11"><a href="models.html#cb181-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># facet_wrap(~ cohort)</span></span></code></pre></div>
</div>
<div id="betaflowtop-predictions-2" class="section level4 hasAnchor" number="3.3.8.4">
<h4><span class="header-section-number">3.3.8.4</span> BetaflowTop predictions<a href="models.html#betaflowtop-predictions-2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="models.html#cb182-1" aria-hidden="true" tabindex="-1"></a>predBetaFlowTopDHMM <span class="ot">&lt;-</span> <span class="fu">getPredictionsFlowTop</span>(toSave, <span class="at">everyNIters =</span> <span class="dv">10</span>)</span>
<span id="cb182-2"><a href="models.html#cb182-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-3"><a href="models.html#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTopDHMM, <span class="fu">aes</span>(flow, predPhi, <span class="at">group =</span> iter)) <span class="sc">+</span></span>
<span id="cb182-4"><a href="models.html#cb182-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="co">#+</span></span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="models.html#cb183-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">#facet_wrap(~iter)</span></span>
<span id="cb183-2"><a href="models.html#cb183-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-3"><a href="models.html#cb183-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(predBetaFlowTopDHMM, <span class="fu">aes</span>(betaFlowTop1, betaFlowTop2)) <span class="sc">+</span></span>
<span id="cb183-4"><a href="models.html#cb183-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/unnamed-chunk-29-2.png" width="672" /></p>
</div>
</div>
<div id="compare-models" class="section level3 hasAnchor" number="3.3.9">
<h3><span class="header-section-number">3.3.9</span> Compare models<a href="models.html#compare-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="models.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co">#data.frame(model = c(&quot;(phi,p)&quot;,</span></span>
<span id="cb184-2"><a href="models.html#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                     &quot;(phit,pt)&quot;),</span></span>
<span id="cb184-3"><a href="models.html#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="co">#           WAIC = c(mcmc.phi_p, </span></span>
<span id="cb184-4"><a href="models.html#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mcmc.phiT_pT))</span></span></code></pre></div>
<!-- ### Model phiT_pT_isYOY -->
<!-- Add structure for isYOY. This was important for the integrated growth/survival model, but probably not relevant here since we are estimating phi and p for each ageInSamples -->
<!-- ```{r phiT_pT_cohortisYOY} -->
<!-- # Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/4_demo.html -->
<!-- if (rerunSurivalModels) { -->
<!--   y <- eh$eh -->
<!--   nSeasons <- nrow(unique(eh$seasons)) -->
<!--   nCohorts <- nrow(unique(eh$cohorts)) -->
<!--   hmm.phiT_pT_isYOY <- nimbleCode({ -->
<!--     delta[1] <- 1                    # Pr(alive t = 1) = 1 -->
<!--     delta[2] <- 0                    # Pr(dead t = 1) = 0 -->
<!--     for (i in 1:N){ -->
<!--       for (t in 1:(T-1)){ # loop over time -->
<!--         #logit(phi[t,i]) <- betaPhi[t,isYOY[i,t]]           # prior survival -->
<!--         logit(phi[t,i]) <- betaPhi[t]    # prior survival -->
<!--         gamma[1,1,t,i] <- phi[t,i]       # Pr(alive t -> alive t+1) -->
<!--         gamma[1,2,t,i] <- 1 - phi[t,i]   # Pr(alive t -> dead t+1) -->
<!--         gamma[2,1,t,i] <- 0              # Pr(dead t -> alive t+1) -->
<!--         gamma[2,2,t,i] <- 1              # Pr(dead t -> dead t+1) -->
<!--         logit(p[t,i]) <- betaP[t]        # prior detection -->
<!--         omega[1,1,t,i] <- 1 - p[t,i]     # Pr(alive t -> non-detected t) -->
<!--         omega[1,2,t,i] <- p[t,i]         # Pr(alive t -> detected t) -->
<!--         omega[2,1,t,i] <- 1              # Pr(dead t -> non-detected t) -->
<!--         omega[2,2,t,i] <- 0              # Pr(dead t -> detected t) -->
<!--       } -->
<!--     } -->
<!--     for (y in 1:2){ -->
<!--       # mean values -->
<!--       betaPhiIsYOY[y] ~ dnorm(0,1) -->
<!--       betaPIsYOY[y] ~ dnorm(0,1) -->
<!--     } -->
<!--     # isYOY = 1 -->
<!--     for (t in 1:3){  -->
<!--       betaPhi[t] ~ dnorm(betaPhiIsYOY[1], 1) -->
<!--       betaP[t] ~ dnorm(betaPIsYOY[1], 1) -->
<!--     } -->
<!--     # isYOY = 2, older fish -->
<!--     for (t in 4:(T-1)){  -->
<!--       betaPhi[t] ~ dnorm(betaPhiIsYOY[2], 1) -->
<!--       betaP[t] ~ dnorm(betaPIsYOY[2], 1) -->
<!--     } -->
<!--     # Backtransform for output -->
<!--     for (y in 1:2){ -->
<!--         betaPhiIsYOYOut[y] <- 1/(1 + exp(-betaPhiIsYOY[y])) -->
<!--         betaPIsYOYOut[y] <- 1/(1 + exp(-betaPIsYOY[y])) -->
<!--     } -->
<!--     for (t in 1:(T-1)){  -->
<!--       betaPhiOut[t] <- 1/(1 + exp(-betaPhi[t])) -->
<!--       betaPOut[t] <- 1/(1 + exp(-betaP[t]))  -->
<!--     } -->
<!--     # likelihood -->
<!--     for (i in 1:N){ -->
<!--       z[i,first[i]] ~ dcat(delta[1:2]) -->
<!--       for (j in (first[i]+1):last[i]){ -->
<!--         z[i,j] ~ dcat(gamma[z[i,j-1], 1:2, j-1, i]) -->
<!--         y[i,j] ~ dcat(omega[z[i,j], 1:2, j-1, i]) -->
<!--       } -->
<!--     } -->
<!--   }) -->
<!--   first <- eh$first #apply(y, 1, function(x) min(which(x !=0))) -->
<!--   last <- eh$last -->
<!--   myConstants <- list(N = nrow(y), -->
<!--                       T = ncol(y), -->
<!--                       first = first, -->
<!--                       last = last, -->
<!--                       isYOY = eh$isYOY -->
<!--                       ) -->
<!--   myData <- list(y = y + 1) -->
<!--   zinits <- y + 1 # non-detection -> alive -->
<!--   zinits[zinits == 2] <- 1 # dead -> alive -->
<!--   zInitsNA <- ifelse(is.na(eh$isYOY), NA, 1) -->
<!--   initialValues <- function() list( -->
<!--     phi = array(runif((myConstants$T - 1) * myConstants$N, 0, 1),c((myConstants$T - 1), myConstants$N)), -->
<!--     p =   array(runif((myConstants$T - 1) * myConstants$N, 0, 1),c((myConstants$T - 1), myConstants$N)), -->
<!--     z = zInitsNA, -->
<!--     betaPhi = array(runif((myConstants$T - 1), 0, 1),c((myConstants$T - 1))), -->
<!--     betaP = array(runif((myConstants$T - 1), 0, 1),c((myConstants$T - 1))), -->
<!--     betaPhiIsYOY = array(runif(2, 0, 1),c(2)), -->
<!--     betaPIsYOY = array(runif(2, 0, 1),c(2)) -->
<!--   ) -->
<!--   parametersToSave <- c("betaPhiOut", "betaPOut", "betaPIsYOYOut", "betaPhiIsYOYOut") -->
<!--   nIter <- 5000 -->
<!--   nBurnin <- 1000 -->
<!--   nChains <- 2 -->
<!--   thinRate <- 5 -->
<!--   start <- Sys.time() -->
<!--   Rmodel <- nimbleModel( -->
<!--     code = hmm.phiT_pT_isYOY, -->
<!--     constants = myConstants, -->
<!--     data = myData, -->
<!--     inits = initialValues(), -->
<!--     calculate = FALSE -->
<!--   ) -->
<!--   conf <- configureMCMC( -->
<!--     Rmodel, -->
<!--     monitors = parametersToSave -->
<!--   ) -->
<!--   Rmcmc <- buildMCMC(conf, useConjugacy = FALSE) -->
<!--   Cmodel <- compileNimble(Rmodel) -->
<!--   Cmcmc <- compileNimble(Rmcmc, project = Rmodel) -->
<!--   mcmc.phiT_pT_isYOY <- runMCMC( -->
<!--     Cmcmc, -->
<!--     niter = nIter, -->
<!--     nburnin = nBurnin, -->
<!--     thin = thinRate, -->
<!--     nchains = nChains -->
<!--   ) -->
<!--   end <- Sys.time() -->
<!--   elapsed_phiT_pT_isYOY <- end - start -->
<!--     toSave <- list( -->
<!--       mcmc = mcmc.phiT_pT_isYOY, -->
<!--       elapsed = elapsed_phiT_pT_isYOY, -->
<!--       myConstants = myConstants, -->
<!--       nIter = nIter, -->
<!--       nBurnin = nBurnin, -->
<!--       thinRate = thinRate, -->
<!--       nSeasons = nSeasons, -->
<!--       nCohorts = nCohorts, -->
<!--       nChains = nChains -->
<!--     ) -->
<!--   save(toSave, file = paste0('./models/cmrFlowOB/runsOut/mcmc_phiT_pT_isYOY_', substr(end,1,13), '.RData')) -->
<!--   save(toSave, file = './models/cmrFlowOB/runsOut/mcmc_phiT_pT_isYOY_mostRecent.RData') -->
<!-- } else { -->
<!--   load('./models/cmrFlowOB/runsOut/mcmc_phiT_pT_isYOY_mostRecent.RData') -->
<!-- } -->
<!-- if(plotMCMCOutput) { -->
<!--   MCMCsummary(object = toSave$mcmc, round = 2) -->
<!--   MCMCplot(object = toSave$mcmc, params = "betaPhiIsYOYOut") -->
<!--   MCMCplot(object = toSave$mcmc, params = "betaPhiOut") -->
<!--   MCMCplot(object = toSave$mcmc, params = "betaPOut")# -->
<!--   priors <-  runif(toSave$nIter * toSave$nChains, 0, 1) -->
<!--   MCMCtrace(object = toSave$mcmc, -->
<!--             #ISB = FALSE, -->
<!--             #exact = TRUE, -->
<!--             params = c("betaPhiOut"), -->
<!--             pdf = FALSE, -->
<!--             priors = priors) -->
<!-- } -->
<!-- ``` -->

</div>
</div>
<div id="modelCMR_Flow_4rivers" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Flow effects on survival (phi) models<a href="models.html#modelCMR_Flow_4rivers" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The goal of this modelling exercise is to evaluate the effect of new tributary-specific stream flow estimates on survival of brook trout and brown trout. We will compare survival across the WB and tributaries with flow input data as 1) single flow estimate for all locations (historical approach) and 2) hindcasted flows for each tributary based on new tributary-specific flows which are available since 2000.</p>
<p>The goal is to find the best structure for the survival model, then compare survival estimates with tributary-specific flow to estimates with common flow across locations.</p>
<p>Structure options include
[species, cohort, season, isYOY, flow, flow^2]</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="models.html#cb185-1" aria-hidden="true" tabindex="-1"></a>rerunSurivalModels <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb185-2"><a href="models.html#cb185-2" aria-hidden="true" tabindex="-1"></a>plotMCMCOutput <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb185-3"><a href="models.html#cb185-3" aria-hidden="true" tabindex="-1"></a>plotTraces <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb185-4"><a href="models.html#cb185-4" aria-hidden="true" tabindex="-1"></a>outputFileForXiaowei <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span></code></pre></div>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="models.html#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="co">#all the data</span></span>
<span id="cb186-2"><a href="models.html#cb186-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">&#39;./models/cmrFlow4rivers/dataOut/eh_2002200320042005200620072008200920102011201220132014.RData&#39;</span>)</span>
<span id="cb186-3"><a href="models.html#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="co">#load(&#39;./models/cmrFlow4rivers/dataOut/eh_200620072008.RData&#39;)</span></span>
<span id="cb186-4"><a href="models.html#cb186-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-5"><a href="models.html#cb186-5" aria-hidden="true" tabindex="-1"></a><span class="co">#250 fish from each cohort</span></span>
<span id="cb186-6"><a href="models.html#cb186-6" aria-hidden="true" tabindex="-1"></a><span class="co">#load(&#39;./models/cmrFlow4rivers/dataOut/eh_2002200320042005200620072008200920102011201220132014_n250.RData&#39;)</span></span>
<span id="cb186-7"><a href="models.html#cb186-7" aria-hidden="true" tabindex="-1"></a><span class="co">#250 fish from each of 3 cohorts</span></span>
<span id="cb186-8"><a href="models.html#cb186-8" aria-hidden="true" tabindex="-1"></a><span class="co">#load(&#39;./models/cmrFlow4rivers/dataOut/eh_200620072008_n250.RData&#39;)</span></span>
<span id="cb186-9"><a href="models.html#cb186-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-10"><a href="models.html#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(eh<span class="sc">$</span>data<span class="sc">$</span>cohort, eh<span class="sc">$</span>data<span class="sc">$</span>river)</span></code></pre></div>
<pre><code>##       
##        wb jimmy wb mitchell wb obear west brook
##   2002     1440         626     2139      13023
##   2003     2396         444     2747      24489
##   2004     3637        2707     1666      24963
##   2005      943        1003      723       5471
##   2006     1973         533     1322       6797
##   2007     1530        1068      968       3958
##   2008     1424         131      886       8668
##   2009     3497        1889     5081      18696
##   2010      689         281      453       7693
##   2011     1792         395      394       2202
##   2012     2377        1721     5305      16663
##   2013     1246         304      729       4999
##   2014      528         427      725       3853</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="models.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (outputFileForXiaowei){</span>
<span id="cb188-2"><a href="models.html#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># output for Xiaowei</span></span>
<span id="cb188-3"><a href="models.html#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(eh)){</span>
<span id="cb188-4"><a href="models.html#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write.csv</span>(eh[[i]], <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlow4rivers/dataOut/&#39;</span>, </span>
<span id="cb188-5"><a href="models.html#cb188-5" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">names</span>(eh)[i], </span>
<span id="cb188-6"><a href="models.html#cb188-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">&quot;.csv&quot;</span>), </span>
<span id="cb188-7"><a href="models.html#cb188-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">row.names =</span> F)</span>
<span id="cb188-8"><a href="models.html#cb188-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb188-9"><a href="models.html#cb188-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div id="model-phit_pt_psit_dirch" class="section level3 hasAnchor" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Model phiT_pT_psiT_dirch<a href="models.html#model-phit_pt_psit_dirch" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Phi and p and psi vary by time<br />
Includes transition probabilities among rivers<br />
Added cohort (c) indexing to psi’s<br />
Fixed c,t indexing, change to t,c<br />
Added ilogis() to betaPhi<br />
Need to add hier vars on psi<br />
Used dirichlet prior
Add informative priors for dirichlet psi</p>
<p>This model is too big and needs to be run on workbench<br />
Output files are here: “C:- DOI-book4rivers”</p>
<div id="set-up-and-run-model-8" class="section level4 hasAnchor" number="3.4.1.1">
<h4><span class="header-section-number">3.4.1.1</span> Set up and run model<a href="models.html#set-up-and-run-model-8" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="models.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Following https://oliviergimenez.github.io/bayesian-cr-workshop/worksheets/5_demo.html</span></span>
<span id="cb189-2"><a href="models.html#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (rerunSurivalModels) {</span>
<span id="cb189-3"><a href="models.html#cb189-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-4"><a href="models.html#cb189-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> eh<span class="sc">$</span>eh <span class="sc">*</span> eh<span class="sc">$</span>riverN</span>
<span id="cb189-5"><a href="models.html#cb189-5" aria-hidden="true" tabindex="-1"></a>  (nCohorts <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>cohorts)))</span>
<span id="cb189-6"><a href="models.html#cb189-6" aria-hidden="true" tabindex="-1"></a>  (nSeasons <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>seasons)))</span>
<span id="cb189-7"><a href="models.html#cb189-7" aria-hidden="true" tabindex="-1"></a>  (nRivers <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(eh<span class="sc">$</span>data<span class="sc">$</span>riverN)))<span class="co"># rivers 1:4</span></span>
<span id="cb189-8"><a href="models.html#cb189-8" aria-hidden="true" tabindex="-1"></a>  seasonArray <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb189-9"><a href="models.html#cb189-9" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb189-10"><a href="models.html#cb189-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-11"><a href="models.html#cb189-11" aria-hidden="true" tabindex="-1"></a>  first <span class="ot">&lt;-</span> eh<span class="sc">$</span>first <span class="co">#apply(y, 1, function(x) min(which(x !=0)))</span></span>
<span id="cb189-12"><a href="models.html#cb189-12" aria-hidden="true" tabindex="-1"></a>  last <span class="ot">&lt;-</span> eh<span class="sc">$</span>last</span>
<span id="cb189-13"><a href="models.html#cb189-13" aria-hidden="true" tabindex="-1"></a>  cohort <span class="ot">=</span> ((eh<span class="sc">$</span>cohorts) <span class="sc">-</span> <span class="fu">min</span>(eh<span class="sc">$</span>cohorts) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">$</span>cohort <span class="co">#can&#39;t be a data frame or tibble</span></span>
<span id="cb189-14"><a href="models.html#cb189-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-15"><a href="models.html#cb189-15" aria-hidden="true" tabindex="-1"></a>  zinits <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="dv">1</span> <span class="co"># non-detection -&gt; alive</span></span>
<span id="cb189-16"><a href="models.html#cb189-16" aria-hidden="true" tabindex="-1"></a>  zinits[zinits <span class="sc">==</span> <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># dead -&gt; alive</span></span>
<span id="cb189-17"><a href="models.html#cb189-17" aria-hidden="true" tabindex="-1"></a>  zInitsNA <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(eh<span class="sc">$</span>flow), <span class="cn">NA</span>, <span class="dv">1</span>)</span>
<span id="cb189-18"><a href="models.html#cb189-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-19"><a href="models.html#cb189-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Proportion of fish in each river on the first observation</span></span>
<span id="cb189-20"><a href="models.html#cb189-20" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> y[,<span class="dv">1</span>]</span>
<span id="cb189-21"><a href="models.html#cb189-21" aria-hidden="true" tabindex="-1"></a>  deltaProps <span class="ot">&lt;-</span> <span class="fu">table</span>(y1[y1<span class="sc">&gt;</span><span class="dv">0</span>]) <span class="sc">/</span> <span class="fu">length</span>(y1[y1<span class="sc">&gt;</span><span class="dv">0</span>])</span>
<span id="cb189-22"><a href="models.html#cb189-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-23"><a href="models.html#cb189-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># alpha for the dirichlet prior</span></span>
<span id="cb189-24"><a href="models.html#cb189-24" aria-hidden="true" tabindex="-1"></a>  alpha <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb189-25"><a href="models.html#cb189-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-26"><a href="models.html#cb189-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fill in entries for dirichlet priors where a[r,,t,c] sums to 1 for any r,t,c combo</span></span>
<span id="cb189-27"><a href="models.html#cb189-27" aria-hidden="true" tabindex="-1"></a>  getDirchPriors <span class="ot">&lt;-</span> <span class="cf">function</span>(nRivers,myConstants, nCohorts, alpha){</span>
<span id="cb189-28"><a href="models.html#cb189-28" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">=</span> <span class="fu">array</span>(<span class="fu">rep</span>(<span class="dv">0</span>, nRivers <span class="sc">*</span> nRivers <span class="sc">*</span> (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts) , <span class="fu">c</span>(nRivers, nRivers, (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts ))</span>
<span id="cb189-29"><a href="models.html#cb189-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nRivers){</span>
<span id="cb189-30"><a href="models.html#cb189-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb189-31"><a href="models.html#cb189-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb189-32"><a href="models.html#cb189-32" aria-hidden="true" tabindex="-1"></a>          dirch <span class="ot">&lt;-</span> <span class="fu">rdirch</span>(<span class="dv">1</span>, alpha)</span>
<span id="cb189-33"><a href="models.html#cb189-33" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (r2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nRivers){</span>
<span id="cb189-34"><a href="models.html#cb189-34" aria-hidden="true" tabindex="-1"></a>            a[r,r2,t,c] <span class="ot">&lt;-</span> dirch[r2]</span>
<span id="cb189-35"><a href="models.html#cb189-35" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb189-36"><a href="models.html#cb189-36" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb189-37"><a href="models.html#cb189-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-38"><a href="models.html#cb189-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb189-39"><a href="models.html#cb189-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(a)</span>
<span id="cb189-40"><a href="models.html#cb189-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-41"><a href="models.html#cb189-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-42"><a href="models.html#cb189-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors for psi where more likely to stay than move</span></span>
<span id="cb189-43"><a href="models.html#cb189-43" aria-hidden="true" tabindex="-1"></a>  alphaR <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb189-44"><a href="models.html#cb189-44" aria-hidden="true" tabindex="-1"></a>  alphaR[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> alphaR1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.7</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>)</span>
<span id="cb189-45"><a href="models.html#cb189-45" aria-hidden="true" tabindex="-1"></a>  alphaR[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> alphaR2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>)</span>
<span id="cb189-46"><a href="models.html#cb189-46" aria-hidden="true" tabindex="-1"></a>  alphaR[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> alphaR3 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.7</span>, <span class="fl">0.1</span>)</span>
<span id="cb189-47"><a href="models.html#cb189-47" aria-hidden="true" tabindex="-1"></a>  alphaR[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> alphaR4 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.7</span>)</span>
<span id="cb189-48"><a href="models.html#cb189-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-49"><a href="models.html#cb189-49" aria-hidden="true" tabindex="-1"></a>  getDirchPriorsR <span class="ot">&lt;-</span> <span class="cf">function</span>(nRivers,myConstants, nCohorts, alpha){</span>
<span id="cb189-50"><a href="models.html#cb189-50" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">=</span> <span class="fu">array</span>(<span class="fu">rep</span>(<span class="dv">0</span>, nRivers <span class="sc">*</span> nRivers <span class="sc">*</span> (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts) , <span class="fu">c</span>(nRivers, nRivers, (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts ))</span>
<span id="cb189-51"><a href="models.html#cb189-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nRivers){</span>
<span id="cb189-52"><a href="models.html#cb189-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>)){</span>
<span id="cb189-53"><a href="models.html#cb189-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb189-54"><a href="models.html#cb189-54" aria-hidden="true" tabindex="-1"></a>          dirch <span class="ot">&lt;-</span> <span class="fu">rdirch</span>(<span class="dv">1</span>, alphaR[[r]])</span>
<span id="cb189-55"><a href="models.html#cb189-55" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (r2 <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nRivers){</span>
<span id="cb189-56"><a href="models.html#cb189-56" aria-hidden="true" tabindex="-1"></a>            a[r,r2,t,c] <span class="ot">&lt;-</span> dirch[r2]</span>
<span id="cb189-57"><a href="models.html#cb189-57" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb189-58"><a href="models.html#cb189-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb189-59"><a href="models.html#cb189-59" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-60"><a href="models.html#cb189-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb189-61"><a href="models.html#cb189-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(a)</span>
<span id="cb189-62"><a href="models.html#cb189-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-63"><a href="models.html#cb189-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-64"><a href="models.html#cb189-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">#psi = getDirchPriorsR(nRivers, myConstants, nCohorts, alpha)</span></span>
<span id="cb189-65"><a href="models.html#cb189-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-66"><a href="models.html#cb189-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  For 3 states, we are using 4</span></span>
<span id="cb189-67"><a href="models.html#cb189-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb189-68"><a href="models.html#cb189-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters for 3 sites (A, B, C):</span></span>
<span id="cb189-69"><a href="models.html#cb189-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># phiA: survival probability site A</span></span>
<span id="cb189-70"><a href="models.html#cb189-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># phiB: survival probability site B</span></span>
<span id="cb189-71"><a href="models.html#cb189-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># phiC: survival probability site B</span></span>
<span id="cb189-72"><a href="models.html#cb189-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiAA: movement probability from site A to site A (reference)</span></span>
<span id="cb189-73"><a href="models.html#cb189-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiAB = psiA[1]: movement probability from site A to site B</span></span>
<span id="cb189-74"><a href="models.html#cb189-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiAC = psiA[2]: movement probability from site A to site C </span></span>
<span id="cb189-75"><a href="models.html#cb189-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiBA = psiB[1]: movement probability from site B to site A</span></span>
<span id="cb189-76"><a href="models.html#cb189-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiBB: movement probability from site B to site B (reference)</span></span>
<span id="cb189-77"><a href="models.html#cb189-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiBC = psiB[2]: movement probability from site B to site C</span></span>
<span id="cb189-78"><a href="models.html#cb189-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiCA = psiC[1]: movement probability from site C to site A</span></span>
<span id="cb189-79"><a href="models.html#cb189-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiCB = psiC[2]: movement probability from site C to site B</span></span>
<span id="cb189-80"><a href="models.html#cb189-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># psiCC: movement probability from site C to site C (reference)</span></span>
<span id="cb189-81"><a href="models.html#cb189-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pA: recapture probability site A</span></span>
<span id="cb189-82"><a href="models.html#cb189-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pB: recapture probability site B</span></span>
<span id="cb189-83"><a href="models.html#cb189-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pC: recapture probability site C</span></span>
<span id="cb189-84"><a href="models.html#cb189-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb189-85"><a href="models.html#cb189-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># States (z):</span></span>
<span id="cb189-86"><a href="models.html#cb189-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1 alive at A</span></span>
<span id="cb189-87"><a href="models.html#cb189-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2 alive at B</span></span>
<span id="cb189-88"><a href="models.html#cb189-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3 alive at C</span></span>
<span id="cb189-89"><a href="models.html#cb189-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4 alive at D</span></span>
<span id="cb189-90"><a href="models.html#cb189-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5 dead</span></span>
<span id="cb189-91"><a href="models.html#cb189-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observations (y):  </span></span>
<span id="cb189-92"><a href="models.html#cb189-92" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1 not seen</span></span>
<span id="cb189-93"><a href="models.html#cb189-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2 seen at A </span></span>
<span id="cb189-94"><a href="models.html#cb189-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3 seen at B</span></span>
<span id="cb189-95"><a href="models.html#cb189-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4 seen at C</span></span>
<span id="cb189-96"><a href="models.html#cb189-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5 seen at D</span></span>
<span id="cb189-97"><a href="models.html#cb189-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># river names: c(&quot;west brook&quot; = 1, &quot;wb jimmy&quot; = 2, &quot;wb mitchell&quot; = 3, &quot;wb obear&quot; = 4)</span></span>
<span id="cb189-98"><a href="models.html#cb189-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># -------------------------------------------------</span></span>
<span id="cb189-99"><a href="models.html#cb189-99" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-100"><a href="models.html#cb189-100" aria-hidden="true" tabindex="-1"></a>  <span class="do">## model code using DHMMo distribution</span></span>
<span id="cb189-101"><a href="models.html#cb189-101" aria-hidden="true" tabindex="-1"></a>  hmm.phiT_pT_psiT_DHMM_dirch <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb189-102"><a href="models.html#cb189-102" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Initial distribution among rivers</span></span>
<span id="cb189-103"><a href="models.html#cb189-103" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">1</span>] <span class="ot">&lt;-</span> deltaProps[<span class="dv">1</span>]                  <span class="co"># Pr(alive t = 1 and in river 1) = 0.4</span></span>
<span id="cb189-104"><a href="models.html#cb189-104" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">2</span>] <span class="ot">&lt;-</span> deltaProps[<span class="dv">2</span>]</span>
<span id="cb189-105"><a href="models.html#cb189-105" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">3</span>] <span class="ot">&lt;-</span> deltaProps[<span class="dv">3</span>]</span>
<span id="cb189-106"><a href="models.html#cb189-106" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">4</span>] <span class="ot">&lt;-</span> deltaProps[<span class="dv">4</span>]</span>
<span id="cb189-107"><a href="models.html#cb189-107" aria-hidden="true" tabindex="-1"></a>      delta[<span class="dv">5</span>] <span class="ot">&lt;-</span> <span class="dv">0</span>                    <span class="co"># Pr(dead t = 1) = 0</span></span>
<span id="cb189-108"><a href="models.html#cb189-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-109"><a href="models.html#cb189-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nRivers){</span>
<span id="cb189-110"><a href="models.html#cb189-110" aria-hidden="true" tabindex="-1"></a>          betaPhiRiver[r] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb189-111"><a href="models.html#cb189-111" aria-hidden="true" tabindex="-1"></a>          betaPRiver[r] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb189-112"><a href="models.html#cb189-112" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb189-113"><a href="models.html#cb189-113" aria-hidden="true" tabindex="-1"></a>          betaPhiRiverOut[r] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhiRiver[r])</span>
<span id="cb189-114"><a href="models.html#cb189-114" aria-hidden="true" tabindex="-1"></a>          betaPRiverOut[r] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPRiver[r])</span>
<span id="cb189-115"><a href="models.html#cb189-115" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb189-116"><a href="models.html#cb189-116" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb189-117"><a href="models.html#cb189-117" aria-hidden="true" tabindex="-1"></a>              betaPhiRiverCohort[r,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiRiver[r], <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb189-118"><a href="models.html#cb189-118" aria-hidden="true" tabindex="-1"></a>              betaPRiverCohort[r,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPRiver[r], <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb189-119"><a href="models.html#cb189-119" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb189-120"><a href="models.html#cb189-120" aria-hidden="true" tabindex="-1"></a>              betaPhiRiverCohortOut[r,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhiRiverCohort[r,c])</span>
<span id="cb189-121"><a href="models.html#cb189-121" aria-hidden="true" tabindex="-1"></a>              betaPRiverCohortOut[r,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPRiverCohort[r,c])</span>
<span id="cb189-122"><a href="models.html#cb189-122" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){</span>
<span id="cb189-123"><a href="models.html#cb189-123" aria-hidden="true" tabindex="-1"></a>                  betaPhi[r,t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPhiRiverCohort[r,c], <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb189-124"><a href="models.html#cb189-124" aria-hidden="true" tabindex="-1"></a>                  betaP[r,t,c] <span class="sc">~</span> <span class="fu">dnorm</span>(betaPRiverCohort[r,c], <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb189-125"><a href="models.html#cb189-125" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb189-126"><a href="models.html#cb189-126" aria-hidden="true" tabindex="-1"></a>                  betaPhiOut[r,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[r,t,c])</span>
<span id="cb189-127"><a href="models.html#cb189-127" aria-hidden="true" tabindex="-1"></a>                  betaPOut[r,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaP[r,t,c])</span>
<span id="cb189-128"><a href="models.html#cb189-128" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb189-129"><a href="models.html#cb189-129" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># move from river &#39;r&#39; to one of river 1:nRivers</span></span>
<span id="cb189-130"><a href="models.html#cb189-130" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># Nice description of effect of &#39;alpha&#39; on probabilities:</span></span>
<span id="cb189-131"><a href="models.html#cb189-131" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># https://stats.stackexchange.com/questions/244917/what-exactly-is-the-alpha-in-the-dirichlet-distribution</span></span>
<span id="cb189-132"><a href="models.html#cb189-132" aria-hidden="true" tabindex="-1"></a>                  <span class="co">#psi[r,1:nRivers,t,c] ~ ddirch(alpha[[r]][1:nRivers])</span></span>
<span id="cb189-133"><a href="models.html#cb189-133" aria-hidden="true" tabindex="-1"></a>              }</span>
<span id="cb189-134"><a href="models.html#cb189-134" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb189-135"><a href="models.html#cb189-135" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-136"><a href="models.html#cb189-136" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb189-137"><a href="models.html#cb189-137" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb189-138"><a href="models.html#cb189-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb189-139"><a href="models.html#cb189-139" aria-hidden="true" tabindex="-1"></a>          psi[<span class="dv">1</span>,<span class="dv">1</span><span class="sc">:</span>nRivers,t,c] <span class="sc">~</span> <span class="fu">ddirch</span>(alphaR1[<span class="dv">1</span><span class="sc">:</span>nRivers])</span>
<span id="cb189-140"><a href="models.html#cb189-140" aria-hidden="true" tabindex="-1"></a>          psi[<span class="dv">2</span>,<span class="dv">1</span><span class="sc">:</span>nRivers,t,c] <span class="sc">~</span> <span class="fu">ddirch</span>(alphaR2[<span class="dv">1</span><span class="sc">:</span>nRivers])</span>
<span id="cb189-141"><a href="models.html#cb189-141" aria-hidden="true" tabindex="-1"></a>          psi[<span class="dv">3</span>,<span class="dv">1</span><span class="sc">:</span>nRivers,t,c] <span class="sc">~</span> <span class="fu">ddirch</span>(alphaR3[<span class="dv">1</span><span class="sc">:</span>nRivers])</span>
<span id="cb189-142"><a href="models.html#cb189-142" aria-hidden="true" tabindex="-1"></a>          psi[<span class="dv">4</span>,<span class="dv">1</span><span class="sc">:</span>nRivers,t,c] <span class="sc">~</span> <span class="fu">ddirch</span>(alphaR4[<span class="dv">1</span><span class="sc">:</span>nRivers])</span>
<span id="cb189-143"><a href="models.html#cb189-143" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb189-144"><a href="models.html#cb189-144" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-145"><a href="models.html#cb189-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-146"><a href="models.html#cb189-146" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)){ <span class="co"># loop over time</span></span>
<span id="cb189-147"><a href="models.html#cb189-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb189-148"><a href="models.html#cb189-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-149"><a href="models.html#cb189-149" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">1</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">1</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">1</span>,<span class="dv">1</span>,t,c]</span>
<span id="cb189-150"><a href="models.html#cb189-150" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">2</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">1</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">1</span>,<span class="dv">2</span>,t,c]</span>
<span id="cb189-151"><a href="models.html#cb189-151" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">3</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">1</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">1</span>,<span class="dv">3</span>,t,c]</span>
<span id="cb189-152"><a href="models.html#cb189-152" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">4</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">1</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">1</span>,<span class="dv">4</span>,t,c]</span>
<span id="cb189-153"><a href="models.html#cb189-153" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">1</span>,<span class="dv">5</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">1</span>,t,c])</span>
<span id="cb189-154"><a href="models.html#cb189-154" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">1</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">2</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">2</span>,<span class="dv">1</span>,t,c]</span>
<span id="cb189-155"><a href="models.html#cb189-155" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">2</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">2</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">2</span>,<span class="dv">2</span>,t,c]</span>
<span id="cb189-156"><a href="models.html#cb189-156" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">3</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">2</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">2</span>,<span class="dv">3</span>,t,c]</span>
<span id="cb189-157"><a href="models.html#cb189-157" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">4</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">2</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">2</span>,<span class="dv">4</span>,t,c]</span>
<span id="cb189-158"><a href="models.html#cb189-158" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">2</span>,<span class="dv">5</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">2</span>,t,c])</span>
<span id="cb189-159"><a href="models.html#cb189-159" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">3</span>,<span class="dv">1</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">3</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">3</span>,<span class="dv">1</span>,t,c]</span>
<span id="cb189-160"><a href="models.html#cb189-160" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">3</span>,<span class="dv">2</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">3</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">3</span>,<span class="dv">2</span>,t,c]</span>
<span id="cb189-161"><a href="models.html#cb189-161" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">3</span>,<span class="dv">3</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">3</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">3</span>,<span class="dv">3</span>,t,c]</span>
<span id="cb189-162"><a href="models.html#cb189-162" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">3</span>,<span class="dv">4</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">3</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">3</span>,<span class="dv">4</span>,t,c]</span>
<span id="cb189-163"><a href="models.html#cb189-163" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">3</span>,<span class="dv">5</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">3</span>,t,c])</span>
<span id="cb189-164"><a href="models.html#cb189-164" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">4</span>,<span class="dv">1</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">4</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">4</span>,<span class="dv">1</span>,t,c]</span>
<span id="cb189-165"><a href="models.html#cb189-165" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">4</span>,<span class="dv">2</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">4</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">4</span>,<span class="dv">2</span>,t,c]</span>
<span id="cb189-166"><a href="models.html#cb189-166" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">4</span>,<span class="dv">3</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">4</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">4</span>,<span class="dv">3</span>,t,c]</span>
<span id="cb189-167"><a href="models.html#cb189-167" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">4</span>,<span class="dv">4</span>,t,c] <span class="ot">&lt;-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">4</span>,t,c]) <span class="sc">*</span> psi[<span class="dv">4</span>,<span class="dv">4</span>,t,c]</span>
<span id="cb189-168"><a href="models.html#cb189-168" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">4</span>,<span class="dv">5</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">ilogit</span>(betaPhi[<span class="dv">4</span>,t,c])</span>
<span id="cb189-169"><a href="models.html#cb189-169" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">5</span>,<span class="dv">1</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb189-170"><a href="models.html#cb189-170" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">5</span>,<span class="dv">2</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb189-171"><a href="models.html#cb189-171" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">5</span>,<span class="dv">3</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb189-172"><a href="models.html#cb189-172" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">5</span>,<span class="dv">4</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb189-173"><a href="models.html#cb189-173" aria-hidden="true" tabindex="-1"></a>          gamma[<span class="dv">5</span>,<span class="dv">5</span>,t,c] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb189-174"><a href="models.html#cb189-174" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb189-175"><a href="models.html#cb189-175" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-176"><a href="models.html#cb189-176" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb189-177"><a href="models.html#cb189-177" aria-hidden="true" tabindex="-1"></a>      <span class="co"># gamma for the last occasion  </span></span>
<span id="cb189-178"><a href="models.html#cb189-178" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (c <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nCohorts){</span>
<span id="cb189-179"><a href="models.html#cb189-179" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(nRivers<span class="sc">+</span><span class="dv">1</span>)){</span>
<span id="cb189-180"><a href="models.html#cb189-180" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nRivers){</span>
<span id="cb189-181"><a href="models.html#cb189-181" aria-hidden="true" tabindex="-1"></a>                  gamma[a,b,T,c] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb189-182"><a href="models.html#cb189-182" aria-hidden="true" tabindex="-1"></a>              }  </span>
<span id="cb189-183"><a href="models.html#cb189-183" aria-hidden="true" tabindex="-1"></a>              gamma[a,<span class="dv">5</span>,T,c] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb189-184"><a href="models.html#cb189-184" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb189-185"><a href="models.html#cb189-185" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-186"><a href="models.html#cb189-186" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb189-187"><a href="models.html#cb189-187" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb189-188"><a href="models.html#cb189-188" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){ <span class="co"># loop over individuals</span></span>
<span id="cb189-189"><a href="models.html#cb189-189" aria-hidden="true" tabindex="-1"></a>          <span class="co"># omega for first obs      </span></span>
<span id="cb189-190"><a href="models.html#cb189-190" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive A t -&gt; non-detected t)</span></span>
<span id="cb189-191"><a href="models.html#cb189-191" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive A t -&gt; detected A t)</span></span>
<span id="cb189-192"><a href="models.html#cb189-192" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">3</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive A t -&gt; detected B t)</span></span>
<span id="cb189-193"><a href="models.html#cb189-193" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">4</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive A t -&gt; detected C t)</span></span>
<span id="cb189-194"><a href="models.html#cb189-194" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">1</span>,<span class="dv">5</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive A t -&gt; detected D t)</span></span>
<span id="cb189-195"><a href="models.html#cb189-195" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive B t -&gt; non-detected t)</span></span>
<span id="cb189-196"><a href="models.html#cb189-196" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive B t -&gt; detected A t)</span></span>
<span id="cb189-197"><a href="models.html#cb189-197" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">3</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive B t -&gt; detected B t)</span></span>
<span id="cb189-198"><a href="models.html#cb189-198" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">4</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive B t -&gt; detected C t)</span></span>
<span id="cb189-199"><a href="models.html#cb189-199" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">2</span>,<span class="dv">5</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive B t -&gt; detected C t)</span></span>
<span id="cb189-200"><a href="models.html#cb189-200" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">3</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive C t -&gt; non-detected t)</span></span>
<span id="cb189-201"><a href="models.html#cb189-201" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">3</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive C t -&gt; detected A t)</span></span>
<span id="cb189-202"><a href="models.html#cb189-202" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">3</span>,<span class="dv">3</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive C t -&gt; detected B t)</span></span>
<span id="cb189-203"><a href="models.html#cb189-203" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">3</span>,<span class="dv">4</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(alive C t -&gt; detected C t)</span></span>
<span id="cb189-204"><a href="models.html#cb189-204" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">3</span>,<span class="dv">5</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(alive C t -&gt; detected C t)</span></span>
<span id="cb189-205"><a href="models.html#cb189-205" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">4</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb189-206"><a href="models.html#cb189-206" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">4</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected A t)</span></span>
<span id="cb189-207"><a href="models.html#cb189-207" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">4</span>,<span class="dv">3</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected B t)</span></span>
<span id="cb189-208"><a href="models.html#cb189-208" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">4</span>,<span class="dv">4</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected C t)</span></span>
<span id="cb189-209"><a href="models.html#cb189-209" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">4</span>,<span class="dv">5</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(dead t -&gt; detected C t)</span></span>
<span id="cb189-210"><a href="models.html#cb189-210" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">5</span>,<span class="dv">1</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">1</span>          <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb189-211"><a href="models.html#cb189-211" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">5</span>,<span class="dv">2</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected A t)</span></span>
<span id="cb189-212"><a href="models.html#cb189-212" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">5</span>,<span class="dv">3</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected B t)</span></span>
<span id="cb189-213"><a href="models.html#cb189-213" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">5</span>,<span class="dv">4</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected C t)</span></span>
<span id="cb189-214"><a href="models.html#cb189-214" aria-hidden="true" tabindex="-1"></a>          omega[<span class="dv">5</span>,<span class="dv">5</span>,first[i],i] <span class="ot">&lt;-</span> <span class="dv">0</span>          <span class="co"># Pr(dead t -&gt; detected D t)</span></span>
<span id="cb189-215"><a href="models.html#cb189-215" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb189-216"><a href="models.html#cb189-216" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb189-217"><a href="models.html#cb189-217" aria-hidden="true" tabindex="-1"></a>          <span class="do">## DT changes:</span></span>
<span id="cb189-218"><a href="models.html#cb189-218" aria-hidden="true" tabindex="-1"></a>          <span class="do">## time t &gt; first[i]:</span></span>
<span id="cb189-219"><a href="models.html#cb189-219" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span>(t <span class="cf">in</span> (first[i]<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>last[i]) {</span>
<span id="cb189-220"><a href="models.html#cb189-220" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(pA[t,i]) <span class="ot">&lt;-</span> betaP[<span class="dv">1</span>,t<span class="dv">-1</span>,cohort[i]]</span>
<span id="cb189-221"><a href="models.html#cb189-221" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(pB[t,i]) <span class="ot">&lt;-</span> betaP[<span class="dv">2</span>,t<span class="dv">-1</span>,cohort[i]]</span>
<span id="cb189-222"><a href="models.html#cb189-222" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(pC[t,i]) <span class="ot">&lt;-</span> betaP[<span class="dv">3</span>,t<span class="dv">-1</span>,cohort[i]]</span>
<span id="cb189-223"><a href="models.html#cb189-223" aria-hidden="true" tabindex="-1"></a>              <span class="fu">logit</span>(pD[t,i]) <span class="ot">&lt;-</span> betaP[<span class="dv">4</span>,t<span class="dv">-1</span>,cohort[i]]</span>
<span id="cb189-224"><a href="models.html#cb189-224" aria-hidden="true" tabindex="-1"></a>             </span>
<span id="cb189-225"><a href="models.html#cb189-225" aria-hidden="true" tabindex="-1"></a>              <span class="co"># probabilities of y(t) given z(t)</span></span>
<span id="cb189-226"><a href="models.html#cb189-226" aria-hidden="true" tabindex="-1"></a>              <span class="co"># omega[z, y, t, i]</span></span>
<span id="cb189-227"><a href="models.html#cb189-227" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb189-228"><a href="models.html#cb189-228" aria-hidden="true" tabindex="-1"></a>              <span class="co"># z=1 = alive in River 1, z=2 = alive in River 2...z=5 = dead</span></span>
<span id="cb189-229"><a href="models.html#cb189-229" aria-hidden="true" tabindex="-1"></a>              <span class="co"># y=1 = unobserved, y=2 = observed in River 1, y=3 = observed in River 2, etc</span></span>
<span id="cb189-230"><a href="models.html#cb189-230" aria-hidden="true" tabindex="-1"></a>              </span>
<span id="cb189-231"><a href="models.html#cb189-231" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pA[t,i]     <span class="co"># Pr(alive A t -&gt; non-detected t)</span></span>
<span id="cb189-232"><a href="models.html#cb189-232" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> pA[t,i]         <span class="co"># Pr(alive A t -&gt; detected A t)</span></span>
<span id="cb189-233"><a href="models.html#cb189-233" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">3</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive A t -&gt; detected B t)</span></span>
<span id="cb189-234"><a href="models.html#cb189-234" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">4</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive A t -&gt; detected C t)</span></span>
<span id="cb189-235"><a href="models.html#cb189-235" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">1</span>,<span class="dv">5</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive A t -&gt; detected D t)</span></span>
<span id="cb189-236"><a href="models.html#cb189-236" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pB[t,i]     <span class="co"># Pr(alive B t -&gt; non-detected t)</span></span>
<span id="cb189-237"><a href="models.html#cb189-237" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive B t -&gt; detected A t)</span></span>
<span id="cb189-238"><a href="models.html#cb189-238" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">3</span>,t,i] <span class="ot">&lt;-</span> pB[t,i]         <span class="co"># Pr(alive B t -&gt; detected B t)</span></span>
<span id="cb189-239"><a href="models.html#cb189-239" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">4</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive B t -&gt; detected C t)</span></span>
<span id="cb189-240"><a href="models.html#cb189-240" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">2</span>,<span class="dv">5</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive B t -&gt; detected C t)</span></span>
<span id="cb189-241"><a href="models.html#cb189-241" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">3</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pC[t,i]     <span class="co"># Pr(alive C t -&gt; non-detected t)</span></span>
<span id="cb189-242"><a href="models.html#cb189-242" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">3</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive C t -&gt; detected A t)</span></span>
<span id="cb189-243"><a href="models.html#cb189-243" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">3</span>,<span class="dv">3</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive C t -&gt; detected B t)</span></span>
<span id="cb189-244"><a href="models.html#cb189-244" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">3</span>,<span class="dv">4</span>,t,i] <span class="ot">&lt;-</span> pC[t,i]         <span class="co"># Pr(alive C t -&gt; detected C t)</span></span>
<span id="cb189-245"><a href="models.html#cb189-245" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">3</span>,<span class="dv">5</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(alive C t -&gt; detected C t)</span></span>
<span id="cb189-246"><a href="models.html#cb189-246" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">4</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> pD[t,i]     <span class="co"># Pr(alive D t -&gt; non-detected t))</span></span>
<span id="cb189-247"><a href="models.html#cb189-247" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">4</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead D t -&gt; detected A t)</span></span>
<span id="cb189-248"><a href="models.html#cb189-248" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">4</span>,<span class="dv">3</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead D t -&gt; detected B t)</span></span>
<span id="cb189-249"><a href="models.html#cb189-249" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">4</span>,<span class="dv">4</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead D t -&gt; detected C t)</span></span>
<span id="cb189-250"><a href="models.html#cb189-250" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">4</span>,<span class="dv">5</span>,t,i] <span class="ot">&lt;-</span> pD[t,i]         <span class="co"># Pr(alive D t -&gt; detected D t)</span></span>
<span id="cb189-251"><a href="models.html#cb189-251" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">5</span>,<span class="dv">1</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">1</span>               <span class="co"># Pr(dead t -&gt; non-detected t)</span></span>
<span id="cb189-252"><a href="models.html#cb189-252" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">5</span>,<span class="dv">2</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead t -&gt; detected A t)</span></span>
<span id="cb189-253"><a href="models.html#cb189-253" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">5</span>,<span class="dv">3</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead t -&gt; detected B t)</span></span>
<span id="cb189-254"><a href="models.html#cb189-254" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">5</span>,<span class="dv">4</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead t -&gt; detected C t)</span></span>
<span id="cb189-255"><a href="models.html#cb189-255" aria-hidden="true" tabindex="-1"></a>              omega[<span class="dv">5</span>,<span class="dv">5</span>,t,i] <span class="ot">&lt;-</span> <span class="dv">0</span>               <span class="co"># Pr(dead t -&gt; detected D t)</span></span>
<span id="cb189-256"><a href="models.html#cb189-256" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb189-257"><a href="models.html#cb189-257" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb189-258"><a href="models.html#cb189-258" aria-hidden="true" tabindex="-1"></a>      } <span class="co"># i loop</span></span>
<span id="cb189-259"><a href="models.html#cb189-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-260"><a href="models.html#cb189-260" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N){</span>
<span id="cb189-261"><a href="models.html#cb189-261" aria-hidden="true" tabindex="-1"></a>          y[i,first[i]<span class="sc">:</span>last[i]] <span class="sc">~</span> <span class="fu">dDHMMo</span>(<span class="at">init =</span> delta[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb189-262"><a href="models.html#cb189-262" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">probTrans =</span> gamma[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, first[i]<span class="sc">:</span>last[i], cohort[i]],</span>
<span id="cb189-263"><a href="models.html#cb189-263" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">probObs =</span>   omega[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, first[i]<span class="sc">:</span>last[i], i],</span>
<span id="cb189-264"><a href="models.html#cb189-264" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">len =</span> length[i],</span>
<span id="cb189-265"><a href="models.html#cb189-265" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">checkRowSums =</span> <span class="dv">1</span>)</span>
<span id="cb189-266"><a href="models.html#cb189-266" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb189-267"><a href="models.html#cb189-267" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-268"><a href="models.html#cb189-268" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb189-269"><a href="models.html#cb189-269" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-270"><a href="models.html#cb189-270" aria-hidden="true" tabindex="-1"></a>  <span class="do">##</span></span>
<span id="cb189-271"><a href="models.html#cb189-271" aria-hidden="true" tabindex="-1"></a>  myConstants0 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> <span class="fu">nrow</span>(y),</span>
<span id="cb189-272"><a href="models.html#cb189-272" aria-hidden="true" tabindex="-1"></a>                       <span class="at">T =</span> <span class="fu">ncol</span>(y),</span>
<span id="cb189-273"><a href="models.html#cb189-273" aria-hidden="true" tabindex="-1"></a>                       <span class="at">first =</span> first,</span>
<span id="cb189-274"><a href="models.html#cb189-274" aria-hidden="true" tabindex="-1"></a>                       <span class="at">last =</span> last,</span>
<span id="cb189-275"><a href="models.html#cb189-275" aria-hidden="true" tabindex="-1"></a>                       <span class="at">cohort =</span> cohort,</span>
<span id="cb189-276"><a href="models.html#cb189-276" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb189-277"><a href="models.html#cb189-277" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nRivers =</span> nRivers,</span>
<span id="cb189-278"><a href="models.html#cb189-278" aria-hidden="true" tabindex="-1"></a>                       <span class="at">season =</span> seasonArray,</span>
<span id="cb189-279"><a href="models.html#cb189-279" aria-hidden="true" tabindex="-1"></a>                       <span class="co">#                     flow = eh$flow,</span></span>
<span id="cb189-280"><a href="models.html#cb189-280" aria-hidden="true" tabindex="-1"></a>                       <span class="at">length =</span> last <span class="sc">-</span> first <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb189-281"><a href="models.html#cb189-281" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha =</span> alpha,</span>
<span id="cb189-282"><a href="models.html#cb189-282" aria-hidden="true" tabindex="-1"></a>                       <span class="at">deltaProps =</span> deltaProps</span>
<span id="cb189-283"><a href="models.html#cb189-283" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb189-284"><a href="models.html#cb189-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-285"><a href="models.html#cb189-285" aria-hidden="true" tabindex="-1"></a>  <span class="do">## DT changes:</span></span>
<span id="cb189-286"><a href="models.html#cb189-286" aria-hidden="true" tabindex="-1"></a>  myData0 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="do">###yCJS = eh$eh, #y,    ## data for CJS distribution</span></span>
<span id="cb189-287"><a href="models.html#cb189-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> y <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb189-288"><a href="models.html#cb189-288" aria-hidden="true" tabindex="-1"></a>  )   <span class="do">## data for DHMM distribution</span></span>
<span id="cb189-289"><a href="models.html#cb189-289" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-290"><a href="models.html#cb189-290" aria-hidden="true" tabindex="-1"></a>    <span class="do">## if you change this FALSE to TRUE</span></span>
<span id="cb189-291"><a href="models.html#cb189-291" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this makes the dataset smaller - only 200 observations,</span></span>
<span id="cb189-292"><a href="models.html#cb189-292" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for quicker testing</span></span>
<span id="cb189-293"><a href="models.html#cb189-293" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">FALSE</span>) {</span>
<span id="cb189-294"><a href="models.html#cb189-294" aria-hidden="true" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb189-295"><a href="models.html#cb189-295" aria-hidden="true" tabindex="-1"></a>      oldN <span class="ot">&lt;-</span> <span class="fu">dim</span>(y)[<span class="dv">1</span>]</span>
<span id="cb189-296"><a href="models.html#cb189-296" aria-hidden="true" tabindex="-1"></a>      <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb189-297"><a href="models.html#cb189-297" aria-hidden="true" tabindex="-1"></a>      indToKeep <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>oldN, <span class="at">size =</span> newN, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb189-298"><a href="models.html#cb189-298" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-299"><a href="models.html#cb189-299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-300"><a href="models.html#cb189-300" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this removes fish that were only observed on the very last observation</span></span>
<span id="cb189-301"><a href="models.html#cb189-301" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="cn">TRUE</span>) {</span>
<span id="cb189-302"><a href="models.html#cb189-302" aria-hidden="true" tabindex="-1"></a>      indToKeep <span class="ot">&lt;-</span> <span class="fu">which</span>(first <span class="sc">&lt;</span> <span class="fu">ncol</span>(y))</span>
<span id="cb189-303"><a href="models.html#cb189-303" aria-hidden="true" tabindex="-1"></a>      newN <span class="ot">&lt;-</span> <span class="fu">length</span>(indToKeep)</span>
<span id="cb189-304"><a href="models.html#cb189-304" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-305"><a href="models.html#cb189-305" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-306"><a href="models.html#cb189-306" aria-hidden="true" tabindex="-1"></a>  myConstants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb189-307"><a href="models.html#cb189-307" aria-hidden="true" tabindex="-1"></a>      <span class="at">N =</span> newN,</span>
<span id="cb189-308"><a href="models.html#cb189-308" aria-hidden="true" tabindex="-1"></a>      <span class="at">T =</span> myConstants0<span class="sc">$</span>T,</span>
<span id="cb189-309"><a href="models.html#cb189-309" aria-hidden="true" tabindex="-1"></a>      <span class="at">first =</span> myConstants0<span class="sc">$</span>first[indToKeep],</span>
<span id="cb189-310"><a href="models.html#cb189-310" aria-hidden="true" tabindex="-1"></a>      <span class="at">last =</span> myConstants0<span class="sc">$</span>last[indToKeep],</span>
<span id="cb189-311"><a href="models.html#cb189-311" aria-hidden="true" tabindex="-1"></a>      <span class="at">nRivers =</span> myConstants0<span class="sc">$</span>nRivers,</span>
<span id="cb189-312"><a href="models.html#cb189-312" aria-hidden="true" tabindex="-1"></a>      <span class="at">cohort =</span> myConstants0<span class="sc">$</span>cohort[indToKeep],</span>
<span id="cb189-313"><a href="models.html#cb189-313" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> myConstants0<span class="sc">$</span>nCohorts,</span>
<span id="cb189-314"><a href="models.html#cb189-314" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      season = myConstants$season,</span></span>
<span id="cb189-315"><a href="models.html#cb189-315" aria-hidden="true" tabindex="-1"></a>      <span class="co">#      flow = myConstants$flow[indToKeep,],</span></span>
<span id="cb189-316"><a href="models.html#cb189-316" aria-hidden="true" tabindex="-1"></a>      <span class="at">length =</span> myConstants0<span class="sc">$</span>length[indToKeep],</span>
<span id="cb189-317"><a href="models.html#cb189-317" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> myConstants0<span class="sc">$</span>alpha,</span>
<span id="cb189-318"><a href="models.html#cb189-318" aria-hidden="true" tabindex="-1"></a>      <span class="at">deltaProps =</span> deltaProps</span>
<span id="cb189-319"><a href="models.html#cb189-319" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb189-320"><a href="models.html#cb189-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-321"><a href="models.html#cb189-321" aria-hidden="true" tabindex="-1"></a>  myData <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb189-322"><a href="models.html#cb189-322" aria-hidden="true" tabindex="-1"></a>      <span class="do">##yCJS = myData0$yCJS[indToKeep,],</span></span>
<span id="cb189-323"><a href="models.html#cb189-323" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> myData0<span class="sc">$</span>y[indToKeep,]</span>
<span id="cb189-324"><a href="models.html#cb189-324" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb189-325"><a href="models.html#cb189-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-326"><a href="models.html#cb189-326" aria-hidden="true" tabindex="-1"></a>    initialValues <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb189-327"><a href="models.html#cb189-327" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(</span>
<span id="cb189-328"><a href="models.html#cb189-328" aria-hidden="true" tabindex="-1"></a>          <span class="at">betaPhiRiver =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nRivers, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(nRivers)),</span>
<span id="cb189-329"><a href="models.html#cb189-329" aria-hidden="true" tabindex="-1"></a>          <span class="at">betaPhiRiverCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nRivers <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(nRivers, nCohorts)),</span>
<span id="cb189-330"><a href="models.html#cb189-330" aria-hidden="true" tabindex="-1"></a>          <span class="at">betaPhi =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(nRivers <span class="sc">*</span> (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts , <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(nRivers, (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb189-331"><a href="models.html#cb189-331" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb189-332"><a href="models.html#cb189-332" aria-hidden="true" tabindex="-1"></a>          <span class="at">betaPRiver =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nRivers, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(nRivers)),</span>
<span id="cb189-333"><a href="models.html#cb189-333" aria-hidden="true" tabindex="-1"></a>          <span class="at">betaPRiverCohort =</span> <span class="fu">array</span>(<span class="fu">runif</span>(nRivers <span class="sc">*</span> nCohorts, <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(nRivers, nCohorts)),</span>
<span id="cb189-334"><a href="models.html#cb189-334" aria-hidden="true" tabindex="-1"></a>          <span class="at">betaP =</span> <span class="fu">array</span>(<span class="fu">rnorm</span>(nRivers <span class="sc">*</span> (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> nCohorts , <span class="dv">0</span>, <span class="dv">1</span>), <span class="fu">c</span>(nRivers, (myConstants<span class="sc">$</span>T <span class="sc">-</span> <span class="dv">1</span>), nCohorts)),</span>
<span id="cb189-335"><a href="models.html#cb189-335" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb189-336"><a href="models.html#cb189-336" aria-hidden="true" tabindex="-1"></a>          <span class="at">psi =</span> <span class="fu">getDirchPriorsR</span>(nRivers, myConstants, nCohorts, alphaR)</span>
<span id="cb189-337"><a href="models.html#cb189-337" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb189-338"><a href="models.html#cb189-338" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb189-339"><a href="models.html#cb189-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-340"><a href="models.html#cb189-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb189-341"><a href="models.html#cb189-341" aria-hidden="true" tabindex="-1"></a>  start <span class="ot">=</span> <span class="fu">Sys.time</span>()</span>
<span id="cb189-342"><a href="models.html#cb189-342" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-343"><a href="models.html#cb189-343" aria-hidden="true" tabindex="-1"></a>  <span class="do">## you&#39;ll get warnings that the data &#39;yCJS&#39; is not used, and the &#39;z&#39; initial</span></span>
<span id="cb189-344"><a href="models.html#cb189-344" aria-hidden="true" tabindex="-1"></a>  <span class="do">## values are not in the model.  Those don&#39;t cause any problems,</span></span>
<span id="cb189-345"><a href="models.html#cb189-345" aria-hidden="true" tabindex="-1"></a>  <span class="do">## and let us use the same myData and initialValue() for both models.</span></span>
<span id="cb189-346"><a href="models.html#cb189-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>(</span>
<span id="cb189-347"><a href="models.html#cb189-347" aria-hidden="true" tabindex="-1"></a>      Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb189-348"><a href="models.html#cb189-348" aria-hidden="true" tabindex="-1"></a>          <span class="at">code =</span> hmm.phiT_pT_psiT_DHMM_dirch,</span>
<span id="cb189-349"><a href="models.html#cb189-349" aria-hidden="true" tabindex="-1"></a>          <span class="at">constants =</span> myConstants,</span>
<span id="cb189-350"><a href="models.html#cb189-350" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> myData,              </span>
<span id="cb189-351"><a href="models.html#cb189-351" aria-hidden="true" tabindex="-1"></a>          <span class="at">inits =</span> <span class="fu">initialValues</span>(),</span>
<span id="cb189-352"><a href="models.html#cb189-352" aria-hidden="true" tabindex="-1"></a>          <span class="at">calculate =</span> <span class="cn">FALSE</span></span>
<span id="cb189-353"><a href="models.html#cb189-353" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb189-354"><a href="models.html#cb189-354" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb189-355"><a href="models.html#cb189-355" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-356"><a href="models.html#cb189-356" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Rmodel$calculate()</span></span>
<span id="cb189-357"><a href="models.html#cb189-357" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-358"><a href="models.html#cb189-358" aria-hidden="true" tabindex="-1"></a>  parametersToSave <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;betaPhi&quot;</span>, <span class="st">&quot;betaPhiRiver&quot;</span>, <span class="st">&quot;betaPhiRiverCohort&quot;</span>, </span>
<span id="cb189-359"><a href="models.html#cb189-359" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaP&quot;</span>,   <span class="st">&quot;betaPRiver&quot;</span>,   <span class="st">&quot;betaPRiverCohort&quot;</span>,</span>
<span id="cb189-360"><a href="models.html#cb189-360" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPhiOut&quot;</span>, <span class="st">&quot;betaPhiRiverOut&quot;</span>, <span class="st">&quot;betaPhiRiverCohortOut&quot;</span>, </span>
<span id="cb189-361"><a href="models.html#cb189-361" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;betaPOut&quot;</span>,   <span class="st">&quot;betaPRiverOut&quot;</span>,   <span class="st">&quot;betaPRiverCohortOut&quot;</span>,</span>
<span id="cb189-362"><a href="models.html#cb189-362" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb189-363"><a href="models.html#cb189-363" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;psi&quot;</span></span>
<span id="cb189-364"><a href="models.html#cb189-364" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb189-365"><a href="models.html#cb189-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-366"><a href="models.html#cb189-366" aria-hidden="true" tabindex="-1"></a>  nIter <span class="ot">&lt;-</span> <span class="dv">15000</span> <span class="co">#30000</span></span>
<span id="cb189-367"><a href="models.html#cb189-367" aria-hidden="true" tabindex="-1"></a>  nBurnin <span class="ot">&lt;-</span> <span class="dv">5000</span> <span class="co">#15000</span></span>
<span id="cb189-368"><a href="models.html#cb189-368" aria-hidden="true" tabindex="-1"></a>  nChains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb189-369"><a href="models.html#cb189-369" aria-hidden="true" tabindex="-1"></a>  thinRate <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb189-370"><a href="models.html#cb189-370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-371"><a href="models.html#cb189-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(conf, Rmcmc, Cmodel, Cmcmc) <span class="co"># so old versions don&#39;t run if there is an error in an earlier step</span></span>
<span id="cb189-372"><a href="models.html#cb189-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">system.time</span>(</span>
<span id="cb189-373"><a href="models.html#cb189-373" aria-hidden="true" tabindex="-1"></a>      conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(</span>
<span id="cb189-374"><a href="models.html#cb189-374" aria-hidden="true" tabindex="-1"></a>          Rmodel,</span>
<span id="cb189-375"><a href="models.html#cb189-375" aria-hidden="true" tabindex="-1"></a>          <span class="at">monitors =</span> parametersToSave</span>
<span id="cb189-376"><a href="models.html#cb189-376" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb189-377"><a href="models.html#cb189-377" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb189-378"><a href="models.html#cb189-378" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-379"><a href="models.html#cb189-379" aria-hidden="true" tabindex="-1"></a>  Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf, <span class="at">useConjugacy =</span> <span class="cn">FALSE</span>)</span>
<span id="cb189-380"><a href="models.html#cb189-380" aria-hidden="true" tabindex="-1"></a>  Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel)</span>
<span id="cb189-381"><a href="models.html#cb189-381" aria-hidden="true" tabindex="-1"></a>  Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Rmodel)</span>
<span id="cb189-382"><a href="models.html#cb189-382" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-383"><a href="models.html#cb189-383" aria-hidden="true" tabindex="-1"></a>  mcmc.phiT_pT_psiT_DHMM_dirch <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb189-384"><a href="models.html#cb189-384" aria-hidden="true" tabindex="-1"></a>      Cmcmc, </span>
<span id="cb189-385"><a href="models.html#cb189-385" aria-hidden="true" tabindex="-1"></a>      <span class="at">niter =</span> nIter, </span>
<span id="cb189-386"><a href="models.html#cb189-386" aria-hidden="true" tabindex="-1"></a>      <span class="at">nburnin =</span> nBurnin, </span>
<span id="cb189-387"><a href="models.html#cb189-387" aria-hidden="true" tabindex="-1"></a>      <span class="at">thin =</span> thinRate, </span>
<span id="cb189-388"><a href="models.html#cb189-388" aria-hidden="true" tabindex="-1"></a>      <span class="at">nchains =</span> nChains</span>
<span id="cb189-389"><a href="models.html#cb189-389" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb189-390"><a href="models.html#cb189-390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-391"><a href="models.html#cb189-391" aria-hidden="true" tabindex="-1"></a>  end <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb189-392"><a href="models.html#cb189-392" aria-hidden="true" tabindex="-1"></a>  elapsed_phiT_pT_psiT_DHMM_dirch <span class="ot">&lt;-</span> end <span class="sc">-</span> start</span>
<span id="cb189-393"><a href="models.html#cb189-393" aria-hidden="true" tabindex="-1"></a>  toSave <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb189-394"><a href="models.html#cb189-394" aria-hidden="true" tabindex="-1"></a>      <span class="at">mcmc =</span> mcmc.phiT_pT_psiT_DHMM_dirch, </span>
<span id="cb189-395"><a href="models.html#cb189-395" aria-hidden="true" tabindex="-1"></a>      <span class="at">elapsed =</span> elapsed_phiT_pT_psiT_DHMM_dirch,</span>
<span id="cb189-396"><a href="models.html#cb189-396" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">&quot;phiT_pT_psiT_DHMM_dirch&quot;</span>,</span>
<span id="cb189-397"><a href="models.html#cb189-397" aria-hidden="true" tabindex="-1"></a>      <span class="at">myConstants =</span> myConstants, </span>
<span id="cb189-398"><a href="models.html#cb189-398" aria-hidden="true" tabindex="-1"></a>      <span class="at">nIter =</span> nIter, </span>
<span id="cb189-399"><a href="models.html#cb189-399" aria-hidden="true" tabindex="-1"></a>      <span class="at">nBurnin =</span> nBurnin,</span>
<span id="cb189-400"><a href="models.html#cb189-400" aria-hidden="true" tabindex="-1"></a>      <span class="at">thinRate =</span> thinRate, </span>
<span id="cb189-401"><a href="models.html#cb189-401" aria-hidden="true" tabindex="-1"></a>      <span class="at">nSeasons =</span> nSeasons, </span>
<span id="cb189-402"><a href="models.html#cb189-402" aria-hidden="true" tabindex="-1"></a>      <span class="at">nCohorts =</span> nCohorts,</span>
<span id="cb189-403"><a href="models.html#cb189-403" aria-hidden="true" tabindex="-1"></a>      <span class="at">nChains =</span> nChains</span>
<span id="cb189-404"><a href="models.html#cb189-404" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb189-405"><a href="models.html#cb189-405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-406"><a href="models.html#cb189-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;./models/cmrFlow4rivers/runsOut/mcmc_phiT_pT_psiT_DHMM_dirch_&#39;</span>, <span class="fu">substr</span>(end,<span class="dv">1</span>,<span class="dv">13</span>), <span class="st">&#39;.RData&#39;</span>))</span>
<span id="cb189-407"><a href="models.html#cb189-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">save</span>(toSave, <span class="at">file =</span> <span class="st">&#39;./models/cmrFlow4rivers/runsOut/mcmc_phiT_pT_psiT_DHMM_dirch_mostRecent.RData&#39;</span>)</span>
<span id="cb189-408"><a href="models.html#cb189-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-409"><a href="models.html#cb189-409" aria-hidden="true" tabindex="-1"></a>  <span class="co"># conduct more runs, will need to save into &#39;toSave&#39;   </span></span>
<span id="cb189-410"><a href="models.html#cb189-410" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cmcmc$run(5000, reset = FALSE)  </span></span>
<span id="cb189-411"><a href="models.html#cb189-411" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb189-412"><a href="models.html#cb189-412" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb189-413"><a href="models.html#cb189-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">load</span>(<span class="st">&#39;./models/cmrFlow4rivers/runsOut/mcmc_phiT_pT_psiT_DHMM_dirch_mostRecent.RData&#39;</span>)</span>
<span id="cb189-414"><a href="models.html#cb189-414" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb189-415"><a href="models.html#cb189-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-416"><a href="models.html#cb189-416" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotMCMCOutput) {</span>
<span id="cb189-417"><a href="models.html#cb189-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-418"><a href="models.html#cb189-418" aria-hidden="true" tabindex="-1"></a>  <span class="co">#summary &lt;- MCMCsummary(object = toSave$mcmc, params = c(&quot;betaPhiOut&quot;, &quot;psi&quot;), round = 2)</span></span>
<span id="cb189-419"><a href="models.html#cb189-419" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MCMCplot(object = mcmc.phiT_pT_cohort_flowHier, params = &quot;betaPhiOut&quot;)</span></span>
<span id="cb189-420"><a href="models.html#cb189-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPhiOut&quot;</span>)</span>
<span id="cb189-421"><a href="models.html#cb189-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPhiRiverOut&quot;</span>)<span class="co"># </span></span>
<span id="cb189-422"><a href="models.html#cb189-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiRiverCohortOut&quot;</span>))</span>
<span id="cb189-423"><a href="models.html#cb189-423" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPOut&quot;</span>)</span>
<span id="cb189-424"><a href="models.html#cb189-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="st">&quot;betaPRiverOut&quot;</span>)<span class="co"># </span></span>
<span id="cb189-425"><a href="models.html#cb189-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPRiverCohortOut&quot;</span>))</span>
<span id="cb189-426"><a href="models.html#cb189-426" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb189-427"><a href="models.html#cb189-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCplot</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;psi&quot;</span>))</span>
<span id="cb189-428"><a href="models.html#cb189-428" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-1.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-2.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-3.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-4.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-5.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-6.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-7.png" width="672" /></p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="models.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(plotTraces) {</span>
<span id="cb190-2"><a href="models.html#cb190-2" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(.<span class="dv">1</span>))</span>
<span id="cb190-3"><a href="models.html#cb190-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb190-4"><a href="models.html#cb190-4" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb190-5"><a href="models.html#cb190-5" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb190-6"><a href="models.html#cb190-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiRiverOut&quot;</span>),</span>
<span id="cb190-7"><a href="models.html#cb190-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb190-8"><a href="models.html#cb190-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb190-9"><a href="models.html#cb190-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-10"><a href="models.html#cb190-10" aria-hidden="true" tabindex="-1"></a>  priors <span class="ot">&lt;-</span> <span class="fu">runif</span>(toSave<span class="sc">$</span>nIter <span class="sc">*</span> toSave<span class="sc">$</span>nChains, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb190-11"><a href="models.html#cb190-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">MCMCtrace</span>(<span class="at">object =</span> toSave<span class="sc">$</span>mcmc,</span>
<span id="cb190-12"><a href="models.html#cb190-12" aria-hidden="true" tabindex="-1"></a>            <span class="co">#ISB = FALSE,</span></span>
<span id="cb190-13"><a href="models.html#cb190-13" aria-hidden="true" tabindex="-1"></a>            <span class="co">#exact = TRUE, </span></span>
<span id="cb190-14"><a href="models.html#cb190-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;betaPhiRiverCohortOut&quot;</span>),</span>
<span id="cb190-15"><a href="models.html#cb190-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">pdf =</span> <span class="cn">FALSE</span>, </span>
<span id="cb190-16"><a href="models.html#cb190-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">priors =</span> priors)</span>
<span id="cb190-17"><a href="models.html#cb190-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-18"><a href="models.html#cb190-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># priors &lt;- runif(toSave$nIter * toSave$nChains, 0, 1)</span></span>
<span id="cb190-19"><a href="models.html#cb190-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># MCMCtrace(object = toSave$mcmc,</span></span>
<span id="cb190-20"><a href="models.html#cb190-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           #ISB = FALSE,</span></span>
<span id="cb190-21"><a href="models.html#cb190-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           #exact = TRUE,</span></span>
<span id="cb190-22"><a href="models.html#cb190-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           params = c(&quot;psi&quot;),</span></span>
<span id="cb190-23"><a href="models.html#cb190-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           pdf = FALSE,</span></span>
<span id="cb190-24"><a href="models.html#cb190-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">#           priors = priors)</span></span>
<span id="cb190-25"><a href="models.html#cb190-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-26"><a href="models.html#cb190-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-8.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-9.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-10.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-11.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-12.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-13.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-14.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-15.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-16.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-17.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-18.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-19.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-20.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-21.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-22.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-23.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-24.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-25.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-26.png" width="672" /><img src="westBrook-book_files/figure-html/phiT_pT_psiT_River2_dirch_infPriors-27.png" width="672" /></p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="getData.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="final-words.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["westBrook-book.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
