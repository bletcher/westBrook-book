--- 
title: "The West Brook Story"
author: "Ben Letcher"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography:
- book.bib
- packages.bib
biblio-style: apalike
link-citations: yes
description: This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA
---
--- 
title: "The West Brook Story"
author: "Ben Letcher"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography:
- book.bib
- packages.bib
biblio-style: apalike
link-citations: yes
description: This book describes accessing, cleaning, and analyzing data from the West Brook Study in western MA, USA
---

# Introduction

This book describes accessing, cleaning, and analyzing data from the West Brook Study in Whateley MA, USA.

Use bookdown::render_book() to render the book (not showing up in the 'Build' tab like the bookdown book (https://bookdown.org/yihui/bookdown/usage.html) says it should.


<!--chapter:end:index.Rmd-->

# Get data from the server {#getData}

The server hosting the data is named osensei and is at UMass. It can be accessed using functions in the 'getWBData' package. Use
`devtools::install_github('Conte-Ecology/westBrookData/getWBData')` to install. Most of the functions will run reconnect() to connect to the server with your username and password. Run `reconnect()` from the console to connect if necessary. Use `conDplyr` to see the list of available tables on the server.
```{r libraries, echo = FALSE}
library(getWBData)
library(tidyverse)
library(lubridate)
library(validate)
```

There are three main databases we want to create:    
1. **cdWB_electro0** West Brook electrofishing data, 3 species (brook trout, brown trout and Atlantic salmon), tagged and untagged fish  
2. **cdWB_CMR0** West Brook electrofishing data formatted for Capture-Mark-Recapture analysis for tagged individuals  
3. **cdWB_wanding0** West Brook wanding (portable antenna) data, all tagged salmonids  
4. **cdWB_antenna0** West Brook stationary antenna data, all tagged salmonids  
The `0` at the end of these file names indicates that they are the initial files that will be wrangled in the next step (chapter)
```{r switches}
getNew_cdWB_electro0 <- FALSE
getNew_cdWB_CMR0 <- FALSE
getNew_cdWB_Wanding0 <- FALSE
getNew_cdWB_antenna0 <- FALSE
```

1. West Brook electrofishing data, all salmonids (tagged and untagged)
```{r create or load cdWB_electro0, cache=TRUE}

# default values for createCoreData()
# function (sampleType = "electrofishing", baseColumns = T, 
#    columnsToAdd = NULL, includeUntagged = F, whichDrainage = "west") 

if(getNew_cdWB_electro0) {
  cdWB_electro0 <- createCoreData(
        sampleType = "electrofishing",  #"stationaryAntenna","portableAntenna"
        columnsToAdd = c("sampleNumber",
                         "river",
                         "survey",
                         "pass",
                         "observedLength",
                         "observedWeight",
                         "comments"),
        includeUntagged = TRUE,
        whichDrainage = "west"
      ) %>%
      addTagProperties(
        columnsToAdd = c("cohort",
                         "species",
                         "dateEmigrated",
                         "sex",
                         "species"
        )
      ) %>%
      dplyr::filter(species %in% c( "bkt","bnt","ats"),
                    area %in% c("trib","inside","below","above"),
                    !is.na(sampleNumber)) %>%
      addSampleProperties() %>%
      addEnvironmental()
  
  save(cdWB_electro0, file = './data/cdWB_electro0.RData')
  
} else {
  load(file = './data/cdWB_electro0.RData')
}
str(cdWB_electro0)
```

2. West Brook electrofishing data formatted for Capture-Mark-Recapture analysis for tagged individuals
```{r include=TRUE}

if(getNew_cdWB_CMR0) {
  cdWB_CMR0 <- 
    createCoreData(
      sampleType = "electrofishing", #"stationaryAntenna","portableAntenna"),
      whichDrainage = "west",
      columnsToAdd =
        c("sampleNumber",
          "river",
          "riverMeter",
          "survey",
          "pass",
          'observedLength',
          'observedWeight')
    ) %>%
    addTagProperties(
      columnsToAdd = 
        c("cohort",
          "species",
          "dateEmigrated",
          "sex",
          "species")
      ) %>%
    dplyr::filter(!is.na(tag), 
                  area %in% c("trib","inside","below","above"), 
                  !is.na(sampleNumber) 
                  ) %>%
    createCmrData(maxAgeInSamples = 20, 
                  inside = F, 
                  censorDead = F, 
                  censorEmigrated = T) %>%
    addSampleProperties() %>%
    addEnvironmental() %>%
    addKnownZ() %>%
    fillSizeLocation(size = F) #assumes fish stay in same location until observed elsewhere

  save(cdWB_CMR0, file = './data/cdWB_CMR0.RData')
  
} else {
  load(file = './data/cdWB_CMR0.RData')
}
str(cdWB_CMR0)
```

3. West Brook wanding data, all salmonids (tagged)
```{r include = TRUE}

if(getNew_cdWB_Wanding0) {
# from wandingDataWB project in d:/ben/github/wandingData/
  cdWB_Wanding0 <- createCoreData(
    sampleType = "portableAntenna",
    columnsToAdd = c("tag", 
                     "detectionDate", 
                     "river", 
                     "area", 
                     "section", 
                     "survey", 
                     "sampleName", 
                     "readerId", 
                     "aliveOrDead", 
                     "instance", 
                     "pass", 
                     "quarter", 
                     "leftOrRight", 
                     "habitat", 
                     "cover", 
                     "justification", 
                     "comment")
    ) %>% 
    addTagProperties() %>%
    dplyr::filter( species %in% c( "bkt","bnt","ats" ) )
  
    save(cdWB_Wanding0, file = './data/cdWB_Wanding0.RData')
    
  } else {
    load(file = './data/cdWB_Wanding0.RData')
  }
str(cdWB_Wanding0)
```

4. West Brook antenna data, all tagged salmonids
Some pitAntenna code at https://github.com/bletcher/pitAntenna/blob/master/WB/getAndPrepareDataWB.R
```{r stationary antenna}

if(getNew_cdWB_antenna0) {
  cdWB_antenna0 <- createCoreData(
    sampleType=c("stationaryAntenna"), 
    whichDrainage = "west",
    columnsToAdd=c(
      "sampleNumber",
      "river",
      "riverMeter",
      "survey",
      "readerID",
      "comment",
      'observedLength',
      'observedWeight'
      )
  ) %>%  
  filter(!is.na(tag)) %>% # for now
  addTagProperties(columnsToAdd = c(
    "cohort",
    "species",
    "dateEmigrated",
    "sex",
    "species")
  )
  
  save(cdWB_antenna0, file = './data/cdWB_antenna0.RData')
    
} else {
  load(file = './data/cdWB_antenna0.RData')
}

str(cdWB_antenna0)

```


<!--chapter:end:00-getData.Rmd-->


# Wrangle the data {#wrangle}

Placeholder



<!--chapter:end:01-wrangle_cdWB_Data.Rmd-->


# Young-of-year Growth Model {#yoyGrowthModel}

Placeholder



<!--chapter:end:01.5-yoyGrowthModel.Rmd-->

# Introduction {#intro}

You can label chapter and section titles using `{#label}` after them, e.g., we can reference Chapter \@ref(intro). If you do not manually label them, there will be automatic labels anyway, e.g., Chapter \@ref(methods).
test
Figures and tables with captions will be placed in `figure` and `table` environments, respectively.

```{r nice-fig, fig.cap='Here is a nice figure!', out.width='80%', fig.asp=.75, fig.align='center'}
par(mar = c(4, 4, .1, .1))
plot(pressure, type = 'b', pch = 19)
```

Reference a figure by its code chunk label with the `fig:` prefix, e.g., see Figure \@ref(fig:nice-fig). Similarly, you can reference tables generated from `knitr::kable()`, e.g., see Table \@ref(tab:nice-tab).

```{r nice-tab, tidy=FALSE}
knitr::kable(
  head(iris, 20), caption = 'Here is a nice table!',
  booktabs = TRUE
)
```

You can write citations, too. For example, we are using the **bookdown** package [@R-bookdown] in this sample book, which was built on top of R Markdown and **knitr** [@xie2015].

<!--chapter:end:02-intro.Rmd-->

# Literature

Here is a review of existing methods.

<!--chapter:end:03-literature.Rmd-->

# Methods

We describe our methods in this chapter.

<!--chapter:end:04-method.Rmd-->

# Applications

Some _significant_ applications are demonstrated in this chapter.

## Example one

## Example two

<!--chapter:end:05-application.Rmd-->

# Final Words

We have finished a nice book.

<!--chapter:end:06-summary.Rmd-->

`r if (knitr::is_html_output()) '
# References {-}
'`

<!--chapter:end:17-references.Rmd-->

